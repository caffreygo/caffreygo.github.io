# ä»»åŠ¡ç®¡ç†

::: tip å¼‚æ­¥ä»»åŠ¡å¯ä»¥åˆ†æˆä¸¤ç§

1. è¿½åŠ åœ¨æœ¬è½®å¾ªç¯çš„å¼‚æ­¥ä»»åŠ¡
2. è¿½åŠ åœ¨æ¬¡è½®å¾ªç¯çš„å¼‚æ­¥ä»»åŠ¡

::: 

## ä»»åŠ¡é˜Ÿåˆ—

ğŸ“— JavaScript è¯­è¨€çš„ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯**å•çº¿ç¨‹**ï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ªæ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªä»»åŠ¡ã€‚ä¸ºäº†åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€UI æ¸²æŸ“å’Œç½‘ç»œå¤„ç†ç­‰è¡Œä¸ºï¼Œé˜²æ­¢ä¸»çº¿ç¨‹çš„ä¸é˜»å¡ï¼Œï¼ˆäº‹ä»¶å¾ªç¯ï¼‰Event Loopçš„æ–¹æ¡ˆåº”ç”¨è€Œç”Ÿã€‚

::: tip JavaScript å¤„ç†ä»»åŠ¡æ˜¯åœ¨ç­‰å¾…ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡ ã€ä¼‘çœ ç­‰å¾…æ–°ä»»åŠ¡ä¸­ä¸æ–­å¾ªç¯ä¸­ï¼Œä¹Ÿç§°è¿™ç§æœºåˆ¶ä¸ºäº‹ä»¶å¾ªç¯ã€‚

- ä¸»çº¿ç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œæ‰æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- æœ‰æ–°ä»»åŠ¡åˆ°æ¥æ—¶ä¼šå°†å…¶æ”¾å…¥é˜Ÿåˆ—ï¼Œé‡‡å–å…ˆè¿›å…ˆæ‰§è¡Œçš„ç­–ç•¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- æ¯”å¦‚å¤šä¸ª `setTimeout` åŒæ—¶åˆ°æ—¶é—´äº†ï¼Œå°±è¦ä¾æ¬¡æ‰§è¡Œ

:::

ä»»åŠ¡åŒ…æ‹¬ script(æ•´ä½“ä»£ç )ã€ setTimeoutã€setIntervalã€DOMæ¸²æŸ“ã€DOMäº‹ä»¶ã€Promiseã€XMLHTTPREQUESTç­‰

### æ¸²æŸ“ä¸»çº¿ç¨‹

::: tip æµè§ˆå™¨çš„è¿›ç¨‹

æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹çš„ï¼ŒåŒ…æ‹¬äº†ç½‘ç»œè¿›ç¨‹ã€æµè§ˆå™¨è¿›ç¨‹ã€æ¸²æŸ“è¿›ç¨‹ç­‰ç­‰ã€‚

å…¶ä¸­ä¸€ä¸ªæ ‡ç­¾é¡µä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„æ¸²æŸ“è¿›ç¨‹ï¼ˆè¿›ç¨‹éš”ç¦»ï¼‰ï¼Œè¿›ç¨‹å´©æºƒä¸ä¼šäº’ç›¸å½±å“ï¼Œä½†æ˜¯ä¹Ÿä¼šå¯¼è‡´è¿›ç¨‹è¿‡å¤šï¼Œå†…å­˜å ç”¨å¤ªå¤§

> å±•æœ›ï¼šå¤šä¸ªç›¸åŒç«™ç‚¹ä¸‹çš„æ ‡ç­¾é¡µä½¿ç”¨åŒä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹

::: 

âœ… æ¸²æŸ“ä¸»çº¿ç¨‹åœ¨æ¸²æŸ“è¿›ç¨‹ä¸‹ï¼Œä¸»è¦è´Ÿè´£æ‰§è¡Œ HTML CSS JS çš„ä»£ç 

*ä¸ºä»€ä¹ˆæ¸²æŸ“è¿›ç¨‹ä¸ä½¿ç”¨å¤šä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™äº›äº‹æƒ…ï¼šè§£æ HTMLã€è§£æ cssã€è®¡ç®—æ ·å¼ã€å¸ƒå±€ã€å¤„ç†å›¾å½¢ã€æ¯ç§’ç”»é¡µé¢60æ¬¡ã€æ‰§è¡Œå…¨å±€ js ä»£ç ã€æ‰§è¡Œäº‹ä»¶å¤„ç†å‡½æ•°ã€æ‰§è¡Œè®¡æ—¶å™¨çš„å›è°ƒå‡½æ•°...   éš¾ç‚¹ï¼šä»»åŠ¡è°ƒåº¦*

- å¼•æ“æ‰§è¡Œä»»åŠ¡æ—¶æ°¸è¿œä¸ä¼šè¿›è¡Œæ¸²æŸ“ï¼ˆrenderï¼‰ã€‚å¦‚æœä»»åŠ¡æ‰§è¡Œéœ€è¦å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¹Ÿæ²¡å…³ç³»ã€‚ä»…åœ¨ä»»åŠ¡å®Œæˆåæ‰ä¼šç»˜åˆ¶å¯¹ DOM çš„æ›´æ”¹ã€‚
- å¦‚æœä¸€é¡¹ä»»åŠ¡æ‰§è¡ŒèŠ±è´¹çš„æ—¶é—´è¿‡é•¿ï¼Œæµè§ˆå™¨å°†æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä¾‹å¦‚å¤„ç†ç”¨æˆ·äº‹ä»¶ã€‚å› æ­¤ï¼Œåœ¨ä¸€å®šæ—¶é—´åï¼Œæµè§ˆå™¨ä¼šæŠ›å‡ºä¸€ä¸ªå¦‚â€œé¡µé¢æœªå“åº”â€ä¹‹ç±»çš„è­¦æŠ¥ï¼Œå»ºè®®ä½ ç»ˆæ­¢è¿™ä¸ªä»»åŠ¡ã€‚è¿™ç§æƒ…å†µå¸¸å‘ç”Ÿåœ¨æœ‰å¤§é‡å¤æ‚çš„è®¡ç®—æˆ–å¯¼è‡´æ­»å¾ªç¯çš„ç¨‹åºé”™è¯¯æ—¶ã€‚

### äº‹ä»¶å¾ªç¯

1. åœ¨æœ€å¼€å§‹çš„æ—¶å€™ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šè¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯
2. æ¯ä¸€æ¬¡å¾ªç¯ä¼šæ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡å­˜åœ¨ï¼Œå¦‚æœæœ‰ï¼Œå°±å–å‡ºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œæ‰§è¡Œå®Œåè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿›å…¥ä¼‘çœ çŠ¶æ€
3. å…¶ä»–æ‰€æœ‰çº¿ç¨‹ï¼ˆåŒ…æ‹¬å…¶ä»–è¿›ç¨‹çš„çº¿ç¨‹ï¼‰å¯ä»¥éšæ—¶å‘ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ï¼Œæ–°ä»»åŠ¡ä¼šåŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„æœ«å°¾ã€‚åœ¨æ·»åŠ æ–°ä»»åŠ¡æ—¶ï¼Œå¦‚æœä¸»çº¿ç¨‹æ˜¯ä¼‘çœ çŠ¶æ€ï¼Œåˆ™ä¼šå°†å…¶å”¤é†’ä»¥ç»§ç»­å¾ªç¯æ‹¿å–ä»»åŠ¡

âœ… æ•´ä¸ªè¿‡ç¨‹è¢«ç§°ä¹‹äº‹ä»¶å¾ªç¯ => W3Cï¼ˆæ¶ˆæ¯å¾ªç¯ => Chromeï¼‰

### ä½•ä¸ºå¼‚æ­¥

::: tip ä»£ç åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šé‡åˆ°ä¸€äº›æ— æ³•ç«‹å³å¤„ç†çš„ä»»åŠ¡ï¼š

- è®¡æ—¶å®Œæˆåéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ -- `setTimeout` `setInterval`
- ç½‘ç»œé€šä¿¡å®Œæˆåéœ€è¦å®Œæˆçš„ä»»åŠ¡ -- `XHR` `Fetch `
- ç”¨æˆ·æ“ä½œåéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ -- `addEventListener`

::: 

âš¡ï¸ å¦‚æœè®©æ¸²æŸ“ä¸»çº¿ç¨‹ç­‰å¾…è¿™äº›ä»»åŠ¡æ‰§è¡Œæ—¶æœºåˆ°è¾¾ï¼Œå°±ä¼šå¯¼è‡´ä¸»çº¿ç¨‹é•¿æœŸå¤„äº**é˜»å¡**çŠ¶æ€ï¼Œä»è€Œå¯¼è‡´æµè§ˆå™¨**å¡æ­»**ã€‚

âœ… å½“æŸäº›ä»»åŠ¡å‘ç”Ÿæ—¶ï¼Œæ¯”å¦‚è®¡æ—¶å™¨ã€ç½‘ç»œã€äº‹ä»¶ç›‘å¬ï¼Œä¸»çº¿ç¨‹å°†ä»»åŠ¡äº¤ç»™**å…¶ä»–çº¿ç¨‹**å¤„ç†ï¼Œè‡ªèº«ç«‹å³ç»“æŸä»»åŠ¡çš„æ‰§è¡Œï¼Œè½¬è€Œæ‰§è¡Œåç»­ä»£ç ã€‚å½“å…¶ä»–çº¿ç¨‹å®Œæˆæ—¶ï¼Œå°†äº‹å…ˆä¼ é€’çš„å›è°ƒå‡½æ•°åŒ…è£…æˆä»»åŠ¡ï¼ŒåŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—æœ«å°¾æ’é˜Ÿï¼Œç­‰å¾…ä¸»çº¿ç¨‹è°ƒåº¦æ‰§è¡Œã€‚

### ä»»åŠ¡çš„ä¼˜å…ˆçº§

ä»»åŠ¡æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­å…ˆè¿›å…ˆå‡ºã€‚ä½†æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰ä¼˜å…ˆçº§çš„ã€‚

::: tip W3C è§£é‡Š

- æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªä»»åŠ¡ç±»å‹ï¼ŒåŒä¸€ä¸ªç±»å‹çš„ä»»åŠ¡å¿…é¡»åœ¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸åŒç±»å‹çš„ä»»åŠ¡å¯ä»¥åˆ†å±äºä¸åŒçš„é˜Ÿåˆ—ã€‚åœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œæµè§ˆå™¨å¯ä»¥æ ¹æ®å®é™…æƒ…å†µä»ä¸åŒçš„é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚
- æµè§ˆå™¨å¿…é¡»å‡†å¤‡å¥½ä¸€ä¸ªå¾®é˜Ÿåˆ—ï¼Œå¾®é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¼˜å…ˆæ‰€æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œã€‚

:::

> éšç€æµè§ˆå™¨çš„å¤æ‚åº¦æ€¥å‰§æå‡ï¼ŒW3C ä¸å†ä½¿ç”¨å®é˜Ÿåˆ—çš„è¯´æ³•ã€‚

âœ… åœ¨ç›®å‰çš„ chrome çš„å®ç°ä¸­ï¼Œè‡³å°‘åŒ…å«äº†ä¸‹é¢çš„é˜Ÿåˆ—ï¼š

- å¾®é˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾éœ€è¦æœ€å¿«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¼˜å…ˆçº§ **æœ€é«˜**
- äº¤äº’é˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾ç”¨æˆ·æ“ä½œåäº§ç”Ÿçš„äº‹ä»¶å¤„ç†ä»»åŠ¡ï¼Œä¼˜å…ˆçº§ **é«˜**

- å»¶æ—¶é˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾è®¡æ—¶å™¨åˆ°è¾¾åçš„å›è°ƒä»»åŠ¡ï¼Œä¼˜å…ˆçº§ **ä¸­**

### åŸç†åˆ†æ

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯¦ç»†åˆ†æå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

```js
console.log("Jerry");
setTimeout(function() {
    console.log("å®šæ—¶å™¨");
}, 0);
Promise.resolve().then(function() {
    console.log("promise1");
}).then(function() {
    console.log("promise2");
});
console.log("Hello");

#è¾“å‡ºç»“æœä¸º
Jerry
Hello
promise1
promise2
å®šæ—¶å™¨
```

1. å…ˆæ‰§æœ€å‰é¢çš„ scriptï¼Œç„¶åè¾“å‡º

   ```js
   script start
   ```

2. ç„¶åæ‰§è¡Œåˆ°`setTimeout`ï¼Œå¹¶å°†å…¶æ”¾å…¥å»¶æ—¶é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ

3. ä¹‹åæ‰§è¡Œåˆ°`Promise.then`å¾®ä»»åŠ¡ï¼Œå¹¶å°†å…¶æ”¾å…¥å¾®é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ

4. ç„¶åæ‰§è¡Œåˆ°ä¸»ä»£ç è¾“å‡º

   ```js
   script end
   ```

5. ä¸»çº¿ç¨‹æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆ

6. é€šè¿‡äº‹ä»¶å¾ªç¯éå†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå°†åˆšæ‰æ”¾å…¥çš„`Promise.then`å¾®ä»»åŠ¡è¯»å–åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œç„¶åè¾“å‡º

   ```js
   promise1
   ```

7. ä¹‹ååˆæ‰§è¡Œ `promse.then` äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡ï¼Œå¹¶æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—

8. ä¸»çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•

9. ç°æ¬¡äº‹ä»¶å¾ªç¯éå†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè¯»å–åˆ°promise2å¾®ä»»åŠ¡æ”¾å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œç„¶åè¾“å‡º 

   ```js
   promise2
   ```

10. ä¸»çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•

11. æ­¤æ—¶å¾®ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ— ä»»åŠ¡ï¼Œç„¶åä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­è¯»å–åˆ° `setTimeout`ä»»åŠ¡å¹¶åŠ å…¥ä¸»çº¿ç¨‹ï¼Œç„¶åè¾“å‡º

    ```js
    setTimeout
    ```

> ğŸ”– å› ä¸ºå¾®é˜Ÿåˆ—çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå½“å‰äº‹ä»¶å¾ªç¯çš„å¾®ä»»åŠ¡è¦æ¸…ç©ºï¼Œæ‰ä¼šç»“æŸæœ¬è½®å¾ªç¯ï¼Œä¸‹æ¬¡äº‹ä»¶å¾ªç¯å¼€å§‹ã€‚

### è„šæœ¬åŠ è½½

ğŸš¨ å¼•æ“åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä¸ä¼šè¿›è¡ŒDOMæ¸²æŸ“ï¼ˆåŒæ­¥çš„ï¼‰ï¼Œæ‰€ä»¥å¦‚æœæŠŠ`script` å®šä¹‰åœ¨å‰é¢ï¼Œè¦å…ˆæ‰§è¡Œå®Œä»»åŠ¡åå†æ¸²æŸ“DOM

âœ… æ‰€ä»¥å»ºè®®å°†`script` æ”¾åœ¨ BODY ç»“æŸæ ‡ç­¾å‰

### å®šæ—¶å™¨

å®šæ—¶å™¨ä¼šæ”¾å…¥å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¹Ÿéœ€è¦ç­‰å¾…åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡Œã€‚

ä¸‹é¢è®¾ç½®äº† 6 æ¯«ç§’æ‰§è¡Œï¼Œå¦‚æœä¸»çº¿ç¨‹ä»£ç æ‰§è¡Œ10æ¯«ç§’ï¼Œå®šæ—¶å™¨è¦ç­‰ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ‰æ‰§è¡Œã€‚

ğŸ“Œ HTMLæ ‡å‡†è§„å®šæœ€å°æ—¶é—´ä¸èƒ½ä½äº4æ¯«ç§’ï¼Œæœ‰äº›å¼‚æ­¥æ“ä½œå¦‚DOMæ“ä½œæœ€ä½æ˜¯16æ¯«ç§’ï¼Œæ€»ä¹‹æŠŠæ—¶é—´è®¾ç½®å¤§äº›å¯¹æ€§èƒ½æ›´å¥½ã€‚

```js
setTimeout(func,6);
```

ä¸‹é¢çš„ä»£ç ä¼šå…ˆè¾“å‡º `hello` ä¹‹åè¾“å‡º `jerry`

```js
setTimeout(() => {
  console.log("jerry");  // å»¶æ—¶é˜Ÿåˆ—
}, 0);

console.log("hello");
```

> è¿™æ˜¯å¯¹å®šæ—¶å™¨çš„è¯´æ˜ï¼Œå…¶ä»–çš„å¼‚æ­¥æ“ä½œå¦‚äº‹ä»¶ã€XMLHTTPREQUEST ç­‰é€»è¾‘æ˜¯ä¸€æ ·çš„

### å¾®ä»»åŠ¡

ğŸ“Œ å¾®ä»»åŠ¡ä¸€èˆ¬ç”±ç”¨æˆ·ä»£ç äº§ç”Ÿï¼Œå¾®é˜Ÿåˆ—ä¼˜å…ˆçº§æœ€é«˜ï¼Œ`Promise.then`ã€`MutationObserver` 

ğŸ“Œ å®ä¾‹åŒ– Promise æ—¶æ‰§è¡Œçš„ä»£ç æ˜¯åŒæ­¥çš„ï¼Œthenæ³¨å†Œçš„å›è°ƒå‡½æ•°æ˜¯å¼‚æ­¥å¾®ä»»åŠ¡çš„

ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ˜¯åŒæ­¥ä»»åŠ¡ã€å¾®ä»»åŠ¡æ‰€ä»¥ä¸‹é¢æ‰§è¡Œç»“æœæ˜¯ `1ã€2ã€5ã€3ã€4`

```js
setTimeout(() => console.log(4));  // å»¶æ—¶ä»»åŠ¡

Promise.resolve().then(()=> console.log(5))  // å¾®ä»»åŠ¡

new Promise(resolve => {
    resolve();
    console.log(1);  // promiseå£°æ˜ åŒæ­¥ä»»åŠ¡
}).then(() => {
    console.log(3);  // å¾®ä»»åŠ¡
});

console.log(2);  // åŒæ­¥ä»»åŠ¡
```

æˆ‘ä»¬å†æ¥çœ‹ä¸‹é¢ç¨å¤æ‚çš„ä»»åŠ¡ä»£ç 

```js
setTimeout(() => {
    console.log("å®šæ—¶å™¨");  // 4
    setTimeout(() => {
        console.log("timeout timeout");  // 7
    }, 0);
    new Promise(resolve => {
        console.log("settimeout Promise");   // 5
        resolve();
    }).then(() => {
        console.log("settimeout then");  // 6
    });
}, 0);
new Promise(resolve => {
    console.log("Promise");   // 1
    resolve();
}).then(() => {
    console.log("then");  // 3
});
console.log("hello");   // 2
```

ä»¥ä¸Šä»£ç æ‰§è¡Œç»“æœä¸º

```json
Promise
hello
then
å®šæ—¶å™¨
settimeout Promise
settimeout then
timeout timeout
```

## å®ä¾‹åˆ†æ

### è„šæœ¬é˜»å¡æ¸²æŸ“

```html
<h1>Hello world</h1>
<button>change</button>
<script>
    var h1 = document.querySelector("h1");
    var btn = document.querySelector("button");

    function delay(duration) {
        var start = Date.now();
        while (Date.now() - start < duration) {
            console.log(Date.now() - start);
        }
    }

    btn.onclick = function () {
        h1.textContent = new Date();
        delay(3000);
    };
</script>
```

1. åˆå§‹åŠ è½½æ—¶ï¼Œäº¤äº’çº¿ç¨‹ç›‘å¬æŒ‰é’®ç‚¹å‡»ï¼Œç‚¹å‡»åä¼šæ‰§è¡Œ fn
2. ç”¨æˆ·ç‚¹å‡»æ—¶ï¼Œ`fn` åŠ å…¥äº‹ä»¶é˜Ÿåˆ—æ‰§è¡Œ
3. `h1.textContent = new Date()` ï¼Œå†…å®¹ä¿®æ”¹ä¹‹åï¼Œä¼šäº§ç”Ÿä¸€ä¸ªé¡µé¢çš„ç»˜åˆ¶ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—
4. æ­»å¾ªç¯ `3000ms` ï¼Œå¾ªç¯ç»“æŸå³ `fn` å‡½æ•°æ‰§è¡Œç»“æŸ
5. è¿›å…¥ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ç»˜åˆ¶ä»»åŠ¡ï¼Œé¡µé¢æ‰ä¼šå‘ç”Ÿæ”¹å˜

âœ… JS ä¸ºä½•ä¼šé˜»å¡æ¸²æŸ“ï¼šå› ä¸º JS çš„æ‰§è¡Œå’Œé¡µé¢çš„æ¸²æŸ“éƒ½åœ¨æµè§ˆå™¨çš„æ¸²æŸ“ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚

### å¾®é˜Ÿåˆ—

```js
var btn = document.querySelector("button");

function a() {
    console.log(1);
    Promise.resolve().then(function () {
        console.log(2);
    });
}

btn.onclick = function () {
    console.log(0);
};

setTimeout(function () {
    console.log(3);
    Promise.resolve().then(a);
}, 0);

Promise.resolve().then(function () {
    console.log(4);
});

btn.click();  // è¿™æ˜¯åŒæ­¥äº‹ä»¶ï¼

console.log(5);

// 0 5 4 + 3 1 2 ä¸¤è½®äº‹ä»¶å¾ªç¯
```

### è¿›åº¦æ¡

ä¸‹é¢çš„å®šæ—¶å™¨è™½ç„¶éƒ½å®šæ—¶äº†ä¸€ç§’é’Ÿï¼Œä½†ä¹Ÿæ˜¯æŒ‰å…ˆè¿›è¡Œå‡ºåŸåˆ™ï¼Œä¾æ¬¡æ‰§è¡Œ

```js
let i = 0;
setTimeout(() => {
  console.log(++i);  // 1
}, 1000);

setTimeout(() => {
  console.log(++i);  // 2
}, 1000);
```

ä¸‹é¢æ˜¯ä¸€ä¸ªè¿›åº¦æ¡çš„ç¤ºä¾‹ï¼Œå°†æ¯ä¸ªæ•°å­—æ”¾åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­æ‰§è¡Œ

```html
<body>
  <style>
    body {
      padding: 30px;
    }
    #hd {
      height: 30px;
      background: yellowgreen;
      width: 0;
      text-align: center;
      font-weight: bold;
    }
  </style>
  <div id="hd"></div>
</body>

<script>
  function view() {
    let i = 0;
    (function handle() {
      hd.innerHTML = i + "%";
      hd.style.width = i + "%";
      if (i++ < 100) {
        setTimeout(handle, 20);  // æ¯æ¬¡æ‰§è¡Œå®Œä¹‹åï¼Œé€šè¿‡setTimeoutæ·»åŠ ä¸€ä¸ªæ–°çš„å®ä»»åŠ¡ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ‰§è¡Œ
      }
    })();
  }
  view();
  console.log("å®šæ—¶å™¨å¼€å§‹äº†...");
</script>
```

### ä»»åŠ¡åˆ†è§£

ğŸ“Œ ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„ä»»åŠ¡å¯èƒ½é€ æˆæ¸¸è§ˆå™¨å¡æ­»ç°è±¡ï¼Œæ‰€ä»¥å¯ä»¥å°†ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šå°å°å¼‚æ­¥å°ä»»åŠ¡æ‰§è¡Œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ•°å­—ç»Ÿè®¡çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿è¡Œæ—¶é—´ç‰¹åˆ«é•¿

```js
console.time("runtime");
function func() {
    for(let i=0;i<num;i++) {
        count+=num--
    }
    console.log(count);
    console.timeEnd("runtime");
}
let num = 987654321;
let count = 0;
func();
console.log("hello");

// 365797897407398850
// runtime: 3804.149169921875 ms
// hello
```

ç°åœ¨æŠŠä»»åŠ¡åˆ†è§£æˆå°å—æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæµè§ˆå™¨å°±ä¸ä¼šå‡ºç°å¡æ­»çš„ç°è±¡äº†ï¼Œä¹Ÿä¸ä¼šå½±å“åç»­ä»£ç çš„æ‰§è¡Œ

```js
function func() {
    for(let i=0;i<20;i++) {  // è¡¨ç¤ºæ¯20æ¬¡ç´¯åŠ åˆ†è§£ä¸ºä¸€æ¬¡ä»»åŠ¡
        if(num <= 0) break 
        count+=num--
    }
    if (num > 0) {
        console.log("========");  // å¦‚æœç´¯åŠ æœªç»“æŸï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä»»åŠ¡ç»§ç»­ç´¯åŠ 
        setTimeout(func);
    }
    console.log(count);
}
let num = 100;
let count = 0;
func();
console.log("hello");
```

è¾“å‡ºç»“æœæ˜¯

```json
======== 100~81
1810     åˆ›å»ºç¬¬ä¸€æ¬¡å®ä»»åŠ¡
hello
======== 80~61 åˆ›å»ºç¬¬äºŒæ¬¡å®ä»»åŠ¡ 
3220
======== 60~41 åˆ›å»ºç¬¬ä¸‰æ¬¡å®ä»»åŠ¡ 
4230
======== 40~21 åˆ›å»ºç¬¬å››æ¬¡å®ä»»åŠ¡ 
4840     20~00
5050
```

å¯ä»¥å°†ä»£ç æ”¾åˆ°å®ä»»åŠ¡å½“ä¸­ï¼š

``` js
function sum(num) {
    return new Promise(resolve=> {
        setTimeout(()=> {
            let count = 0;
            for(let i = 0; i < num; i++) {
                count += num--;
            }
            resolve(count)
        })
    })
}
async function abc(num) {
    let res = await sum(num);
    console.log(res)
}
abc(87654321);
console.log("hello");

// hello åŒæ­¥ä»£ç æ‰“å°
// 2881230040066301 å®ä»»åŠ¡
```

äº¤ç»™å¾®ä»»åŠ¡å¤„ç†æ˜¯æ›´å¥½çš„é€‰æ‹©`Promise.resolve().then(...)`

```js
async function func(num) {
  let res = await Promise.resolve().then(_ => {  // å¼‚æ­¥å¾®ä»»åŠ¡
    let count = 0;
    for (let i = 0; i < num; i++) {
      count += num--;
    }
    return count;
  });
  console.log(res);
}
func(987654321);
console.log("hello"); 

// ç»“æœ
// hello
// 365797897407398850
```

### é¢˜ç›®è§£æ

```js
setTimeout(() => {
    console.log(0);  // 10 å®ä»»åŠ¡
}, 0)

new Promise((resolve, reject) => {
	console.log(1);  // 1åŒæ­¥ä»£ç 
    resolve()
}).then(() => {
	console.log(2);  // 3å¾®ä»»åŠ¡
    new Promise((resolve, reject) => {
        console.log(3); // 4å¾®ä»»åŠ¡çš„åŒæ­¥ä»£ç 
		resolve()
    }).then(() => {
      	console.log(4); // 6
    }).then(() => {
      	console.log(5); // 8
    }).then(() => {
        console.log(6);  // 9
    })
}).then(() => {
    console.log(7);  // 7
})

new Promise((resolve, reject) => {
    console.log(8); // 2åŒæ­¥ä»£ç 
	resolve()
}).then(() => {
    console.log(9);  // 5å¾®ä»»åŠ¡
})

// 1 8 2 3 9 4 7 5 6 0
```

ğŸŒ [äº‹ä»¶å¾ªç¯è¯¦è§£ (opens new window)](http://www.inode.club/node/event_loop.html#%E8%AF%A6%E7%BB%86%E8%AE%B2%E8%A7%A3)

```js
async function async1() {
  console.log('async1 start')     // 2
  await async2()    // asyncå‡½æ•°æ‰§è¡Œæ—¶é‡åˆ°awaitå…ˆè¿”å›ï¼Œawaitå¼‚æ­¥å®Œæˆåå†æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åé¢çš„æ‰§è¡Œç›¸å½“äºåœ¨async2 resolveå½“ä¸­æ‰§è¡Œ
  console.log('async1 end')   // 7 å¾®ä»»åŠ¡
}

async function async2() {
  console.log('async2')     // 3  async2æ‰§è¡Œå®ŒæˆåæŠŠ async1 awaitåé¢çš„æ‰§è¡Œæ¨å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—: ['async1 end']
}

console.log('script start')     // 1

setTimeout(function() {
  console.log('setTimeout0')   // 9 æ¬¡è½®å¾ªç¯  å®ä»»åŠ¡
}, 0)

setTimeout(function() {
  console.log('setTimeout3')   // 11 æ¬¡è½®å¾ªç¯  å®ä»»åŠ¡
}, 3)

setImmediate(() => console.log('setImmediate'))   // 10 æ¬¡è½®å¾ªç¯  å®ä»»åŠ¡

process.nextTick(() => console.log('nextTick'))   // 6  å¾®ä»»åŠ¡  ['nextTick', 'async1 end']

async1()     // 2

new Promise(function(resolve) {
  console.log('promise1')   // 4  Promiseæ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°
  resolve()                 // microTaskQueue: ['nextTick', 'async1 end', 'promise3']
  console.log('promise2')   // 5  resolveåä¸ä¼šç»ˆç»“promiseçš„å‚æ•°å‡½æ•°çš„æ‰§è¡Œ
}).then(function() {
  console.log('promise3')   // 8 å¼‚æ­¥å¾®ä»»åŠ¡
})

console.log('script end')   // 6
```

ğŸ”¥ æ‰§è¡Œå®Œasync2ä¹‹åä¸ºä»€ä¹ˆæ²¡æœ‰é©¬ä¸Šè¾“å‡ºasync1 endï¼Ÿ

```js
await async2()
console.log('async1 end')

// ç›¸å½“äºä»¥ä¸‹å‡½æ•°
// ç«‹å³æ‰§è¡Œasync2å‡½æ•°ï¼Œç„¶åå°†awaitåé¢çš„å†…å®¹æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­
async2().then(()=> {
    console.log('async1 end')
})
```

ğŸ”¥ ä¸ºä½•nextTickçš„å›è°ƒå‡½æ•°å…ˆäºasync1 endè¾“å‡º?

- Promise å¯¹è±¡çš„å›è°ƒå‡½æ•°ï¼Œä¼šè¿›å…¥å¼‚æ­¥ä»»åŠ¡microTaské˜Ÿåˆ—ï¼Œ `process.nextTick`çš„å›è°ƒå‡½æ•°ä¼šè¿½åŠ åœ¨nextTické˜Ÿåˆ—å½“ä¸­
- microTaské˜Ÿåˆ—è¿½åŠ åœ¨nextTické˜Ÿåˆ—åï¼Œæ‰€ä»¥nextTickçš„å›è°ƒå‡½æ•°å…ˆæ‰§è¡Œè¾“å‡º

```js
process.nextTick(() => console.log(1))
Promise.resolve().then(() => console.log(2))
process.nextTick(() => console.log(3))
Promise.resolve().then(() => console.log(4))
// 1, 3, 2, 4
```

