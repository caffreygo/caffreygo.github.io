"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[4815],{7484:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-9ea8cdfe",path:"/VueJs3/section2/chapter5.html",title:"éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"ç†è§£ Proxy å’Œ Reflect",slug:"ç†è§£-proxy-å’Œ-reflect",children:[{level:3,title:"Proxy",slug:"proxy",children:[]},{level:3,title:"åŸºæœ¬æ“ä½œä¸å¤åˆæ“ä½œ",slug:"åŸºæœ¬æ“ä½œä¸å¤åˆæ“ä½œ",children:[]},{level:3,title:"Reflect",slug:"reflect",children:[]}]},{level:2,title:"JavaScript å¯¹è±¡åŠ Proxy çš„å·¥ä½œåŸç†",slug:"javascript-å¯¹è±¡åŠ-proxy-çš„å·¥ä½œåŸç†",children:[{level:3,title:"JavaScript å¯¹è±¡",slug:"javascript-å¯¹è±¡",children:[]},{level:3,title:"åŒºåˆ†æ™®é€šå¯¹è±¡ä¸å‡½æ•°",slug:"åŒºåˆ†æ™®é€šå¯¹è±¡ä¸å‡½æ•°",children:[]},{level:3,title:"æ™®é€šçš„å¯¹è±¡ä¸å¼‚è´¨å¯¹è±¡",slug:"æ™®é€šçš„å¯¹è±¡ä¸å¼‚è´¨å¯¹è±¡",children:[]}]},{level:2,title:"å¦‚ä½•ä»£ç† Object",slug:"å¦‚ä½•ä»£ç†-object",children:[{level:3,title:"ä»£ç†çš„æœ¬è´¨",slug:"ä»£ç†çš„æœ¬è´¨",children:[]},{level:3,title:"å¯¹è±¡çš„æ‰€æœ‰è¯»å–æ“ä½œ",slug:"å¯¹è±¡çš„æ‰€æœ‰è¯»å–æ“ä½œ",children:[]},{level:3,title:"å“åº”å¼å¤„ç†",slug:"å“åº”å¼å¤„ç†",children:[]}]},{level:2,title:"åˆç†åœ°è§¦å‘å“åº”",slug:"åˆç†åœ°è§¦å‘å“åº”",children:[{level:3,title:"å€¼å˜åŒ–åˆ¤æ–­",slug:"å€¼å˜åŒ–åˆ¤æ–­",children:[]},{level:3,title:"åŸå‹é“¾å±æ€§è®¿é—®",slug:"åŸå‹é“¾å±æ€§è®¿é—®",children:[]}]},{level:2,title:"æµ…å“åº”ä¸æ·±å“åº”",slug:"æµ…å“åº”ä¸æ·±å“åº”",children:[]},{level:2,title:"åªè¯»ä¸æµ…åªè¯»",slug:"åªè¯»ä¸æµ…åªè¯»",children:[]},{level:2,title:"ä»£ç†æ•°ç»„",slug:"ä»£ç†æ•°ç»„",children:[{level:3,title:"æ•°ç»„çš„ç´¢å¼•ä¸ length",slug:"æ•°ç»„çš„ç´¢å¼•ä¸-length",children:[]},{level:3,title:"éå†æ•°ç»„",slug:"éå†æ•°ç»„",children:[]},{level:3,title:"æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•",slug:"æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•",children:[]},{level:3,title:"éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„åŸå‹æ–¹æ³•",slug:"éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„åŸå‹æ–¹æ³•",children:[]}]},{level:2,title:"ä»£ç† Set å’Œ Map",slug:"ä»£ç†-set-å’Œ-map",children:[{level:3,title:"å¦‚ä½•ä»£ç† Set å’Œ Map",slug:"å¦‚ä½•ä»£ç†-set-å’Œ-map",children:[]},{level:3,title:"å»ºç«‹å“åº”è”ç³»",slug:"å»ºç«‹å“åº”è”ç³»",children:[]},{level:3,title:"é¿å…æ±¡æŸ“åŸå§‹æ•°æ®",slug:"é¿å…æ±¡æŸ“åŸå§‹æ•°æ®",children:[]},{level:3,title:"å¤„ç† forEach",slug:"å¤„ç†-foreach",children:[]},{level:3,title:"è¿­ä»£å™¨æ–¹æ³•",slug:"è¿­ä»£å™¨æ–¹æ³•",children:[]},{level:3,title:"values ä¸ keys æ–¹æ³•",slug:"values-ä¸-keys-æ–¹æ³•",children:[]}]}],filePathRelative:"VueJs3/section2/chapter5.md",git:{updatedTime:1653577344e3,contributors:[{name:"Jinrui Chen",email:"jinrui@kooboo.cn",commits:2},{name:"Jerry Chen",email:"caffreygo@163.com",commits:1}]}}},6740:(n,s,a)=>{a.r(s),a.d(s,{default:()=>u});var p=a(6252);const t=(0,p.uE)('<h1 id="éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ" aria-hidden="true">#</a> éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ</h1><p>ğŸ”– å®ç°å“åº”å¼æ•°æ®ä¸æ­¢æ˜¯å•çº¯åœ°å®ç° get/set çš„æ‹¦æˆªæ“ä½œã€‚è¿˜éœ€è¦è€ƒè™‘éå†ã€æ•°ç»„ä»¥åŠé›†åˆç±»å‹çš„æ”¯æŒã€‚</p><h2 id="ç†è§£-proxy-å’Œ-reflect" tabindex="-1"><a class="header-anchor" href="#ç†è§£-proxy-å’Œ-reflect" aria-hidden="true">#</a> ç†è§£ Proxy å’Œ Reflect</h2><h3 id="proxy" tabindex="-1"><a class="header-anchor" href="#proxy" aria-hidden="true">#</a> Proxy</h3><ul><li><p>Proxyï¼šåˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå®ƒèƒ½å¤Ÿå®ç°å¯¹<strong>å…¶ä»–å¯¹è±¡</strong>çš„ä»£ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒProxyåªèƒ½ä»£ç†å¯¹è±¡ï¼Œæ— æ³•ä»£ç†éå¯¹è±¡å€¼ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ç­‰ç­‰</p></li><li><p>ä»£ç†ï¼šæŒ‡å¯¹ä¸€ä¸ªå¯¹è±¡<strong>åŸºæœ¬è¯­ä¹‰</strong>çš„ä»£ç†ã€‚å®ƒå…è®¸æˆ‘ä»¬<strong>æ‹¦æˆª</strong>å¹¶<strong>é‡æ–°å®šä¹‰</strong>ä¸€ä¸ªå¯¹è±¡çš„åŸºæœ¬æ“ä½œã€‚</p></li><li><p>åŸºæœ¬è¯­ä¹‰ï¼šå¯¹è±¡å±æ€§å€¼çš„è¯»å–ã€è®¾ç½®ï¼Œå‡½æ•°çš„è°ƒç”¨ã€‚</p></li></ul><h3 id="åŸºæœ¬æ“ä½œä¸å¤åˆæ“ä½œ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ“ä½œä¸å¤åˆæ“ä½œ" aria-hidden="true">#</a> åŸºæœ¬æ“ä½œä¸å¤åˆæ“ä½œ</h3><h4 id="åŸºæœ¬æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ“ä½œ" aria-hidden="true">#</a> åŸºæœ¬æ“ä½œ</h4><p>æ¯”å¦‚è¯»å–ã€è®¾ç½®å¯¹è±¡å±æ€§å€¼ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> obj<span class="token punctuation">.</span>foo <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// âš ï¸æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œæ“ä½œçš„æ˜¯ä»£ç†å¯¹è±¡</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>  <span class="token comment">// 1</span>\np<span class="token punctuation">.</span>foo<span class="token operator">++</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>  <span class="token comment">// 2</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è°ƒç”¨å‡½æ•°ä¹Ÿæ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡çš„åŸºæœ¬æ“ä½œï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;æˆ‘æ˜¯ï¼š&#39;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> argArray</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">target</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> <span class="token operator">...</span>argArray<span class="token punctuation">)</span>  <span class="token comment">// æˆ‘æ˜¯Jerry</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token function">p2</span><span class="token punctuation">(</span><span class="token string">&#39;Jerry&#39;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="å¤åˆæ“ä½œ" tabindex="-1"><a class="header-anchor" href="#å¤åˆæ“ä½œ" aria-hidden="true">#</a> å¤åˆæ“ä½œ</h4><p>è°ƒç”¨å¯¹è±¡ä¸‹çš„æ–¹æ³•å°±æ˜¯å…¸å‹çš„éåŸºæœ¬æ“ä½œï¼Œå³å¤åˆæ“ä½œï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>obj<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>å®é™…ä¸Šï¼Œè°ƒç”¨å¯¹è±¡ä¸‹æ–¹æ³•ç”±<strong>ä¸¤ä¸ªåŸºæœ¬è¯­ä¹‰</strong>ç»„æˆã€‚åˆ†åˆ«æ˜¯å±æ€§çš„ get å’Œå‡½æ•°è°ƒç”¨ã€‚</p><blockquote><p>å‡½æ•°çš„è°ƒç”¨æ˜¯åŸºæœ¬è¯­ä¹‰çš„æ“ä½œï¼Œè€Œå¯¹è±¡ä¸‹æ–¹æ³•çš„è°ƒç”¨æ˜¯å¤åˆæ“ä½œ</p></blockquote><h3 id="reflect" tabindex="-1"><a class="header-anchor" href="#reflect" aria-hidden="true">#</a> Reflect</h3><p>Reflect æ˜¯ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå…¶ä¸‹æœ‰å¾ˆå¤šæ–¹æ³•ã€‚<strong>ä»»ä½•åœ¨ Proxy çš„æ‹¦æˆªå™¨èƒ½æ‰¾åˆ°çš„æ–¹æ³•ï¼Œéƒ½èƒ½å¤Ÿåœ¨ Reflect ä¸­æ‰¾åˆ°åŒåå‡½æ•°ã€‚</strong></p><p>ä¸åŒçš„æ˜¯ï¼Œæ¯”å¦‚ Reflect çš„ get æ–¹æ³•èƒ½å¤Ÿæ¥æ”¶ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ŒthisArgå³ä¸Šä¸‹æ–‡ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>\n\tfoo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>\n\t<span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å› ä¸º get æ‹¦æˆªï¼šreturn target[key]</span>\n    <span class="token comment">// è¿™é‡Œ this æŒ‡å‘åŸå§‹å¯¹è±¡ obj</span>\n\t\t<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>foo\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token comment">// è¿™é‡Œæ˜¯ä½¿ç”¨ target ä¹Ÿå°±æ˜¯åŸå§‹å¯¹è±¡è·å–å±æ€§ï¼Œå³ obj[key]</span>\n    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">/*...*/</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æ™®é€šå±æ€§ p[prop] é€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®ï¼Œè§¦å‘ get æ‹¦æˆªï¼Œæ”¶é›†ä¾èµ–</span>\n  <span class="token comment">// getter obj[prop] é€šè¿‡åŸå§‹å¯¹è±¡è®¿é—®ï¼Œæ— æ³•å»ºç«‹å“åº”è”ç³»</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>bar<span class="token punctuation">)</span>  <span class="token comment">// obj getter[foo]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\np<span class="token punctuation">.</span>foo<span class="token operator">++</span> <span class="token comment">// å‰¯ä½œç”¨å‡½æ•°ä¸ä¼šé‡æ–°æ‰§è¡Œ</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>bar å±æ€§ä½œä¸ºè®¿é—®å™¨å±æ€§ï¼Œå½“æˆ‘ä»¬é€šè¿‡ p.bar è¯»å–æ—¶ï¼Œobj getter çš„æ‰§è¡Œè·å–äº† foo å±æ€§ã€‚</p><p>ğŸ› æˆ‘ä»¬å¸Œæœ›å±æ€§ foo ä¹Ÿèƒ½æ”¶é›†å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä½†æ˜¯å®é™…ä¸Šæœ€ç»ˆæˆ‘ä»¬æ˜¯ç”¨ obj.foo å³<strong>åŸå§‹å¯¹è±¡</strong>åœ¨å‰¯ä½œç”¨å‡½æ•°å½“ä¸­è®¿é—®çš„ fooå±æ€§ï¼Œæ‰€ä»¥è¯´ä¸ä¼šå»ºç«‹å“åº”è”ç³»çš„ã€‚</p><p>ğŸ”¥ å¦‚æœæˆ‘ä»¬æŠŠè®¿é—®å™¨å±æ€§ bar çš„ getter å‡½æ•°å†…çš„ this å€¼å‘ä»£ç†å¯¹è±¡ pï¼Œé—®é¢˜å°±è§£å†³äº†ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œï¼Œæ·»åŠ ç¬¬ä¸‰ä¸ªå‚æ•° receiverï¼Œå³ä»£ç†å¯¹è±¡</span>\n  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">/*...*/</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>åŸºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Reflect.* æ–¹æ³•æ¥ä¼ é€’ thisArgã€‚</p><h2 id="javascript-å¯¹è±¡åŠ-proxy-çš„å·¥ä½œåŸç†" tabindex="-1"><a class="header-anchor" href="#javascript-å¯¹è±¡åŠ-proxy-çš„å·¥ä½œåŸç†" aria-hidden="true">#</a> JavaScript å¯¹è±¡åŠ Proxy çš„å·¥ä½œåŸç†</h2><h3 id="javascript-å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#javascript-å¯¹è±¡" aria-hidden="true">#</a> JavaScript å¯¹è±¡</h3><p>JavaScript ä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯å¸¸è§„å¯¹è±¡ï¼ˆordinary objectï¼‰å’Œå¼‚è´¨å¯¹è±¡ï¼ˆexotic objectï¼‰ã€‚</p><p>ğŸ”– å†…éƒ¨æ–¹æ³•æˆ–å†…éƒ¨æ§½ï¼šåœ¨ JavaScript ä¸­ï¼Œå¯¹è±¡çš„å®é™…è¯­ä¹‰æ˜¯ç”±å¯¹è±¡çš„å†…éƒ¨æ–¹æ³•ï¼ˆinternal methodï¼‰æŒ‡å®šçš„ã€‚æ‰€è°“å†…éƒ¨æ–¹æ³•ï¼ŒæŒ‡çš„æ˜¯å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œæ“ä½œæ—¶åœ¨å¼•æ“å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•ã€‚</p><p><em>æ¯”å¦‚è®¿é—®å¯¹è±¡å±æ€§æ—¶ï¼Œå¼•æ“å†…éƒ¨ä¼šè°ƒç”¨ [[Get]] è¿™ä¸ªå†…éƒ¨æ–¹æ³•æ¥è¯»å–å±æ€§å€¼ã€‚ECMAScript ä½¿ç”¨ [[xxx]] æ¥ä»£è¡¨å†…éƒ¨æ–¹æ³•æˆ–å†…éƒ¨æ§½</em></p>',30),e=(0,p.Uk)("ğŸŒ "),o={href:"https://tc39.es/ecma262/#sec-invariants-of-the-essential-internal-methods",target:"_blank",rel:"noopener noreferrer"},c=(0,p.Uk)("JavaScript å¯¹è±¡å¿…é¡»éƒ¨ç½²çš„11ä¸ªå¿…è¦çš„å’Œé¢å¤–çš„å†…éƒ¨æ–¹æ³• (opens new window)"),l=(0,p.uE)('<h3 id="åŒºåˆ†æ™®é€šå¯¹è±¡ä¸å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#åŒºåˆ†æ™®é€šå¯¹è±¡ä¸å‡½æ•°" aria-hidden="true">#</a> åŒºåˆ†æ™®é€šå¯¹è±¡ä¸å‡½æ•°</h3><p>ğŸ”¥ é€šè¿‡å†…éƒ¨æ–¹æ³•å’Œå†…éƒ¨æ§½æ¥åŒºåˆ†ã€‚ä¾‹å¦‚å‡½æ•°å¯¹è±¡ä¼šéƒ¨ç½²å†…éƒ¨æ–¹æ³• [[Call]]ï¼Œè€Œæ™®é€šå¯¹è±¡åˆ™ä¸ä¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\na<span class="token punctuation">.</span>call <span class="token comment">// Æ’ call() { [native code] }</span>\nb<span class="token punctuation">.</span>call <span class="token comment">// undefined</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="æ™®é€šçš„å¯¹è±¡ä¸å¼‚è´¨å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#æ™®é€šçš„å¯¹è±¡ä¸å¼‚è´¨å¯¹è±¡" aria-hidden="true">#</a> æ™®é€šçš„å¯¹è±¡ä¸å¼‚è´¨å¯¹è±¡</h3><p>å†…éƒ¨æ–¹æ³•å…·æœ‰å¤šæ€æ€§ï¼Œä¾‹å¦‚æ™®é€šå¯¹è±¡å’Œ Proxy å¯¹è±¡éƒ½éƒ¨ç½²äº† [[Get]] è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å®ƒä»¬çš„é€»è¾‘æ˜¯ä¸åŒçš„</p><div class="custom-container tip"><p class="custom-container-title">æ™®é€šå¯¹è±¡</p><ul><li>å¯¹äº11ä¸ªå¿…è¦çš„å†…éƒ¨æ–¹æ³•ï¼Œå¿…é¡»ä½¿ç”¨ ECMA è§„èŒƒ 10.1.x èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼›</li><li>å¯¹äºå†…éƒ¨æ–¹æ³• [[Call]]ï¼Œå¿…é¡»ä½¿ç”¨ ECMA è§„èŒƒ 10.2.1 èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼›</li><li>å¯¹äºå†…éƒ¨æ–¹æ³• [[Construct]]ï¼Œå¿…é¡»ä½¿ç”¨ ECMA è§„èŒƒ10.2.2 èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼›</li></ul></div><p>æ‰€æœ‰ä¸ç¬¦åˆè¿™ä¸‰ç‚¹è¦æ±‚çš„å¯¹è±¡éƒ½æ˜¯å¼‚è´¨å¯¹è±¡ã€‚ä¾‹å¦‚ Proxy å¯¹è±¡çš„å†…éƒ¨æ–¹æ³• [[Get]] æ²¡æœ‰ä½¿ç”¨ ECMA è§„èŒƒçš„ 10.1.8 èŠ‚ç»™å‡ºçš„å®šä¹‰å®ç°ï¼Œæ‰€ä»¥ Proxy æ˜¯ä¸€ä¸ªå¼‚è´¨å¯¹è±¡ã€‚</p><p>å¦‚æœåœ¨åˆ›å»ºå¯¹è±¡æ—¶æ²¡æœ‰æŒ‡å®šå¯¹åº”çš„æ‹¦æˆªå‡½æ•°ï¼Œä¾‹å¦‚æ²¡æœ‰æŒ‡å®š get() æ‹¦æˆªå‡½æ•°ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬é€šè¿‡ä»£ç†å¯¹è±¡è®¿é—®å±æ€§å€¼æ—¶ï¼Œä»£ç†å¯¹è±¡çš„å†…éƒ¨æ–¹æ³• [[Get]] ä¼šè°ƒç”¨åŸå§‹å¯¹è±¡çš„å†…éƒ¨æ–¹æ³• [[Get]] æ¥è·å–å±æ€§å€¼ï¼Œè¿™å…¶å®å°±æ˜¯<strong>ä»£ç†é€æ˜æ€§è´¨</strong>ã€‚</p><p>ğŸ”¥ æ‰€ä»¥ï¼Œä»£ç†å¯¹è±¡æ˜¯ç”¨æ¥å®šä¹‰<strong>ä»£ç†å¯¹è±¡æœ¬èº«</strong>çš„å†…éƒ¨æ–¹æ³•å’Œè¡Œä¸ºï¼Œè€Œä¸æ˜¯ç”¨æ¥æŒ‡å®šè¢«ä»£ç†å¯¹è±¡ï¼ˆåŸå§‹å¯¹è±¡ï¼‰çš„å†…éƒ¨æ–¹æ³•å’Œè¡Œä¸ºã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>\n<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>  <span class="token comment">// 1</span>\n<span class="token keyword">delete</span> p<span class="token punctuation">.</span>foo\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>  <span class="token comment">// undefined</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="å¦‚ä½•ä»£ç†-object" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä»£ç†-object" aria-hidden="true">#</a> å¦‚ä½•ä»£ç† Object</h2><h3 id="ä»£ç†çš„æœ¬è´¨" tabindex="-1"><a class="header-anchor" href="#ä»£ç†çš„æœ¬è´¨" aria-hidden="true">#</a> ä»£ç†çš„æœ¬è´¨</h3><ul><li>ä»£ç†å¯¹è±¡çš„æœ¬è´¨ï¼Œå°±æ˜¯æŸ¥é˜…è§„èŒƒå¯¹åº”çš„å¯æ‹¦æˆªçš„åŸºæœ¬æ–¹æ³•ï¼›</li><li>è¿˜è¦åˆ†æå¤åˆæ“ä½œæ‰€ä¾èµ–çš„åŸºæœ¬æ“ä½œï¼Œé€šè¿‡åŸºæœ¬æ“ä½œçš„æ‹¦æˆªæ–¹æ³•é—´æ¥åœ°å¤„ç†å¤åˆæ“ä½œã€‚</li></ul><h3 id="å¯¹è±¡çš„æ‰€æœ‰è¯»å–æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡çš„æ‰€æœ‰è¯»å–æ“ä½œ" aria-hidden="true">#</a> å¯¹è±¡çš„æ‰€æœ‰è¯»å–æ“ä½œ</h3><div class="custom-container tip"><p class="custom-container-title">ä¸€ä¸ªæ™®é€šå¯¹è±¡å¯èƒ½å­˜åœ¨çš„è¯»å–æ“ä½œï¼š</p><ol><li><p>è®¿é—®å±æ€§ï¼šobj.foo</p><p>é€šè¿‡ <strong>get</strong> æ‹¦æˆªå‡½æ•°å®ç°</p></li><li><p>åˆ¤æ–­å¯¹è±¡æˆ–åŸå‹ä¸Šæ˜¯å¦å­˜åœ¨ç»™å®šçš„ key ï¼škey in obj</p><p>in æ“ä½œç¬¦çš„è¿ç®—ç»“æœä¸Šé€šè¿‡è°ƒç”¨ä¸€ä¸ªå«åš <strong>HasProperty</strong> çš„æŠ½è±¡æ–¹æ³•å¾—åˆ°çš„ï¼Œ[[HasProperty]] å¯¹åº”çš„æ‹¦æˆªå‡½æ•°åå« has</p></li><li><p>ä½¿ç”¨ for...in å¾ªç¯éå†å¯¹è±¡ï¼šfor (const key in obj) {}</p><p>åœ¨ generator å‡½æ•°ä¸­ï¼Œé€šè¿‡ <strong>Reflect.ownkey</strong>s è·å–åˆ°å¯¹è±¡è‡ªèº«æ‹¥æœ‰çš„é”®åï¼Œæ”¶é›†éå†ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚</p></li></ol></div><h3 id="å“åº”å¼å¤„ç†" tabindex="-1"><a class="header-anchor" href="#å“åº”å¼å¤„ç†" aria-hidden="true">#</a> å“åº”å¼å¤„ç†</h3><p>ğŸ”¥ å½“ä¸ºå¯¹è±¡æ·»åŠ æˆ–è€…åˆ é™¤å±æ€§æ—¶ï¼Œ<strong>key çš„æ•°é‡</strong>å‘ç”Ÿäº†å˜åŒ–ï¼Œå› æ­¤éƒ½è¦é‡æ–°æ‰§è¡Œ for...in å¯¹åº”çš„ ITERATE_KEY æ‰€å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚</p><p>ğŸ› ä½†æ˜¯æ— è®ºæ—¶å¢åŠ è¿˜æ˜¯è®¾ç½®å¯¹è±¡å±æ€§çš„åŸºæœ¬è¯­ä¹‰éƒ½æ˜¯ [[Set]] ï¼Œæ‰€ä»¥éœ€è¦åœ¨è°ƒç”¨ trigger å‡½æ•°æ—¶ä¼ é€’å¯¹åº”çš„æ“ä½œç±»å‹è¿›è¡ŒåŒºåˆ†ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>\n<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>\n<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ˜¯åœ¨æ·»åŠ æ–°çš„å±æ€§ï¼Œå¦åˆ™æ˜¯è®¾ç½®å·²å­˜åœ¨çš„å±æ€§</span>\n    <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;ADD&#39;</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n    <span class="token comment">// å°† type ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ç»™ trigger å‡½æ•°</span>\n    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// key in obj çš„ä¾èµ–æ”¶é›†</span>\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// for...in å¾ªç¯çš„ä¾èµ–æ”¶é›†</span>\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// åˆ é™¤å¯¹è±¡é”®çš„æ‹¦æˆªï¼Œè§¦å‘å¾ªç¯å…³è”çš„å‰¯ä½œç”¨å‡½æ•°</span>\n    <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;&amp;</span> hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>\n  activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> effectsToRun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token comment">// æ·»åŠ æˆ–åˆ é™¤å½±å“äº† key, å‘å¾ªç¯å…³è”çš„å‰¯ä½œç”¨å‡½æ•°</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;ADD&#39;</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> iterateEffects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n    iterateEffects <span class="token operator">&amp;&amp;</span> iterateEffects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">let</span> activeEffect\n<span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    activeEffect <span class="token operator">=</span> effectFn\n    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>\n\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span>\n  effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options\n  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> effectFn\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> deps <span class="token operator">=</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n    deps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// =================================================================</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;key: &#39;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>  <span class="token comment">// key: foo</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\np<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">123</span>  <span class="token comment">// ADD barï¼Œè§¦å‘å‰¯ä½œç”¨å‡½æ•°ï¼Œkey: foo, key: bar</span>\n<span class="token keyword">delete</span> p<span class="token punctuation">.</span>foo  <span class="token comment">// DELETE fooï¼Œè§¦å‘å‰¯ä½œç”¨å‡½æ•°ï¼Œkey: bar</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br></div></div><h2 id="åˆç†åœ°è§¦å‘å“åº”" tabindex="-1"><a class="header-anchor" href="#åˆç†åœ°è§¦å‘å“åº”" aria-hidden="true">#</a> åˆç†åœ°è§¦å‘å“åº”</h2><p>å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ˜¯éœ€è¦ä¼˜åŒ–çš„ã€‚</p><h3 id="å€¼å˜åŒ–åˆ¤æ–­" tabindex="-1"><a class="header-anchor" href="#å€¼å˜åŒ–åˆ¤æ–­" aria-hidden="true">#</a> å€¼å˜åŒ–åˆ¤æ–­</h3><p>é¦–å…ˆæ˜¯å€¼å¦‚æœä¸ºçœŸæ­£å‘ç”Ÿå˜åŒ–çš„æƒ…å†µï¼Œè¿™ä¸ªè¿˜éœ€è¦è€ƒè™‘ NaN ä¸ç­‰äºè‡ªèº«çš„é—®é¢˜</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token number">NaN</span> <span class="token operator">===</span> <span class="token number">NaN</span>  <span class="token comment">// false</span>\n<span class="token number">NaN</span> <span class="token operator">!==</span> <span class="token number">NaN</span>  <span class="token comment">// true</span>\n\n<span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n  <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;ADD&#39;</span>\n  <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n  <span class="token comment">// æ¯”è¾ƒæ–°å€¼å’Œæ—§å€¼ï¼Œåªæœ‰å®ƒä»¬ä¸å…¨ç­‰ï¼Œå¹¶ä¸”éƒ½ä¸æ˜¯NaNçš„æ—¶å€™æ‰è§¦å‘å“åº”</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldVal <span class="token operator">===</span> oldVal <span class="token operator">||</span> newVal <span class="token operator">===</span> newVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> res\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="åŸå‹é“¾å±æ€§è®¿é—®" tabindex="-1"><a class="header-anchor" href="#åŸå‹é“¾å±æ€§è®¿é—®" aria-hidden="true">#</a> åŸå‹é“¾å±æ€§è®¿é—®</h3><p>ä»¥åŠè®¿é—®åŸå‹é“¾ä¸Šçš„å±æ€§å¯¼è‡´å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œä¸¤æ¬¡çš„é—®é¢˜ã€‚ï¼ˆä½¿ç”¨ä»£ç†å¯¹è±¡ä½œä¸ºåŸå‹ï¼‰</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>\n<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>\n<span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span>\nObject<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Reflect.get(obj, &#39;bar&#39;, receiver)</span>\n  <span class="token comment">// child ä»£ç†çš„å¯¹è±¡ obj æœ¬èº«æ²¡æœ‰è¯¥å±æ€§ï¼Œä¼šæ‰¾åŸå‹ parentï¼Œparentæœ¬èº«ä¹Ÿæ˜¯ä»£ç†å¯¹è±¡</span>\n  <span class="token comment">// æœ€ç»ˆï¼Œchild.bar å’Œ paren.bar éƒ½ä¸å‰¯ä½œç”¨å‡½æ•°å»ºç«‹äº†å“åº”å¼è”ç³»</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>bar<span class="token punctuation">)</span>  <span class="token comment">// 1</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// Reflect.set(obj, &#39;bar&#39;, 2, receiverï¼‰</span>\n<span class="token comment">// è®¾ç½®çš„ bar å±æ€§ä¸å­˜äºå¯¹è±¡ä¸Šï¼Œä¼šåœ¨åŸå‹è°ƒç”¨å…¶parent [[Set]]ï¼Œparentæ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‹¦æˆªè§¦å‘trigger</span>\nchild<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">//ä¼šå¯¼è‡´å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œä¸¤æ¬¡ child.bar + parent.bar</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>å½“ä»£ç†å¯¹è±¡çš„ set æ‹¦æˆªå¯¹è±¡è§¦å‘æ—¶ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åœ¨ child è¿›è¡Œ set </span>\n<span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// target åŸå§‹å¯¹è±¡ obj</span>\n  <span class="token comment">// receiver æ˜¯ä»£ç†å¯¹è±¡ child</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// child æ²¡æœ‰è¯¥å±æ€§ï¼Œåœ¨åŸå‹é“¾çš„ parent ä¸Šè¿›è¡Œ set</span>\n<span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// target åŸå§‹å¯¹è±¡ proto</span>\n  <span class="token comment">// receiver ä»ç„¶æ˜¯ä»£ç†å¯¹è±¡ child</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ğŸ”¥ è§£å†³åŠæ³•ï¼šåˆ¤æ–­ receiver æ˜¯å¦æ˜¯ target çš„ä»£ç†å¯¹è±¡å³å¯ï¼Œåªæœ‰æ»¡è¶³è¿™ä¸ªæ¡ä»¶æ‰è§¦å‘æ›´æ–°ï¼Œè¿™æ ·å°±èƒ½å±è”½ç”±åŸå‹å¼•èµ·çš„æ›´æ–°ã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦åœ¨ä»£ç†å¯¹è±¡ä¸­ä¿å­˜ä¸€ä»½åŸå§‹å¯¹è±¡çš„æ•°æ®ï¼Œæ–¹ä¾¿åç»­çš„åˆ¤æ–­ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// è¡¥å…… raw å±æ€§è·å¾—åŸå§‹å¯¹è±¡</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;raw&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> target\n      <span class="token punctuation">}</span>\n      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n      <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n      <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;ADD&#39;</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token comment">// åˆ¤æ–­ receiver æ˜¯å¦ä¸º target çš„ä»£ç†å¯¹è±¡ï¼Œæ»¡è¶³æ‰è§¦å‘æ›´æ–°</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> receiver<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldVal <span class="token operator">===</span> oldVal <span class="token operator">||</span> newVal <span class="token operator">===</span> newVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">/*...*/</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ==============================================================</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>\n<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>\n<span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\nObject<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> parent<span class="token punctuation">)</span>  <span class="token comment">// true</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>bar<span class="token punctuation">)</span>  <span class="token comment">// 2 child å’Œ parent éƒ½ä¼šæ”¶é›†å½“å‰å‰¯ä½œç”¨å‡½æ•°</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nchild<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment">// è§¦å‘ä¸€æ¬¡ child çš„ä¾èµ–æ›´æ–°</span>\nobj<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment">// ä¸æ˜¯æ“ä½œå“åº”å¼å¯¹è±¡ï¼Œä¸ä¼šè§¦å‘ set</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="æµ…å“åº”ä¸æ·±å“åº”" tabindex="-1"><a class="header-anchor" href="#æµ…å“åº”ä¸æ·±å“åº”" aria-hidden="true">#</a> æµ…å“åº”ä¸æ·±å“åº”</h2><p>ç›®å‰å®ç°çš„reactive åªæ˜¯æµ…å“åº”ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡çš„ç¬¬ä¸€å±‚å±æ€§æ˜¯å“åº”çš„ï¼Œç¬¬äºŒå±‚åŠæ›´æ·±å±‚æ¬¡çš„å±æ€§åˆ™ä¸æ˜¯å“åº”å¼çš„ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token punctuation">{</span>bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nobj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment">// ä¿®æ”¹æœªè§¦å‘å“åº”</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿™é‡Œé¦–å…ˆä½¿ç”¨ Reflect.get è¯»å– obj.foo çš„å€¼ï¼Œè·å–åˆ°çš„æ˜¯æ™®é€šå¯¹è±¡ { bar: 1 }ï¼Œå› ä¸ºè¿™ä¸æ˜¯å“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨å‰¯ä½œç”¨å‡½æ•°å½“ä¸­è®¿é—® obj.foo.bar ä¸ä¼šå»ºç«‹å“åº”å¼è”ç³»ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦è¿›è¡Œä¸€å±‚åŒ…è£…ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> isShallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;raw&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> target\n      <span class="token punctuation">}</span>\n      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n\t\t\t<span class="token comment">// æµ…å“åº”ç›´æ¥è¿”å›åŸå§‹å€¼</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isShallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> res\n      <span class="token punctuation">}</span>\n      <span class="token comment">// æ·±å“åº”ï¼š å…ˆå¾—åˆ°åŸå§‹å€¼ç»“æœ</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> res <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// è°ƒç”¨ reactive å°†ç»“æœåŒ…è£…æˆå“åº”å¼æ•°æ®å¹¶è¿”å›</span>\n        <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>å½“ç„¶ï¼Œä¹Ÿæœ‰éœ€è¦æµ…å“åº”æ•ˆæœçš„éœ€æ±‚ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token punctuation">{</span>bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// obj.foo æ˜¯å“åº”çš„ï¼Œå¯ä»¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ</span>\nobj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>\n<span class="token comment">// obj.foo.bar ä¸æ˜¯å“åº”çš„ï¼Œä¸èƒ½è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ</span>\nobj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="åªè¯»ä¸æµ…åªè¯»" tabindex="-1"><a class="header-anchor" href="#åªè¯»ä¸æµ…åªè¯»" aria-hidden="true">#</a> åªè¯»ä¸æµ…åªè¯»</h2><p>å½“ç”¨æˆ·å°è¯•ä¿®æ”¹åªè¯»æ•°æ®æ—¶ï¼Œä¼šæ”¶åˆ°ä¸€æ¡è­¦å‘Šä¿¡æ¯ã€‚ä¾‹å¦‚ props å¯¹è±¡å°±åº”è¯¥æ˜¯ä¸€ä¸ªåªè¯»æ•°æ®ã€‚</p><ul><li>åªè¯»çš„æ•°æ®ï¼Œæ—¢ä¸èƒ½è®¾ç½® setï¼Œä¹Ÿä¸èƒ½åˆ é™¤ deleteProperty</li><li>åªè¯»æ•°æ®æ— æ³•ä¿®æ”¹ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ä¸ºåªè¯»æ•°æ®å»ºç«‹å“åº”è”ç³»</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment">// æ·±å“åº”</span>\n<span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">createReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// æµ…å“åº”</span>\n<span class="token keyword">function</span> <span class="token function">shallowReactive</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">createReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// æ·±åªè¯»</span>\n<span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">createReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n<span class="token comment">// æµ…åªè¯»</span>\n<span class="token keyword">function</span> <span class="token function">shallowReadonly</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token function">createReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> isShallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;raw&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> target\n      <span class="token punctuation">}</span>\n      <span class="token comment">// åªè¯»ä¸éœ€è¦å»ºç«‹å“åº”è”ç³»ï¼Œå› ä¸ºä¸ä¼šè¢«ä¿®æ”¹</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      \n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isShallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> res\n      <span class="token punctuation">}</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> res <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// æ·±åªè¯»/å“åº”</span>\n        <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// åªè¯»æ—¶å¯¹ set æ“ä½œæ‹¦æˆªå¹¶è­¦å‘Š</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">å±æ€§ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> æ˜¯åªè¯»çš„</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n      <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;ADD&#39;</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> receiver<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldVal <span class="token operator">===</span> oldVal <span class="token operator">||</span> newVal <span class="token operator">===</span> newVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// åªè¯»å±æ€§ä¸èƒ½åˆ é™¤ï¼ŒæŠ›å‡ºè­¦å‘Š</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">å±æ€§ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> æ˜¯åªè¯»çš„</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&amp;&amp;</span> hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// =================================================================</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// æ·±åªè¯»ï¼Œæ— æ³•ä¿®æ”¹åˆ é™¤ï¼Œä¸ä¼šå»ºç«‹å“åº”è”ç³»</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">)</span>  <span class="token comment">// 1</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nobj<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// warnï¼šå±æ€§ bar æ˜¯åªè¯»çš„ï¼Œæ­¤æ—¶ obj.foo.bar è¿˜æ˜¯1</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h2 id="ä»£ç†æ•°ç»„" tabindex="-1"><a class="header-anchor" href="#ä»£ç†æ•°ç»„" aria-hidden="true">#</a> ä»£ç†æ•°ç»„</h2><p>æ•°ç»„æ˜¯ä¸€ä¸ªå¼‚è´¨å¯¹è±¡ï¼Œæ•°ç»„å¯¹è±¡çš„ [[DefineOwnProperty]] å†…éƒ¨æ–¹æ³•ä¸å¸¸è§„å¯¹è±¡ä¸åŒã€‚</p><p>ä½†å…¶ä»–å†…éƒ¨æ–¹æ³•çš„é€»è¾‘ä¸å¸¸è§„å¯¹è±¡æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤ä»£ç†æ™®é€šå¯¹è±¡çš„å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯å¯ä»¥ç»§ç»­ä½¿ç”¨çš„ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;foo&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// foo</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\narr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;bar&#39;</span>  <span class="token comment">// èƒ½å¤Ÿè§¦å‘å“åº”</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">æ‰€æœ‰å¯¹æ•°ç»„å…ƒç´ æˆ–å±æ€§çš„â€œè¯»å–â€æ“ä½œï¼š</p><ul><li>é€šè¿‡ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ å€¼ï¼šarr[0]</li><li>è®¿é—®æ•°ç»„é•¿åº¦ï¼šarr.length</li><li>æŠŠæ•°ç»„ä½œä¸ºå¯¹è±¡ï¼Œä½¿ç”¨ for...in å¾ªç¯éå†</li><li>ä½¿ç”¨ for...of è¿­ä»£æ•°ç»„éå†</li><li>æ•°ç»„çš„åŸå‹æ–¹æ³•ï¼Œå¦‚concat/join/every/some/find/findIndex/includesç­‰ï¼Œä»¥åŠå…¶ä»–æ‰€æœ‰ä¸æ”¹å˜åŸæ•°ç»„çš„åŸå‹æ–¹æ³•</li></ul></div><div class="custom-container tip"><p class="custom-container-title">æ‰€æœ‰å¯¹æ•°ç»„å…ƒç´ æˆ–å±æ€§çš„â€œè®¾ç½®â€æ“ä½œï¼š</p><ul><li>é€šè¿‡ç´¢å¼•ä¿®æ”¹æ•°ç»„å…ƒç´ å€¼ï¼šarr[1] = 3</li><li>ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼šarr.length = 0</li><li>æ•°ç»„çš„æ ˆæ–¹æ³•ï¼špush/pop/shift/unshift</li><li>ä¿®æ”¹åŸæ•°ç»„çš„åŸå‹æ–¹æ³•ï¼šsplice/fill/sort ç­‰</li></ul></div><h3 id="æ•°ç»„çš„ç´¢å¼•ä¸-length" tabindex="-1"><a class="header-anchor" href="#æ•°ç»„çš„ç´¢å¼•ä¸-length" aria-hidden="true">#</a> æ•°ç»„çš„ç´¢å¼•ä¸ length</h3><p>ä½¿ç”¨ç´¢å¼•è®¾ç½®æ•°ç»„å…ƒç´ å€¼å’Œå¯¹è±¡è®¾ç½®å±æ€§å€¼æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ [[Set]] ï¼Œ [[Set]] è¿™ä¸ªå†…éƒ¨æ–¹æ³•å…¶å®ä¾èµ–äº [[DefineOwnProperty]] ã€‚ä½†æ˜¯æ•°ç»„å¯¹è±¡å†…éƒ¨éƒ¨ç½²çš„ [[DefineOwnProperty]] ä¸åŒäºå¸¸è§„å¯¹è±¡ã€‚</p><h4 id="ä½¿ç”¨ç´¢å¼•-set" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨ç´¢å¼•-set" aria-hidden="true">#</a> ä½¿ç”¨ç´¢å¼• set</h4><p>å½“è®¾ç½®çš„ç´¢å¼•å€¼å¤§äºæ•°ç»„å½“å‰çš„é•¿åº¦æ—¶ï¼Œä¼šæ›´æ–°æ•°ç»„çš„ length å±æ€§ã€‚è¿™ä¸ªéšå¼çš„ä¿®æ”¹éœ€è¦æˆ‘ä»¬è§¦å‘ä¸ length å±æ€§å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;bar&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// length å±æ€§æ”¶é›†äº†å½“å‰å‰¯ä½œç”¨å‡½æ•°ï¼Œè€Œè¿™ä¸ªä¿®æ”¹ä½¿ length å±æ€§å‘ç”Ÿäº†å˜åŒ–</span>\narr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;foo&#39;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ğŸš€ æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ set æ‹¦æˆªä¸­åŒºåˆ†å½“å‰æ“ä½œç±»å‹æ˜¯ SET è¿˜æ˜¯ ADDï¼Œä»¥æ­¤åˆ¤æ–­ length å±æ€§æ˜¯å¦ä¼šå—å½±å“ã€‚</p><h4 id="ç´¢å¼•è¢«ä¿®æ”¹" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•è¢«ä¿®æ”¹" aria-hidden="true">#</a> ç´¢å¼•è¢«ä¿®æ”¹</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;bar&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// length ä¿®æ”¹ä¹‹åï¼Œå¤§äºæ–°ç´¢å¼•å€¼å½“æ—§å±æ€§å·²ç»è¢«åˆ é™¤ï¼Œéœ€è¦å¯¹åº”è§¦å‘å“åº”</span>\narr<span class="token punctuation">[</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ğŸš€ è¿™é‡Œå½“ä¿®æ”¹ length å±æ€§æ—¶ï¼Œåªæœ‰é‚£äº›ç´¢å¼•å€¼å¤§äºæˆ–ç­‰äºæ–°çš„ length å±æ€§å€¼å½“å…ƒç´ æ‰éœ€è¦è§¦å‘å“åº”ã€‚</p><h4 id="ä»£ç è°ƒæ•´" tabindex="-1"><a class="header-anchor" href="#ä»£ç è°ƒæ•´" aria-hidden="true">#</a> ä»£ç è°ƒæ•´</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">createReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> isShallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token comment">// é’ˆå¯¹æ•°ç»„æ‹¦æˆªè®¾ç½®æ“ä½œçš„è°ƒæ•´</span>\n    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">å±æ€§ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> æ˜¯åªè¯»çš„</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">const</span> oldVal <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n      \n      <span class="token keyword">const</span> type <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n      \t<span class="token comment">// åŒºåˆ†æ•°ç»„å½“å‰çš„ set æ“ä½œæ˜¯åœ¨ SET è¿˜æ˜¯ ADD</span>\n        <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;ADD&#39;</span>\n      \t<span class="token comment">// å¦‚æœå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ˜¯åœ¨æ·»åŠ æ–°çš„å±æ€§ï¼Œå¦åˆ™æ˜¯è®¾ç½®å·²å­˜åœ¨çš„å±æ€§</span>\n        <span class="token operator">:</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;ADD&#39;</span>\n      \n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> receiver<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>oldVal <span class="token operator">===</span> oldVal <span class="token operator">||</span> newVal <span class="token operator">===</span> newVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// å°†æ“ä½œç±»å‹ä¼ é€’ç»™ trigger å‡½æ•°å¤„ç†</span>\n          <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">/*...*/</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> effectsToRun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  \n  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;ADD&#39;</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> iterateEffects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n    iterateEffects <span class="token operator">&amp;&amp;</span> iterateEffects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\t<span class="token comment">// æ•°ç»„åœ¨æ·»åŠ æ–°å…ƒç´ ï¼Œè§¦å‘ length ç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;ADD&#39;</span> <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> lengthEffects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;length&#39;</span><span class="token punctuation">)</span>\n    lengthEffects <span class="token operator">&amp;&amp;</span> lengthEffects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\t<span class="token comment">// æ•°ç»„è®¾ç½®äº†æ–° length ï¼Œè§¦å‘è¢«åˆ é™¤çš„ key ç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">effects<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&gt;=</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h3 id="éå†æ•°ç»„" tabindex="-1"><a class="header-anchor" href="#éå†æ•°ç»„" aria-hidden="true">#</a> éå†æ•°ç»„</h3><h4 id="for-in" tabindex="-1"><a class="header-anchor" href="#for-in" aria-hidden="true">#</a> for...in</h4><p>å¯¹äºæ™®é€šå¯¹è±¡æ¥è¯´ï¼Œé€šè¿‡å¯¹ ownKeys çš„æ‹¦æˆªå·²ç»èƒ½å¤Ÿæ»¡è¶³ for...in éå†è·Ÿè¸ªï¼Œæˆ‘ä»¬ä½¿ç”¨äº† ITERATE_KEY å­˜å‚¨ç€å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œåªæœ‰å½“å¯¹è±¡çš„å±æ€§æ·»åŠ æˆ–è€…åˆ é™¤æ—¶æ‰éœ€è¦è§¦å‘å®ƒä»¬é‡æ–°æ‰§è¡Œã€‚è€Œå¯¹äºæ•°ç»„æ¥è¯´ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¼šå½±å“åˆ°å®ƒçš„ for...in éå†ã€‚ï¼ˆ<em>åº”å°½é‡é¿å…ä½¿ç”¨ for...in éå†æ•°ç»„</em>ï¼‰</p><ul><li>æ·»åŠ æ–°å…ƒç´ ï¼šarr[100] = &#39;bar&#39;</li><li>ä¿®æ”¹æ•°ç»„é•¿åº¦ï¼š arr.length = 0</li></ul><p>ğŸš€ è¿™äº›æ“ä½œæœ¬è´¨ä¸Šéƒ½æ˜¯ä¿®æ”¹äº†æ•°ç»„çš„é•¿åº¦ï¼Œå› æ­¤è°ƒæ•´å¯¹åº”çš„ ownKeys æ‹¦æˆªå‡½æ•°å³å¯ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// å¦‚æœæ“ä½œç›®æ ‡æ˜¯æ•°ç»„ï¼Œåˆ™å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°ä¸æ•°ç»„çš„ length æ•°ç»„å»ºç«‹å“åº”è”ç³»</span>\n  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="for-of" tabindex="-1"><a class="header-anchor" href="#for-of" aria-hidden="true">#</a> for...of</h4><ul><li>for...ofï¼šéå†å¯è¿­ä»£å¯¹è±¡ï¼ˆiterable objectï¼‰</li><li>å¯è¿­ä»£å¯¹è±¡ï¼šES2015 ä¸º JavaScript å®šä¹‰äº†è¿­ä»£<strong>åè®®</strong>ï¼ˆiteration protocolï¼‰</li></ul><p>ğŸ”– ä¸€ä¸ªå¯¹è±¡èƒ½å¦è¢«è¿­ä»£ï¼Œå–å†³äºè¯¥å¯¹è±¡çš„åŸå‹æ˜¯å¦å®ç°äº† @@iterator æ–¹æ³•ã€‚è¿™ä¸ªçš„ @@[name] æ ‡å¿—åœ¨ECMAScript è§„èŒƒé‡Œç”¨æ¥ä»£æŒ‡ JavaScript å†…å»ºçš„ symbolsã€‚ä¾‹å¦‚ @@iterator æŒ‡çš„å°±æ˜¯ Symbol.iterator è¿™ä¸ªå€¼ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å®ç°äº† Symbol.iterator æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯<strong>å¯è¿­ä»£çš„</strong>ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>\n\tval<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n\t<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span>\n\t\t\t<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\t\t\t\t<span class="token keyword">return</span> <span class="token punctuation">{</span>\n\t\t\t\t\tvalue<span class="token operator">:</span> obj<span class="token punctuation">.</span>val<span class="token operator">++</span><span class="token punctuation">,</span>\n\t\t\t\t\tdone<span class="token operator">:</span> obj<span class="token punctuation">.</span>val <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span>\n\t\t\t\t<span class="token punctuation">}</span>\n\t\t\t<span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> value <span class="token keyword">of</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// 0 1 2 3 4 5 6 7 8 9</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>æ•°ç»„å†…å»ºäº† Symbol.iterator æ–¹æ³•çš„å®ç°ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n<span class="token comment">// è·å–å¹¶è°ƒç”¨æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªè¿­ä»£å™¨</span>\n<span class="token keyword">const</span> itr <span class="token operator">=</span> arr<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// {value: 1, done: false}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// {value: 2, done: false}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// {value: 3, done: false}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// {value: undefined, done: true}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>æ¨¡æ‹Ÿå®ç°æ•°ç»„è¿­ä»£å™¨ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>\n\narr<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> len <span class="token operator">=</span> target<span class="token punctuation">.</span>length<span class="token punctuation">;</span>\n  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        value<span class="token operator">:</span> index <span class="token operator">&lt;</span> len <span class="token operator">?</span> target<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>\n        done<span class="token operator">:</span> index <span class="token operator">++</span> <span class="token operator">&gt;=</span> len\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>ğŸš€ å¯è§ï¼Œè¿­ä»£æ•°ç»„æ—¶ï¼Œåªéœ€è¦åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸æ•°ç»„çš„é•¿åº¦å’Œç´¢å¼•ç›´æ¥å»ºç«‹å“åº”è”ç³»ï¼Œå°±èƒ½å¤Ÿå®ç°å“åº”å¼çš„ for...of è¿­ä»£ã€‚</p><p>æˆ‘ä»¬ä¸éœ€è¦å¢åŠ ä»»ä½•ä»£ç å°±èƒ½å¤Ÿä½¿å…¶æ­£ç¡®å·¥ä½œï¼Œå› ä¸ºæ•°ç»„çš„é•¿åº¦å’Œå…ƒç´ å€¼å‘ç”Ÿæ”¹å˜ï¼Œå‰¯ä½œç”¨å‡½æ•°è‡ªç„¶ä¼šé‡æ–°æ‰§è¡Œã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// for (const val of arr.values()) {...}</span>\n  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> val <span class="token keyword">of</span> arr<span class="token punctuation">)</span><span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\narr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;bar&#39;</span><span class="token punctuation">;</span>  <span class="token comment">// èƒ½å¤Ÿè§¦å‘å“åº”</span>\narr<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// èƒ½å¤Ÿè§¦å‘å“åº”</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>æ•°ç»„çš„ values æ–¹æ³•çš„è¿”å›å€¼å®é™…ä¸Šå°±æ˜¯æ•°ç»„å†…å»ºçš„è¿­ä»£å™¨ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>values <span class="token operator">===</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// true</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>ğŸ” æœ€åï¼Œæ— è®ºæ˜¯ä½¿ç”¨ values æ–¹æ³•å‡½æ•°ï¼Œæˆ–è€…ä½¿ç”¨ for...of ç›´æ¥å¾ªç¯æ•°ç»„ï¼Œéƒ½ä¼šè®¿é—®æ•°ç»„çš„ Symbol.iterator å±æ€§ã€‚ä¸ºäº†é¿å…å‘ç”Ÿæ„å¤–çš„é”™è¯¯ï¼Œä»¥åŠæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸ Symbol.iterator è¿™ç±» symbol å€¼ä¹‹é—´å»ºç«‹å“åº”è”ç³»ï¼Œå› æ­¤ä¿®æ”¹ä¿®æ”¹ä¸€ä¸‹ get æ‹¦æˆªå‡½æ•°ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;raw&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> target\n      <span class="token punctuation">}</span>\n\n      <span class="token comment">// æ·»åŠ åˆ¤æ–­ï¼Œå¦‚æœ key çš„ç±»å‹æ˜¯ symbolï¼Œåˆ™ä¸è¿›è¡Œè¿½è¸ª</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> key <span class="token operator">!==</span> <span class="token string">&#39;symbol&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n\n      <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>isShallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> res\n      <span class="token punctuation">}</span>\n      <span class="token comment">// å¦‚æœå…ƒç´ å€¼æ˜¯å¯ä»¥è¢«ä»£ç†çš„ï¼Œè¿”å›ä»£ç†å¯¹è±¡</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> res <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token function">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•" aria-hidden="true">#</a> æ•°ç»„çš„æŸ¥æ‰¾æ–¹æ³•</h3><blockquote><p>includes / indexOf / lastIndexOf</p></blockquote><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">incluides</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// ä¸ length/æ‰€æœ‰ç´¢å¼• å»ºç«‹å“åº”è”ç³»</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\narr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment">// è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>æ•°ç»„çš„æ–¹æ³•å…¶å®éƒ½ä¾èµ–äº†å¯¹è±¡çš„åŸºæœ¬è¯­ä¹‰ï¼Œæ¯”å¦‚ includes æ–¹æ³•ä¼šè®¿é—®æ•°ç»„çš„ length å’Œç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾ï¼Œå› æ­¤å½“æˆ‘ä»¬ä¿®æ”¹æŸä¸ªç´¢å¼•ä¸‹çš„å€¼éƒ½èƒ½æ­£ç¡®è§¦å‘å“åº”ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span>obj<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// false ä»£ç†å¯¹è±¡ç›´æ¥çš„æ¯”è¾ƒ</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// false ä»£ç†å¯¹è±¡ä¸åŸå§‹å€¼çš„æ¯”è¾ƒ</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">ğŸš€ æ•°ç»„æŸ¥æ‰¾æ–¹æ³•çš„åˆ†æ</p><ul><li>includes æ–¹æ³•åœ¨æŸ¥è¯¢å€¼çš„æ—¶å€™ï¼Œthis æŒ‡å‘ä»£ç†å¯¹è±¡ arrï¼›</li><li>arr[0] è®¿é—®ä»£ç†å¯¹è±¡çš„å…ƒç´ å€¼ï¼Œè¿™ä¸ªå€¼ obj ä»ç„¶æ˜¯å¯ä»¥è¢«ä»£ç†çš„ï¼Œè¿™é‡Œè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡è€ŒéåŸå§‹å¯¹è±¡ï¼›</li><li>includes æ–¹æ³•å†…éƒ¨ä¹Ÿä¼šå–åˆ° arr ä»£ç†å¯¹è±¡ä¸‹çš„å…ƒç´ å€¼ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ä»£ç†å¯¹è±¡ï¼›</li></ul><ol><li>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»£ç†è¿‡çš„å¯¹è±¡ç¼“å­˜èµ·æ¥ä¿è¯å¤šæ¬¡ä»£ç†åå¾—åˆ°çš„å¯¹è±¡æ˜¯ç›¸åŒçš„ï¼›</li><li>åŒæ—¶ï¼Œå¯¹äºä¸åŸå§‹å€¼æ¯”è¾ƒçš„æƒ…å†µï¼Œè¦é‡å†™å¦‚ includes è¿™äº›æ ¹æ®ç»™å®šå€¼æŸ¥æ‰¾ç»“æœçš„æ–¹æ³•ã€‚</li></ol></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arrayInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token string">&#39;includes&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;indexOf&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;lastIndexOf&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> originMethod <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span>\n  arrayInstrumentations<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// this æ˜¯ä»£ç†å¯¹è±¡ï¼Œå…ˆåœ¨ä»£ç†å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œå°†ç»“æœå­˜å‚¨åˆ° res ä¸­</span>\n    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">originMethod</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// res ä¸º false è¯´æ˜æ²¡æ‰¾åˆ°ï¼Œåœ¨é€šè¿‡ this.raw æ‹¿åˆ°åŸå§‹æ•°ç»„ï¼Œå†å»åŸå§‹æ•°ç»„ä¸­æŸ¥æ‰¾ï¼Œå¹¶æ›´æ–° res å€¼</span>\n      res <span class="token operator">=</span> <span class="token function">originMethod</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raw<span class="token punctuation">,</span> args<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// è¿”å›æœ€ç»ˆçš„ç»“æœ</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">createReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> isShallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">/*...*/</span>\n      <span class="token comment">// ä½¿ç”¨é‡å†™åçš„æ•°ç»„æ–¹æ³•</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arrayInstrumentations<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token comment">/*...*/</span>\n      <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„åŸå‹æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„åŸå‹æ–¹æ³•" aria-hidden="true">#</a> éšå¼ä¿®æ”¹æ•°ç»„é•¿åº¦çš„åŸå‹æ–¹æ³•</h3><blockquote><p>æ ˆæ–¹æ³•ï¼špush / pop / shift / unshift + splice</p></blockquote><p>ğŸ”– push æ–¹æ³•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šè¯»å–æ•°ç»„çš„ length å±æ€§å€¼ï¼Œä¹Ÿä¼šè®¾ç½® lengthã€‚æˆ‘ä»¬è™½ç„¶å¤„ç†äº† set ä¸ä¼šè§¦å‘å½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œå¯¼è‡´çš„æ ˆæº¢å‡ºé—®é¢˜ï¼Œä½†æ˜¯ä»¥ä¸‹è¿™ä¸ªæƒ…å†µä»ç„¶ä¼šå‡ºç°æ ˆæº¢å‡ºï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><p>ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åæ•°ç»„çš„ length æ•°ç»„ä¼šä¸ å‰¯ä½œç”¨å‡½æ•°å»ºç«‹å“åº”è”ç³»</p></li><li><p>ç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œï¼ŒåŒæ ·å»ºç«‹äº†å“åº”å¼è”ç³»ï¼Œä½†æ˜¯ push è¿˜ä¼šè®¾ç½® length</p></li><li><p>ç¬¬äºŒä¸ªå‡½æ•°çš„ length è®¾ç½®è§¦å‘å“åº”ï¼ŒæŠŠä¸¤ä¸ªå‰¯ä½œç”¨å‡½æ•°éƒ½å–å‡ºé‡æ–°æ‰§è¡Œã€‚</p><p>æ­¤æ—¶ç¬¬äºŒä¸ªå‰¯ä½œç”¨å‡½æ•°è¿˜æ²¡æ‰§è¡Œå®Œï¼Œå°±è¦å†æ‰§è¡Œç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°äº†ã€‚</p></li><li><p>åŒæ ·ç¬¬ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°è¿˜åœ¨è®¾ç½® length çš„æ—¶å€™ï¼Œåˆå¼€å§‹äº†ä¾èµ–è§¦å‘æ›´æ–°</p></li><li><p>å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œæœ€ç»ˆå¯¼è‡´è°ƒåŠ¨æ ˆæº¢å‡º</p></li></ul><p>ğŸš€ å› ä¸º push å†…å¯¹ length çš„è¯»å–æ“ä½œæ˜¯è¿™ä¸ªé—®é¢˜çš„åŸå› ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å±è”½è¿™ä¸ªè¿‡ç¨‹å¯¹ length å»ºç«‹å“åº”å¼è”ç³»ã€‚push çš„è¯­ä¹‰æ˜¯ä¿®æ”¹æ“ä½œï¼Œè€Œä¸æ˜¯è¯»å–æ“ä½œã€‚å› æ­¤æˆ‘ä»¬éœ€è¦é‡å†™ push æ–¹æ³•ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>\n<span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token string">&#39;push&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pop&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;shift&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;unshift&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;splice&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> originMethod <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span>\n  arrayInstrumentations<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span>\n    <span class="token comment">// å–å¾—åŸå§‹æ–¹æ³•</span>\n    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">originMethod</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>\n    <span class="token comment">// è°ƒç”¨åæ¢å¤åŸæ¥çš„è¡Œä¸ºï¼Œå³å…è®¸è¿½è¸ª</span>\n    shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">/*...*/</span>\n\n<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// å½“æ ‡è®°å˜é‡ä¸å…è®¸è¿½è¸ªæ—¶ï¼Œreturn</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect <span class="token operator">||</span> <span class="token operator">!</span>shouldTrack<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  <span class="token comment">/*...*/</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="ä»£ç†-set-å’Œ-map" tabindex="-1"><a class="header-anchor" href="#ä»£ç†-set-å’Œ-map" aria-hidden="true">#</a> ä»£ç† Set å’Œ Map</h2><blockquote><p>é›†åˆç±»å‹æ•°æ®ï¼šMap / Set, WeakSet / WeakMap</p></blockquote><p>ğŸ”¥ Map å’Œ Set ä¸¤ä¸ªæ•°æ®ç±»å‹çš„æ“ä½œæ–¹æ³•ç±»ä¼¼ã€‚å®ƒä»¬ä¹‹é—´æœ€å¤§çš„ä¸åŒä½“ç°åœ¨ï¼ŒSet æ•°æ®ç±»å‹ä½¿ç”¨ add(value) æ–¹æ³•æ·»åŠ å…ƒç´ ï¼Œè€Œ Map ç±»ä¼¼ä½¿ç”¨ set(key, value) æ–¹æ³•è®¾ç½®é”®å€¼å¯¹ï¼Œå¹¶ä¸” Map ç±»ä¼¼å¯ä»¥ä½¿ç”¨ get(key) æ–¹æ³•è¯»å–å“åº”çš„å€¼ã€‚</p><h3 id="å¦‚ä½•ä»£ç†-set-å’Œ-map" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä»£ç†-set-å’Œ-map" aria-hidden="true">#</a> å¦‚ä½•ä»£ç† Set å’Œ Map</h3><div class="custom-container tip"><p class="custom-container-title">Set æ•°æ®ç±»å‹çš„ä»£ç†</p><ul><li>è™½ç„¶æ“ä½œæ–¹æ³•å’Œæ™®é€šå¯¹è±¡ä¸ä¸€è‡´ï¼Œä½†æ˜¯æ•´ä½“çš„æ€è·¯æ˜¯ä¸å˜çš„ï¼Œå³åœ¨è¯»å–æ“ä½œå‘ç”Ÿæ—¶è°ƒç”¨ track å‡½æ•°å»ºç«‹å“åº”å¼è”ç³»ï¼›å½“è®¾ç½®æ“ä½œå‘ç”Ÿæ—¶ï¼Œè°ƒç”¨ trigger å‡½æ•°è§¦å‘å“åº”ï¼›</li><li>Set.prototype.size æ˜¯ä¸€ä¸ª<strong>è®¿é—®å™¨å±æ€§</strong>ï¼Œå†…éƒ¨é€šè¿‡ this çš„æŠ½è±¡æ–¹æ³• RequireInternalSlot(s, [[SetData]]) æ¥æ£€æŸ¥ s æ˜¯å¦å­˜åœ¨å†…éƒ¨æ§½ [[SetData]]ï¼Œè¿™æ˜¯ä»£ç†ä¹‹åçš„å¯¹è±¡æ²¡æœ‰çš„ï¼Œéœ€è¦é€šè¿‡ Reflect æŒ‡å®šï¼›</li><li>ä½¿ç”¨ delete <strong>æ–¹æ³•</strong>æ—¶ï¼Œå…ˆè®¿é—® p.delete ï¼Œå†æ‰§è¡Œ p.delete(val) æ–¹æ³•ã€‚æ— è®ºæ€ä¹ˆä¿®æ”¹ receicerï¼Œdelete æ–¹æ³•æ‰§è¡Œæ—¶çš„ this éƒ½ä¼šæŒ‡å‘ä»£ç†å¯¹è±¡ pï¼Œè€Œä¸ä¼šæŒ‡å‘ Set å¯¹è±¡ï¼Œå› æ­¤éœ€è¦æŠŠ delete æ–¹æ³•ä¸åŸå§‹æ•°æ®å¯¹è±¡ç»‘å®šï¼›</li></ul></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;size&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// å±æ€§è®¿é—®å™¨çš„ä¸Šä¸‹æ–‡ç»‘å®šï¼Œè·å–åˆ°æ­£ç¡®çš„æŠ½è±¡æ–¹æ³•</span>\n        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n\t\t\t<span class="token comment">// å°†æ–¹æ³•ä¸åŸå§‹æ•°æ®å¯¹è±¡ target å¯¹è±¡ç»‘å®šåè¿”å›</span>\n      <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">)</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">)</span>\np<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="å»ºç«‹å“åº”è”ç³»" tabindex="-1"><a class="header-anchor" href="#å»ºç«‹å“åº”è”ç³»" aria-hidden="true">#</a> å»ºç«‹å“åº”è”ç³»</h3><ul><li>add / delete æ–¹æ³•ä¼šé—´æ¥ä¿®æ”¹ size å±æ€§ï¼Œéœ€è¦è§¦å‘å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ</li><li>add æ–¹æ³•æ·»åŠ çš„å…ƒç´ å¦‚æœå·²ç»å­˜åœ¨äº Set é›†åˆå½“ä¸­ï¼Œå°±ä¸å†éœ€è¦è§¦å‘å“åº”äº†</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n    <span class="token keyword">const</span> hadKey <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token comment">// å€¼æ˜¯å¦å·²ç»å­˜åœ¨çš„åˆ¤æ–­ï¼Œæå‡æ€§èƒ½</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&#39;ADD&#39;</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n    <span class="token keyword">const</span> hadKey <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> res\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">createReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> isShallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isReadonly <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;raw&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> target\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;size&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// è¯»å– size çš„å‰¯ä½œç”¨å‡½æ•°è¢«æ”¶é›†åˆ° ITERATE_KEY çš„å…³è”æ¡¶ä¸­</span>\n        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span> mutableInstrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æ·»åŠ ã€åˆ é™¤è¿™äº›å½±å“ size çš„æ–¹æ³•éƒ½ä¼šè§¦å‘å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;ADD&#39;</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> iterateEffects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n    iterateEffects <span class="token operator">&amp;&amp;</span> iterateEffects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\t<span class="token comment">/*...*/</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/*...*/</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="é¿å…æ±¡æŸ“åŸå§‹æ•°æ®" tabindex="-1"><a class="header-anchor" href="#é¿å…æ±¡æŸ“åŸå§‹æ•°æ®" aria-hidden="true">#</a> é¿å…æ±¡æŸ“åŸå§‹æ•°æ®</h3><p>ğŸš€ è¦ä¿è¯åŸå§‹æ•°æ®ä¸å…·æœ‰å“åº”å¼æ•°æ®çš„èƒ½åŠ›ï¼Œå¦åˆ™å°±æ„å‘³ç€ç”¨æˆ·å¯ä»¥åŒæ—¶æ“ä½œä¸¤ç§æ•°æ®ï¼Œè¿™æ ·ä»£ç å°±ä¹±å¥—äº†</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>\n<span class="token keyword">const</span> p2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\np1<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;p2&#39;</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// è¿™é‡Œé€šè¿‡åŸå§‹æ•°æ® m è®¿é—® p2</span>\n\tconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;p2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token comment">// è¿™é‡Œä½¿ç”¨åŸå§‹æ•°æ® m è°ƒç”¨ set æ–¹æ³•ï¼Œè¿™é‡Œä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œä¸ç¬¦åˆæœŸæœ›</span>\nm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;p2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;foo&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ğŸ”– åŸæ¥çš„ set æ–¹æ³•å†…ï¼ŒæŠŠ value åŸæ ·è®¾ç½®åˆ°äº†åŸå§‹æ•°æ® target ä¸Šã€‚å¦‚æœ value æ˜¯å“åº”å¼æ•°æ®ï¼Œå°±æ„å‘³ç€è®¾ç½®åˆ°åŸå§‹å¯¹è±¡ä¸Šçš„ä¹Ÿæ˜¯å“åº”å¼æ•°æ®ï¼Œæˆ‘ä»¬æŠŠ<strong>å“åº”å¼æ•°æ®è®¾ç½®åˆ°åŸå§‹æ•°æ®ä¸Šçš„è¡Œä¸ºç§°ä¸ºæ•°æ®æ±¡æŸ“</strong>ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n  <span class="token keyword">const</span> had <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n  <span class="token comment">// target.set(key, value) </span>\n  <span class="token comment">// è·å–åŸå§‹æ•°æ®ï¼Œç”±äº value æœ¬èº«å¯èƒ½å·²ç»ä¸Šå“åº”å¼æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶ value.raw ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ value</span>\n  <span class="token keyword">const</span> rawValue <span class="token operator">=</span> value<span class="token punctuation">.</span>raw <span class="token operator">||</span> value\n  target<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> rawValue<span class="token punctuation">)</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>had<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&#39;ADD&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>oldValue <span class="token operator">===</span> oldValue <span class="token operator">&amp;&amp;</span> value <span class="token operator">===</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&#39;SET&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><em>ä½¿ç”¨ raw è®¿é—®å¯èƒ½ä¸ç”¨æˆ·è‡ªå®šä¹‰çš„ raw å±æ€§å†²çªï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ Symbol ç±»å‹æ¥ä»£æ›¿</em></p><h3 id="å¤„ç†-foreach" tabindex="-1"><a class="header-anchor" href="#å¤„ç†-foreach" aria-hidden="true">#</a> å¤„ç† forEach</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">{</span>key<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  m<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  \tconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>  <span class="token comment">// {key: 1}</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token comment">// {value: 1}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">é›†åˆç±»å‹çš„ forEach ä»£ç†</p><ul><li><p>éå†æ“ä½œåªä¸é”®å€¼å¯¹çš„æ•°é‡æœ‰å…³ï¼Œå› æ­¤ä»»ä½•ä¼šä¿®æ”¹ Map å¯¹è±¡é”®å€¼å¯¹æ•°é‡(size)çš„æ“ä½œéƒ½åº”è¯¥è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚</p></li><li><p>forEach å›è°ƒå‡½æ•°å†…çš„æ•°æ®ä¹Ÿè¦æ˜¯å“åº”å¼çš„ï¼Œæ‰èƒ½æ­£å¸¸æ”¶é›†ä¾èµ–</p></li><li><p>forEach å›è°ƒå‡½æ•°èƒ½å¤Ÿæ¥å— thisArg ä½œä¸ºæ‰§è¡Œæ—¶çš„ this å€¼</p></li><li><p>forEach ä¸ for...in çš„å“åº”å¼è”ç³»éƒ½å»ºç«‹åœ¨ ITERATE_KEY ä¸å‰¯ä½œç”¨å‡½æ•°ä¹‹é—´</p></li><li><p>ä½¿ç”¨ for...in éå†é›†åˆç±»å‹ï¼Œå®ƒåªå…³å¿ƒå¯¹è±¡çš„é”®ï¼Œåªæœ‰å¢å‡å¯¹è±¡çš„ key æ‰éœ€è¦è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼›Map ç±»å‹ forEach éå†æ—¶ï¼Œå›è°ƒå‡½æ•°èƒ½å¤Ÿå–åˆ°<strong>é”®å’Œå€¼</strong>ï¼Œæ‰€ä»¥å³ä½¿æ˜¯ SET æ“ä½œï¼Œä¹Ÿè¦èƒ½è§¦å‘å“åº”</p></li></ul></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">/*...*/</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>\n    type <span class="token operator">===</span> <span class="token string">&#39;ADD&#39;</span> <span class="token operator">||</span>\n    type <span class="token operator">===</span> <span class="token string">&#39;DELETE&#39;</span> <span class="token operator">||</span>\n    <span class="token comment">// å¦‚æœæ“ä½œç±»å‹æ˜¯ SETï¼Œå¹¶ä¸”ç›®æ ‡å¯¹è±¡æ˜¯ Map ç±»å‹çš„æ•°æ®</span>\n    <span class="token comment">// ä¹Ÿåº”è¯¥è§¦å‘é‚£äº›ä¸ ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ</span>\n    <span class="token punctuation">(</span>\n      type <span class="token operator">===</span> <span class="token string">&#39;SET&#39;</span> <span class="token operator">&amp;&amp;</span>\n      <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;[object Map]&#39;</span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> iterateEffects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n    iterateEffects <span class="token operator">&amp;&amp;</span> iterateEffects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">/*...*/</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">/*...*/</span>\n  <span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> thisArg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val\n    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n    <span class="token comment">// ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å‚æ•°ä¹Ÿè¦æ˜¯å“åº”å¼çš„ï¼Œæ‰èƒ½æ”¶é›†ä¾èµ–</span>\n    target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v<span class="token punctuation">,</span> k</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token comment">// forEach æ–¹æ³•èƒ½å¤ŸæŒ‡å®šæ‰§è¡Œæ—¶çš„ this</span>\n      <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/*...*/</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="è¿­ä»£å™¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#è¿­ä»£å™¨æ–¹æ³•" aria-hidden="true">#</a> è¿­ä»£å™¨æ–¹æ³•</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n\t<span class="token punctuation">[</span><span class="token string">&#39;key1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;value1&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n\t<span class="token punctuation">[</span><span class="token string">&#39;key2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;value2&#39;</span><span class="token punctuation">]</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> m<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">}</span>\n<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> itr <span class="token operator">=</span> m<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// { value: [&#39;key1&#39;, &#39;value1&#39;], done: false}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// { value: [&#39;key2&#39;, &#39;value2&#39;], done: false}</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// { value: undefined, done: true}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">é›†åˆç±»å‹çš„è¿­ä»£å™¨æ–¹æ³•ä»£ç†</p><ul><li>é›†åˆç±»å‹æœ‰ä¸‰ä¸ªè¿­ä»£å™¨<strong>æ–¹æ³•</strong>ï¼šentriesã€keysã€value</li><li>Map æˆ– Set ç±»å‹æœ¬èº«éƒ¨ç½²äº† Symbol.iterator æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ for...of è¿›è¡Œè¿­ä»£ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ç”Ÿæˆè¿­ä»£å™¨</li><li>ä¸ºäº†ä½¿ç”¨ä»£ç†å¯¹è±¡èƒ½å¤Ÿæ­£å¸¸è¿­ä»£ï¼Œè¦æ‹¦æˆª Symbol.iterator å±æ€§è¿”å›åŸè¿­ä»£å™¨æ–¹æ³•ï¼ˆæ»¡è¶³è¿­ä»£åè®®æ‰èƒ½è¿­ä»£ï¼‰</li><li>è¿­ä»£äº§ç”Ÿçš„å€¼å¦‚æœæ˜¯å¯ä»£ç†çš„ï¼Œä¹Ÿè¦å°†å…¶å°è£…æˆå“åº”å¼æ•°æ®</li><li>ä¸ºäº†è¿½è¸ª for...of å¯¹æ•°æ®çš„è¿­ä»£æ“ä½œï¼Œéœ€è¦è°ƒç”¨ track å‡½æ•°ï¼Œè®©å‰¯ä½œç”¨å‡½æ•°ä¹Ÿ ITERATE_KEY å»ºç«‹è”ç³»</li><li>å› ä¸º p.entries ä¸ p[Symbol.iterator] ç­‰ä»·ï¼Œå¯ä»¥ä½¿ç”¨ä¸€æ ·çš„æ–¹å¼å¤„ç†</li><li>å¯è¿­ä»£æŒ‡çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å®ç°äº† Symbol.iterator æ–¹æ³•ï¼Œè€Œè¿­ä»£å™¨åè®®æŒ‡çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å®ç°äº† next æ–¹æ³•ã€‚ä¸€ä¸ªå¯¹è±¡å¯ä»¥åŒæ—¶å®ç°å¯è¿­ä»£åè®®å’Œè¿­ä»£å™¨åè®®</li></ul></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token operator">:</span> iterationMethod<span class="token punctuation">,</span>\n  entries<span class="token operator">:</span> iterationMethod<span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">iterationMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// è·å–åŸå§‹æ•°æ®å¯¹è±¡ target</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n  <span class="token comment">// è·å–åˆ°åŸå§‹è¿­ä»£å™¨æ–¹æ³•</span>\n  <span class="token keyword">const</span> itr <span class="token operator">=</span> target<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val\n\t<span class="token comment">// å¯¹äºè¿­ä»£æ“ä½œçš„ä¾èµ–æ”¶é›†</span>\n  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n\n  <span class="token comment">// å°†å…¶è¿”å›</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token comment">// è¿­ä»£å™¨åè®®ï¼šå¯¹è±¡å®ç° next æ–¹æ³•</span>\n    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        <span class="token comment">// callback å‚æ•°å“åº”å¤„ç†</span>\n        value<span class="token operator">:</span> value <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> value<span class="token punctuation">,</span>\n        done\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// å¯è¿­ä»£åè®®ï¼šå¯¹è±¡å®ç°äº† Symbol.iterator æ–¹æ³•</span>\n    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="values-ä¸-keys-æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#values-ä¸-keys-æ–¹æ³•" aria-hidden="true">#</a> values ä¸ keys æ–¹æ³•</h3><div class="custom-container tip"><p class="custom-container-title">é›†åˆç±»å‹ valuesã€keys è¿­ä»£å™¨æ–¹æ³•ä»£ç†</p><ul><li>values å’Œ keys æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œä¸åŒåœ¨äºå¤„ç†çš„æ˜¯é”®è¿˜æ˜¯å€¼</li><li>Mapæ•°æ®ç±»å‹ä¸‹ï¼ŒSET æ“ä½œä¼šè§¦å‘ä¸ ITERATE_KEY å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚å¯¹äº values æˆ– entries æ–¹æ³•æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯å¯¹äº keys æ–¹æ³•æ¥è¯´æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚ SET æ“ä½œä¸ä¼šä½¿ keys æ–¹æ³•æœ‰ä»»ä½•å‰¯ä½œç”¨å‘ç”Ÿã€‚ï¼ˆä½¿ç”¨ MAP_KEY_ITERATE_KEY å»ºç«‹ keys çš„å“åº”å¼å…³è”ï¼‰</li></ul></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> <span class="token constant">MAP_KEY_ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  \n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>\n    <span class="token comment">// æ“ä½œç±»å‹ä¸º ADD æˆ– DELETE</span>\n    type <span class="token operator">===</span> <span class="token string">&#39;ADD&#39;</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>\n      <span class="token comment">// å¹¶ä¸”æ˜¯ Map ç±»å‹çš„æ•°æ®</span>\n    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;[object Map]&#39;</span>\n  <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å–å‡ºé‚£äº›ä¸ MAP_KEY_ITERATE_KEY ç›¸å…³è”çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œ</span>\n    <span class="token keyword">const</span> iterateEffects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span>\n    iterateEffects <span class="token operator">&amp;&amp;</span> iterateEffects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  \n  <span class="token comment">// ...</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> mutableInstrumentations <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ...</span>\n  keys<span class="token operator">:</span> keysIterationMethod<span class="token punctuation">,</span>\n  values<span class="token operator">:</span> valuesIterationMethod<span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">valuesIterationMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n  <span class="token comment">// è·å–åŸå§‹çš„ values æ–¹æ³•è¿”å›çš„è¿­ä»£å™¨</span>\n  <span class="token keyword">const</span> itr <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val\n  <span class="token comment">// entriesã€values æ–¹æ³•ä¾æ—§ä¸ ITERATE_KEY å»ºç«‹å“åº”è”ç³»</span>\n  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        value<span class="token operator">:</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>\n        done\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">keysIterationMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raw\n  <span class="token comment">// è·å–åŸå§‹çš„ keys æ–¹æ³•è¿”å›çš„è¿­ä»£å™¨</span>\n  <span class="token keyword">const</span> itr <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val\n  <span class="token comment">// keys æ–¹æ³•ä¸ MAP_KEY_ITERATE_KEY å»ºç«‹å“åº”è”ç³»</span>\n  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token constant">MAP_KEY_ITERATE_KEY</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token punctuation">{</span>\n    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> itr<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token punctuation">{</span>\n        value<span class="token operator">:</span> <span class="token function">wrap</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>\n        done\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token keyword">this</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/*...*/</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div>',120),u={render:function(n,s){const a=(0,p.up)("OutboundLink");return(0,p.wg)(),(0,p.iD)(p.HY,null,[t,(0,p._)("p",null,[e,(0,p._)("a",o,[c,(0,p.Wm)(a)])]),l],64)}}}}]);