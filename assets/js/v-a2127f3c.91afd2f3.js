"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[4601],{6880:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-a2127f3c",path:"/VueJs3/section2/chapter4.html",title:"å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°",slug:"å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°",children:[{level:3,title:"å‰¯ä½œç”¨å‡½æ•°",slug:"å‰¯ä½œç”¨å‡½æ•°",children:[]},{level:3,title:"å“åº”å¼æ•°æ®",slug:"å“åº”å¼æ•°æ®",children:[]}]},{level:2,title:"å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°",slug:"å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°",children:[]},{level:2,title:"å®Œå–„çš„å“åº”ç³»ç»Ÿ",slug:"å®Œå–„çš„å“åº”ç³»ç»Ÿ",children:[{level:3,title:"å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œæœºåˆ¶",slug:"å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œæœºåˆ¶",children:[]},{level:3,title:"WeakMap",slug:"weakmap",children:[]}]},{level:2,title:"åˆ†æ”¯åˆ‡æ¢ä¸cleanup",slug:"åˆ†æ”¯åˆ‡æ¢ä¸cleanup",children:[{level:3,title:"åˆ†æ”¯åˆ‡æ¢",slug:"åˆ†æ”¯åˆ‡æ¢",children:[]},{level:3,title:"Set å¾ªç¯é—®é¢˜",slug:"set-å¾ªç¯é—®é¢˜",children:[]},{level:3,title:"æœ€ç»ˆä»£ç ",slug:"æœ€ç»ˆä»£ç ",children:[]}]},{level:2,title:"åµŒå¥—çš„ effect ä¸ effect æ ˆ",slug:"åµŒå¥—çš„-effect-ä¸-effect-æ ˆ",children:[]},{level:2,title:"é¿å…æ— é™é€’å½’å¾ªç¯",slug:"é¿å…æ— é™é€’å½’å¾ªç¯",children:[]},{level:2,title:"è°ƒåº¦æ‰§è¡Œ",slug:"è°ƒåº¦æ‰§è¡Œ",children:[{level:3,title:"ç¼“å†²é˜Ÿåˆ—",slug:"ç¼“å†²é˜Ÿåˆ—",children:[]}]},{level:2,title:"è®¡ç®—å±æ€§ computed ä¸ lazy",slug:"è®¡ç®—å±æ€§-computed-ä¸-lazy",children:[]},{level:2,title:"watch çš„å®ç°åŸç†",slug:"watch-çš„å®ç°åŸç†",children:[]},{level:2,title:"è¿‡æœŸçš„å‰¯ä½œç”¨",slug:"è¿‡æœŸçš„å‰¯ä½œç”¨",children:[]}],filePathRelative:"VueJs3/section2/chapter4.md",git:{updatedTime:1656932009e3,contributors:[{name:"Jinrui Chen",email:"jinrui@kooboo.cn",commits:4},{name:"Jerry Chen",email:"caffreygo@163.com",commits:1}]}}},9534:(n,s,a)=>{a.r(s),a.d(s,{default:()=>u});var p=a(6252);const t=(0,p.uE)('<h1 id="å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°" tabindex="-1"><a class="header-anchor" href="#å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°" aria-hidden="true">#</a> å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°</h1><div class="custom-container tip"><p class="custom-container-title">æ¦‚è¿°</p><ul><li>åˆ†æ”¯åˆ‡æ¢ï¼šé¢„æ¸…ç©ºä¾èµ–é›†åˆ <code>effectFn.deps.forEach(dep =&gt; dep.delete(effectFn))</code></li><li>Set æ­»å¾ªç¯ï¼šæ‹·è´åå†éå†</li><li><code>effect</code>åµŒå¥—ï¼šå‰¯ä½œç”¨å‡½æ•°æ ˆ</li><li>åŒæ—¶è¯»å†™æ­»å¾ªç¯ï¼š<code>effectFn !== activeEffect</code></li></ul></div><p>Vue.js 3 é‡‡ç”¨ Proxy å®ç°å“åº”å¼æ•°æ®</p><h2 id="å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°" aria-hidden="true">#</a> å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°</h2><h3 id="å‰¯ä½œç”¨å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å‰¯ä½œç”¨å‡½æ•°" aria-hidden="true">#</a> å‰¯ä½œç”¨å‡½æ•°</h3><ul><li>å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼›</li><li>å½“å‡½æ•°çš„æ‰§è¡Œç›´æ¥æˆ–é—´æ¥å½±å“å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¯´å‡½æ•°äº§ç”Ÿäº†å‰¯ä½œç”¨ï¼›</li><li>å‰¯ä½œç”¨å¾ˆå®¹æ˜“äº§ç”Ÿï¼Œä¾‹å¦‚ä¸€ä¸ªå‡½æ•°ä¿®æ”¹äº†å…¨å±€å˜é‡ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨ã€‚</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> val <span class="token operator">=</span> <span class="token number">1</span>\n\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  val <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// ä¿®æ”¹å…¨å±€å˜é‡ï¼Œäº§ç”Ÿå‰¯ä½œç”¨</span>\n  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&#39;hello&#39;</span> <span class="token comment">// ä¿®æ”¹äº†ä¸€ä¸ªä»»ä½•å‡½æ•°éƒ½å¯ä»¥è¯»å–æˆ–è€…è®¾ç½®çš„å†…å®¹</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="å“åº”å¼æ•°æ®" tabindex="-1"><a class="header-anchor" href="#å“åº”å¼æ•°æ®" aria-hidden="true">#</a> å“åº”å¼æ•°æ®</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">&#39;hello&#39;</span> <span class="token punctuation">}</span>\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\t<span class="token comment">// effect å‡½æ•°çš„æ‰§è¡Œä¼šè¯»å– obj.text</span>\n\tdocument<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text\n<span class="token punctuation">}</span>\n\nobj<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&#39;new value&#39;</span> <span class="token comment">// ä¿®æ”¹ obj.text çš„å€¼ï¼ŒåŒæ—¶å¸Œæœ›å‰¯ä½œç”¨å‡½æ•°ä¼šé‡æ–°æ‰§è¡Œ</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ğŸ”¥ å½“æ•°æ®çš„å˜åŒ–èƒ½å¤Ÿä½¿å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°è‡ªåŠ¨é‡æ–°æ‰§è¡Œï¼Œé‚£ä¹ˆè¯¥æ•°æ® obj å¯¹è±¡å°±æ˜¯å“åº”å¼æ•°æ®</p><h2 id="å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°" tabindex="-1"><a class="header-anchor" href="#å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°" aria-hidden="true">#</a> å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°</h2><ul><li>å½“å‰¯ä½œç”¨å‡½æ•° effect æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µ obj.text çš„è¯»å–æ“ä½œï¼›</li><li>å½“ä¿®æ”¹ obj.text å½“å€¼æ—¶ï¼Œä¼šè§¦å‘å­—æ®µ obj.text çš„è®¾ç½®æ“ä½œï¼›</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>\n<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// åŸå§‹æ•°æ®</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">&#39;hello world&#39;</span> <span class="token punctuation">}</span>\n<span class="token comment">// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>\n  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•° effect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­</span>\n    bucket<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>\n    <span class="token comment">// è¿”å›å±æ€§å€¼</span>\n    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// æ‹¦æˆªè®¾ç½®æ“ä½œ</span>\n  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// è®¾ç½®å±æ€§å€¼</span>\n    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal\n    <span class="token comment">// æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ</span>\n    bucket<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// ---------------------------------</span>\n\n<span class="token comment">// å‰¯ä½œç”¨å‡½æ•°</span>\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>text\n<span class="token punctuation">}</span>\n<span class="token comment">// é¦–æ¬¡æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ”¶é›†ä¾èµ–</span>\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token comment">// ä¿®æ”¹æ•°æ®ï¼Œè‡ªåŠ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  obj<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&#39;new val&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><blockquote><p>å½“ setter æ‹¦æˆªè®¾ç½®å¹¶æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œä¼šå†æ¬¡è§¦å‘ getterï¼Œbucket Set æ•°æ®å¯ä»¥ä¿è¯å‰¯ä½œç”¨å‡½æ•°çš„æ”¶é›†ä¸é‡å¤</p></blockquote><h2 id="å®Œå–„çš„å“åº”ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#å®Œå–„çš„å“åº”ç³»ç»Ÿ" aria-hidden="true">#</a> å®Œå–„çš„å“åº”ç³»ç»Ÿ</h2><div class="custom-container tip"><p class="custom-container-title">ä¸€ä¸ªå“åº”ç³»ç»Ÿçš„å·¥ä½œæµç¨‹å¦‚ä¸‹</p><ul><li>å½“è¯»å–æ“ä½œå‘ç”Ÿæ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°â€æ¡¶â€œä¸­ï¼›</li><li>å½“è®¾ç½®æ“ä½œå‘ç”Ÿæ—¶ï¼Œä»â€æ¡¶â€œä¸­å–å‡ºå‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œï¼›</li></ul></div><h3 id="å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œæœºåˆ¶" aria-hidden="true">#</a> å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œæœºåˆ¶</h3><details class="custom-container details"><summary>æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°</summary><p>åŸºæœ¬å®ç°ç¡¬ç¼–ç äº†å‰¯ä½œç”¨å‡½æ•°çš„åå­—ï¼ˆeffectï¼‰ï¼Œå®ƒç”šè‡³è¿˜æœ‰å¯èƒ½ä¸ºåŒ¿åå‡½æ•°ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦æä¾›ä¸€ä¸ªç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°çš„æœºåˆ¶ï¼š</p><ol><li><strong>æ‰‹åŠ¨æ‰§è¡Œ</strong> effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°</li><li>å…ˆæŠŠå‰¯ä½œç”¨å‡½æ•°èµ‹å€¼åˆ°å…¨å±€å˜é‡ activeEffect</li><li>ç„¶åæ‰§è¡ŒçœŸæ­£çš„å‰¯ä½œç”¨å‡½æ•°è§¦å‘ Proxy çš„ get</li><li>get æ‹¦æˆªå™¨ç›´æ¥è¯»å–å…¨å±€å˜é‡å®ç°ä¾èµ–æ”¶é›†ï¼štrack(target, key)</li></ol></details><h3 id="weakmap" tabindex="-1"><a class="header-anchor" href="#weakmap" aria-hidden="true">#</a> WeakMap</h3>',19),e=(0,p.Uk)("ğŸŒ "),c={href:"https://www.ijerrychen.com/javascript/map.html#weakmap",target:"_blank",rel:"noopener noreferrer"},o=(0,p.Uk)("WeakMap (opens new window)"),l=(0,p.uE)('<p>WeakMap å¯¹ key æ˜¯å¼±å¼•ç”¨ï¼Œä¸å½±å“åƒåœ¾å›æ”¶çš„å·¥ä½œã€‚æ ¹æ®è¿™ä¸ªç‰¹æ€§å¯çŸ¥ï¼Œä¸€æ—¦ key è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œé‚£ä¹ˆå¯¹åº”çš„é”®å’Œå€¼å°±è®¿é—®ä¸åˆ°äº†ã€‚</p><p>æ‰€ä»¥ WeakMap ç»å¸¸ç”¨äºå­˜å‚¨é‚£äº›åªæœ‰å½“ key æ‰€å¼•ç”¨çš„å¯¹è±¡å­˜åœ¨æ—¶ï¼ˆæ²¡æœ‰è¢«å›æ”¶ï¼‰æ‰æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>\n<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// åŸå§‹æ•°æ®</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> text<span class="token operator">:</span> <span class="token string">&#39;hello world&#39;</span> <span class="token punctuation">}</span>\n<span class="token comment">// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>\n  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­</span>\n    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token comment">// è¿”å›å±æ€§å€¼</span>\n    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token comment">// æ‹¦æˆªè®¾ç½®æ“ä½œ</span>\n  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// è®¾ç½®å±æ€§å€¼</span>\n    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal\n    <span class="token comment">// æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ</span>\n    <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span>\n<span class="token keyword">let</span> activeEffect\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect</span>\n  activeEffect <span class="token operator">=</span> fn\n  <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>\n  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><blockquote><p>WeakMap =&gt; Map =&gt; Set</p></blockquote><h2 id="åˆ†æ”¯åˆ‡æ¢ä¸cleanup" tabindex="-1"><a class="header-anchor" href="#åˆ†æ”¯åˆ‡æ¢ä¸cleanup" aria-hidden="true">#</a> åˆ†æ”¯åˆ‡æ¢ä¸cleanup</h2><h3 id="åˆ†æ”¯åˆ‡æ¢" tabindex="-1"><a class="header-anchor" href="#åˆ†æ”¯åˆ‡æ¢" aria-hidden="true">#</a> åˆ†æ”¯åˆ‡æ¢</h3><ul><li>ä¸‰å…ƒè¡¨è¾¾å¼é¦–æ¬¡çœŸå€¼ä¼šå¯¼è‡´ data çš„ä¸¤ä¸ªå­—æ®µéƒ½æŠŠå½“å‰å‰¯ä½œç”¨å‡½æ•°æ”¶é›†ä¸ºä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¯´ data ä»»ä½•ä¸€ä¸ªå­—æ®µçš„æ›´æ”¹éƒ½ä¼šå¯¼è‡´å‰¯ä½œç”¨å‡½æ•°çš„é‡æ–°æ‰§è¡Œ</li><li>ä½†æ˜¯ï¼Œå½“ ok æ”¹å˜ä¸º false ï¼Œè¿™é‡Œäº§ç”Ÿäº†é—ç•™çš„å‰¯ä½œç”¨å‡½æ•°ã€‚å®é™…ä¸Šæˆ‘ä»¬å¸Œæœ›åªæœ‰ text å­—æ®µä¿ç•™ç€å½“å‰è¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°ä¾èµ–ã€‚</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">&#39;hello&#39;</span> <span class="token punctuation">}</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\tdocument<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerText <span class="token operator">=</span> obj<span class="token punctuation">.</span>ok <span class="token operator">?</span> obj<span class="token punctuation">.</span>text <span class="token operator">:</span> <span class="token string">&#39;not&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦<strong>é‡æ–°å»ºç«‹è”ç³»</strong>ï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå…ˆæŠŠå®ƒä¸æ‰€æœ‰å…³è”çš„ä¾èµ–é›†åˆä¸­åˆ é™¤ï¼Œæ‰§è¡Œåä¾¿é‡æ–°æ”¶é›†äº†æ–°ä¸€è½®çš„ä¾èµ–ã€‚</p><p>âœ…å¢åŠ  activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ</p><h3 id="set-å¾ªç¯é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#set-å¾ªç¯é—®é¢˜" aria-hidden="true">#</a> Set å¾ªç¯é—®é¢˜</h3><p>åœ¨è°ƒç”¨ forEach éå† Set é›†åˆæ—¶ï¼Œå¦‚æœä¸€ä¸ªå€¼å·²ç»è¢«è®¿é—®è¿‡ï¼Œä½†è¯¥å€¼è¢«åˆ é™¤å¹¶é‡æ–°æ·»åŠ åˆ°é›†åˆï¼Œå¦‚æœæ­¤æ—¶ forEach éå†æ²¡æœ‰ç»“æŸï¼Œé‚£ä¹ˆè¯¥å€¼ä¼šè¢«é‡æ–°è®¿é—®ã€‚</p><p>âœ…è¿™ç§æƒ…å†µä¸‹ä¼šå‡ºç°æ­»å¾ªç¯ï¼Œå¯ä»¥æ„é€ ä¸€ä¸ªé¢å¤–çš„ Set é›†åˆå¹¶éå†å®ƒ</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> newSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>\nnewSet<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  set<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n  set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>chrome è°ƒè¯•ç›®å‰å¥½åƒæ²¡æœ‰å¤ç°è¿™ä¸ªé—®é¢˜</p></blockquote><h3 id="æœ€ç»ˆä»£ç " tabindex="-1"><a class="header-anchor" href="#æœ€ç»ˆä»£ç " aria-hidden="true">#</a> æœ€ç»ˆä»£ç </h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶</span>\n<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment">// åŸå§‹æ•°æ®</span>\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">&#39;hello world&#39;</span> <span class="token punctuation">}</span>\n<span class="token comment">// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token comment">// æ‹¦æˆªè¯»å–æ“ä½œ</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­</span>\n        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token comment">// è¿”å›å±æ€§å€¼</span>\n        <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token comment">// æ‹¦æˆªè®¾ç½®æ“ä½œ</span>\n    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// è®¾ç½®å±æ€§å€¼</span>\n        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal\n        <span class="token comment">// æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ</span>\n        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>\n    activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>\n    <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token comment">// å£°æ˜ä¸€ä¸ªæ–° Set è¿›è¡Œéå†æ“ä½œ</span>\n    <span class="token keyword">const</span> effectsToRun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment">// effectFn() çš„æ‰§è¡Œä¼šé‡æ–°è§¦å‘ä¾èµ–æ”¶é›† track</span>\n    effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token comment">// effects &amp;&amp; effects.forEach(effectFn =&gt; effectFn())</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span>\n<span class="token keyword">let</span> activeEffect\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°è¿›è¡Œä¾èµ–æ”¶é›†ä¹‹å‰ï¼Œå…ˆæ¸…ç©ºå†å²ä¾èµ–æ•°æ®</span>\n        <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n        <span class="token comment">// å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect</span>\n        activeEffect <span class="token operator">=</span> effectFn\n        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ä¾èµ–æ”¶é›†</span>\n    <span class="token punctuation">}</span>\n    <span class="token comment">// activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ</span>\n    effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œåˆå§‹çš„ä¾èµ–é›†åˆå£°æ˜ä¸ä¾èµ–æ”¶é›†</span>\n    <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// deps å³æŸä¸ªå¯¹è±¡å±æ€§ä¸‹çš„ä¾èµ–æ¡¶</span>\n        <span class="token keyword">const</span> deps <span class="token operator">=</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        deps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">// æœ€åéœ€è¦é‡ç½® effectFn.deps æ•°ç»„</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><h2 id="åµŒå¥—çš„-effect-ä¸-effect-æ ˆ" tabindex="-1"><a class="header-anchor" href="#åµŒå¥—çš„-effect-ä¸-effect-æ ˆ" aria-hidden="true">#</a> åµŒå¥—çš„ effect ä¸ effect æ ˆ</h2><p>ç»„ä»¶åµŒå¥—å°±ä¼šå‡ºç° effect çš„åµŒå¥—ï¼Œå…¨å±€å˜é‡ activeEffect åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šè¢«åµŒå¥—çš„ effect è¦†ç›–ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ª<strong>å‡½æ•°æ ˆ</strong>è§£å†³</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¿€æ´»çš„ effect å‡½æ•°</span>\n<span class="token keyword">let</span> activeEffect\n<span class="token comment">// effect æ ˆ</span>\n<span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token comment">// å½“è°ƒç”¨ effect æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°å¤åˆ¶ç»™ activeEffect</span>\n    activeEffect <span class="token operator">=</span> effectFn\n    <span class="token comment">// åœ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ä¹‹å‰å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å‹æ ˆ</span>\n    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment">// åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶è¿˜åŸ activeEffect ä¸ºä¹‹å‰çš„å€¼</span>\n    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// activeEffect.deps ç”¨æ¥å­˜å‚¨æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³çš„ä¾èµ–é›†åˆ</span>\n  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°</span>\n  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line">Â </div><br><br><br><br><br><br><br><div class="highlight-line">Â </div><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="é¿å…æ— é™é€’å½’å¾ªç¯" tabindex="-1"><a class="header-anchor" href="#é¿å…æ— é™é€’å½’å¾ªç¯" aria-hidden="true">#</a> é¿å…æ— é™é€’å½’å¾ªç¯</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>\nobj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>âœ… å½“å‰¯ä½œç”¨å‡½æ•°å†…<strong>åŒæ—¶</strong>å‘ç”Ÿäº†<strong>è¯»å’Œå†™</strong>ï¼Œä¼šå¯¼è‡´ get ä¸ set çš„æ­»å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸º trigger çš„æ‰§è¡Œå¢åŠ å®ˆå«æ¡ä»¶ï¼šå¦‚æœ trigger è§¦å‘æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸æ‰§è¡Œï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>\n  <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> effectsToRun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å®ˆå«æ¡ä»¶</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="è°ƒåº¦æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦æ‰§è¡Œ" aria-hidden="true">#</a> è°ƒåº¦æ‰§è¡Œ</h2><p>âœ… <strong>å¯è°ƒåº¦</strong>å°±æ˜¯æŒ‡å½“ trigger åŠ¨ä½œè§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶ï¼Œæœ‰èƒ½åŠ›å†³å®šå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œçš„<strong>æ—¶æœº</strong>ã€<strong>æ¬¡æ•°</strong>ä»¥åŠ<strong>æ–¹å¼</strong>ã€‚</p><details class="custom-container details"><summary>è°ƒåº¦å™¨çš„å®ç°</summary><p>åœ¨æ‰§è¡Œ effect å‡½æ•°çš„æ—¶å€™è·å¾—ä¸€äº›é¢å¤–çš„é…ç½®ä¿¡æ¯ï¼Œä¸º effectFn å¢åŠ ä¸€ä¸ªé¢å¤–çš„é…ç½®å³å¯ï¼š</p><ol><li>åœ¨ effect å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œçš„æ—¶å€™å¢åŠ é…ç½®å‚æ•°ï¼šoptions.scheduler</li><li>trigger æ‰§è¡Œæ—¶ï¼Œå¦‚æœæœ‰ scheduler åˆ™ä½¿ç”¨å®ƒè°ƒåº¦æ‰§è¡Œ</li></ol></details><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>\n<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n        <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal\n        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token keyword">return</span>\n    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        bucket<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">let</span> deps <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    deps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>\n    activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token keyword">return</span>\n    <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>\n\n    <span class="token keyword">const</span> effectsToRun <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    effects <span class="token operator">&amp;&amp;</span> effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            effectsToRun<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            effectFn<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token keyword">let</span> activeEffect\n<span class="token keyword">const</span> effectStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n<span class="token keyword">function</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n        activeEffect <span class="token operator">=</span> effectFn\n        effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>\n\n        <span class="token keyword">return</span> res\n    <span class="token punctuation">}</span>\n    effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options\n    effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">return</span> effectFn\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effectFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> deps <span class="token operator">=</span> effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>\n        deps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    effectFn<span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><h3 id="ç¼“å†²é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#ç¼“å†²é˜Ÿåˆ—" aria-hidden="true">#</a> ç¼“å†²é˜Ÿåˆ—</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> jobQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token keyword">let</span> isFlushing <span class="token operator">=</span> <span class="token boolean">false</span>\n<span class="token keyword">function</span> <span class="token function">flushJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFlushing<span class="token punctuation">)</span> <span class="token keyword">return</span>\n    isFlushing <span class="token operator">=</span> <span class="token boolean">true</span>\n    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token comment">// å°†ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ</span>\n        jobQueue<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">job</span> <span class="token operator">=&gt;</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        isFlushing <span class="token operator">=</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        jobQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>\n        <span class="token function">flushJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nobj<span class="token punctuation">.</span>foo<span class="token operator">++</span>\nobj<span class="token punctuation">.</span>foo<span class="token operator">++</span>  <span class="token comment">// 3</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><blockquote><p>ä»¥ä¸Šè°ƒåº¦å™¨å®ç°ï¼šå±æ€§ä¿®æ”¹ä¸¤æ¬¡ï¼Œä¸­é—´çš„ 2 è¿‡æ¸¡çŠ¶æ€å¯¹åº”çš„ä¾èµ–æ›´æ–°å¿½ç•¥ä¸æ‰§è¡Œ</p><p>ä¸¤ä¸ªå‰¯ä½œç”¨å‡½æ•°æ”¾åˆ°ç¼“å†²é˜Ÿåˆ—ä¸­ï¼Œä¸¤æ¬¡æ•°æ®æ›´æ–°åï¼Œåœ¨å¾®ä»»åŠ¡å½“ä¸­ä¸€æ¬¡æ‰§è¡Œ</p></blockquote><h2 id="è®¡ç®—å±æ€§-computed-ä¸-lazy" tabindex="-1"><a class="header-anchor" href="#è®¡ç®—å±æ€§-computed-ä¸-lazy" aria-hidden="true">#</a> è®¡ç®—å±æ€§ computed ä¸ lazy</h2><details class="custom-container details"><summary>è®¡ç®—å±æ€§çš„å®ç°ï¼š</summary><ol><li><strong>æ‡’è®¡ç®—</strong>ï¼šè®¡ç®—å±æ€§ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ‰æ‰§è¡Œã€‚æˆ‘ä»¬é€šè¿‡ä¸º option æ·»åŠ  lazy å±æ€§æ¥è¾¾åˆ°ç›®çš„ï¼›åŒæ—¶ï¼Œè®¡ç®—å±æ€§å®é™…ä¸Šå°±æ˜¯å‰¯ä½œç”¨å‡½æ•°ï¼ˆgetterï¼‰çš„æ‰§è¡Œç»“æœï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´å‰¯ä½œç”¨å‡½æ•°çš„æ³¨å†Œä»£ç ï¼Œè¿”å›çœŸæ­£å‰¯ä½œç”¨å‡½æ•°çš„ç»“æœã€‚</li><li><strong>å€¼ç¼“å­˜</strong>ï¼šè®¡ç®—å±æ€§åœ¨ getter å‡½æ•°æ‰€ä¾èµ–çš„å“åº”å¼æ•°æ®å˜åŒ–æ—¶æ‰éœ€è¦çœŸæ­£æ‰§è¡Œï¼Œè€Œä¸æ˜¯æ¯æ¬¡è·å– computed å±æ€§æ—¶éƒ½éœ€è¦æ‰§è¡Œä¸€æ¬¡å‰¯ä½œç”¨å‡½æ•°ã€‚ä¸ºè®¡ç®—å±æ€§æ·»åŠ  value å­—æ®µä¿å­˜æ‰§è¡Œç»“æœï¼ŒåŒæ—¶æ·»åŠ  dirty å±æ€§ï¼Œåœ¨ä¾èµ–çš„æ•°æ®å˜åŒ–æ—¶æ›´æ”¹ dirty ä¸º trueã€‚è¿™æ ·ï¼Œä¸‹æ¬¡è¯»å–è®¡ç®—å±æ€§çš„å€¼æ—¶ï¼Œæˆ‘ä»¬ä¼šé‡æ–°è®¡ç®—çœŸæ­£çš„å€¼ã€‚</li><li><strong>å“åº”å¼</strong>ï¼šè®¡ç®—å±æ€§ä¹Ÿè¦èƒ½å¤Ÿæ›´æ–°å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚åœ¨å…¶ value è¯»å–æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ track å‡½æ•°è¿›è¡Œè¿½è¸ªï¼Œæ”¶é›†ä¾èµ–ï¼›åœ¨è®¡ç®—å±æ€§ä¾èµ–çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ triggerå‡½æ•°è§¦å‘å“åº”ã€‚</li></ol></details><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token parameter">getter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> value\n  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span>\n\n  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>\n    lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n    <span class="token comment">// scheduler(effectFn)å†…éƒ¨è™½ç„¶èƒ½æ‹¿åˆ° getter å…³è”æ•°æ®çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä½†ä¸éœ€è¦ï¼Œå®ƒä»¬æœ‰è‡ªå·±çš„æ›´æ–°é€»è¾‘</span>\n    <span class="token comment">// è®¡ç®—å±æ€§åªéœ€è¦å…³æ³¨è‡ªå·±çš„effectFnè¿›è¡Œæ›´æ–°å³å¯ï¼Œå½“å…³è”æ•°æ®æ›´æ–°æ—¶ï¼Œdirty è®¾ä¸º trueï¼Œä¹Ÿå°±æ˜¯è¦é‡æ–°è®¡ç®—</span>\n    <span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        dirty <span class="token operator">=</span> <span class="token boolean">true</span>\n        <span class="token function">trigger</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  \n  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        value <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        dirty <span class="token operator">=</span> <span class="token boolean">false</span>\n      <span class="token punctuation">}</span>\n      <span class="token function">track</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> value\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> obj\n<span class="token punctuation">}</span>\n\n<span class="token keyword">const</span> sumRes <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo <span class="token operator">+</span> obj<span class="token punctuation">.</span>bar<span class="token punctuation">)</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sumRes<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sumRes<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n\nobj<span class="token punctuation">.</span>foo<span class="token operator">++</span>\n\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sumRes<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n\n<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sumRes<span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nobj<span class="token punctuation">.</span>foo<span class="token operator">++</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="watch-çš„å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#watch-çš„å®ç°åŸç†" aria-hidden="true">#</a> watch çš„å®ç°åŸç†</h2><details class="custom-container details"><summary>watch çš„å®ç°</summary><ol><li>watch å¯ä»¥è§‚æµ‹å“åº”å¼æ•°æ®æˆ–è€…ä¸€ä¸ª getter å‡½æ•°ï¼štraverseå‡½æ•°</li><li>å›è°ƒå‡½æ•°ä¸­è¦èƒ½å¤Ÿæ‹¿åˆ°æ–°å€¼ä¸æ—§å€¼</li><li>immediate å†³å®šæ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œå›è°ƒï¼Œæ­¤æ—¶æ—§å€¼æ—¶ undefined</li><li>flush å†³å®šå›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶æœºï¼šé€šè¿‡è°ƒåº¦å™¨å’Œå¼‚æ­¥çš„å¾®ä»»åŠ¡é˜Ÿåˆ—å®ç° post</li></ol><p>âœ… watch çš„å®ç°æœ¬è´¨ä¸Šåˆ©ç”¨äº†å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œæ—¶çš„<strong>å¯è°ƒåº¦æ€§</strong>ã€‚ä¸€ä¸ª watch æœ¬èº«ä¼šåˆ›å»ºä¸€ä¸ª effectï¼Œå½“è¿™ä¸ª effect ä¾èµ–çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥ effect çš„è°ƒåº¦å™¨å‡½æ•°ï¼Œå³ schedulerã€‚è¿™é‡Œçš„ scheduler å¯ä»¥ç†è§£ä¸ºâ€œå›è°ƒâ€ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨ scheduler ä¸­æ‰§è¡Œç”¨æˆ·é€šè¿‡ watch å‡½æ•°æ³¨å†Œçš„å›è°ƒå‡½æ•°å³å¯</p></details><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// è§‚æµ‹å‚æ•°å¤„ç†</span>\n<span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> seen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> value <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>\n  seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> k <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> value\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> getter\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    getter <span class="token operator">=</span> source\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">let</span> oldValue<span class="token punctuation">,</span> newValue\n\n  <span class="token comment">// æ‰§è¡Œå›è°ƒï¼Œä¼ é€’æ–°å€¼ä¸æ—§å€¼</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    newValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token function">cb</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>\n    oldValue <span class="token operator">=</span> newValue\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>\n    <span class="token comment">// æ‰§è¡Œ getter</span>\n    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span>\n      lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>flush <span class="token operator">===</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n          p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">)</span>\n  \n  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    oldValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n  immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  flush<span class="token operator">:</span> <span class="token string">&#39;post&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h2 id="è¿‡æœŸçš„å‰¯ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#è¿‡æœŸçš„å‰¯ä½œç”¨" aria-hidden="true">#</a> è¿‡æœŸçš„å‰¯ä½œç”¨</h2><p><strong>ç«æ€é—®é¢˜</strong>å¯¹åº”å‰ç«¯ä¹Ÿæœ‰å‘ç”Ÿçš„åœºæ™¯ï¼Œæ¯”å¦‚ watch è§‚æµ‹ å“åº”å¼æ•°æ®çš„å˜åŒ–ï¼šå›è°ƒå‡½æ•°ä¸­æ‰§è¡Œå¼‚æ­¥æ•°æ®è¯·æ±‚æ“ä½œï¼Œå¦‚æœå› ä¸ºç½‘ç»œé—®é¢˜æˆ–å…¶ä»–å¯¼è‡´å‰é¢çš„è¯·æ±‚æ¯”åé¢çš„æ™šåˆ°ï¼Œå°±ä¼šå‡ºç°æ•°æ®æ›´æ–°é”™ä¹±ã€‚</p><p>âœ… å½’æ ¹ç»“åº•ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè®©å‰¯ä½œç”¨å‡½æ•°è¿‡æœŸçš„æ‰‹æ®µï¼šwatch å†…éƒ¨æ¯æ¬¡æ£€æµ‹åˆ°å˜æ›´ä¹‹åï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œä¹‹å‰ï¼Œå…ˆè°ƒç”¨è‡ªå®šä¹‰çš„è¿‡æœŸå›è°ƒå³å¯</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> seen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> value <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>\n    seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> k <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">return</span> value\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> getter\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        getter <span class="token operator">=</span> source\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">let</span> oldValue<span class="token punctuation">,</span> newValue\n\n    <span class="token keyword">let</span> cleanup\n    <span class="token keyword">function</span> <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        cleanup <span class="token operator">=</span> fn\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        newValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanup<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n        <span class="token function">cb</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> onInvalidate<span class="token punctuation">)</span>\n        oldValue <span class="token operator">=</span> newValue\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>\n        <span class="token comment">// æ‰§è¡Œ getter</span>\n        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token punctuation">{</span>\n            lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n            <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>flush <span class="token operator">===</span> <span class="token string">&#39;post&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span>\n                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n                    <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">)</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        oldValue <span class="token operator">=</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>\n<span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    count<span class="token operator">++</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> count <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&#39;A&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;B&#39;</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> count <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">let</span> finallyData\n\n<span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">,</span> onInvalidate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">let</span> valid <span class="token operator">=</span> <span class="token boolean">true</span>\n    <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n        valid <span class="token operator">=</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> <span class="token keyword">return</span>\n\n    finallyData <span class="token operator">=</span> res\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>finallyData<span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\nobj<span class="token punctuation">.</span>foo<span class="token operator">++</span>\n<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    obj<span class="token punctuation">.</span>foo<span class="token operator">++</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><div class="highlight-line">Â </div><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div>',41),u={render:function(n,s){const a=(0,p.up)("OutboundLink");return(0,p.wg)(),(0,p.iD)(p.HY,null,[t,(0,p._)("p",null,[e,(0,p._)("a",c,[o,(0,p.Wm)(a)])]),l],64)}}}}]);