<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.24">
    <link rel="icon" href="/icon.png"><title>解析器 | Jerry Chen</title><meta name="description" content="在线文档">
    <link rel="preload" href="/assets/js/runtime~app.9d2802fa.js" as="script"><link rel="preload" href="/assets/css/styles.cb42ef83.css" as="style"><link rel="preload" href="/assets/js/1812.a46b8ab4.js" as="script"><link rel="preload" href="/assets/js/app.f0e1db92.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.cb42ef83.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">Jerry Chen</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Vue.js的设计与实现"><span class="title">Vue.js的设计与实现</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Vue.js的设计与实现"><span class="title">Vue.js的设计与实现</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>框架设计概览</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section1/chapter1" class="nav-link" aria-label="权衡的艺术"><!--[--><!--]--> 权衡的艺术 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section1/chapter2" class="nav-link" aria-label="框架设计的核心要素"><!--[--><!--]--> 框架设计的核心要素 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section1/chapter3" class="nav-link" aria-label="Vue.js3的设计思路"><!--[--><!--]--> Vue.js3的设计思路 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>响应系统</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section2/chapter4" class="nav-link" aria-label="响应系统的作用与实现"><!--[--><!--]--> 响应系统的作用与实现 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section2/chapter5" class="nav-link" aria-label="非原始值的响应式方案"><!--[--><!--]--> 非原始值的响应式方案 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section2/chapter6" class="nav-link" aria-label="原始值的响应式方案"><!--[--><!--]--> 原始值的响应式方案 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>渲染器</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter7" class="nav-link" aria-label="渲染器的设计"><!--[--><!--]--> 渲染器的设计 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter8" class="nav-link" aria-label="挂载与更新"><!--[--><!--]--> 挂载与更新 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter9" class="nav-link" aria-label="简单 Diff 算法"><!--[--><!--]--> 简单 Diff 算法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter10" class="nav-link" aria-label="双端 Diff 算法"><!--[--><!--]--> 双端 Diff 算法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter11" class="nav-link" aria-label="快速 Diff 算法"><!--[--><!--]--> 快速 Diff 算法 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>组件化</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section4/chapter12" class="nav-link" aria-label="组件的实现原理"><!--[--><!--]--> 组件的实现原理 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section4/chapter13" class="nav-link" aria-label="异步组件与函数式组件"><!--[--><!--]--> 异步组件与函数式组件 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section4/chapter14" class="nav-link" aria-label="内建组件和模块"><!--[--><!--]--> 内建组件和模块 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>编译器</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section5/chapter15" class="nav-link" aria-label="编译器核心技术概览"><!--[--><!--]--> 编译器核心技术概览 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section5/chapter16" class="nav-link router-link-active" aria-label="解析器"><!--[--><!--]--> 解析器 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section5/chapter17" class="nav-link" aria-label="编译优化"><!--[--><!--]--> 编译优化 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>服务端渲染</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section6/chapter18" class="nav-link" aria-label="同构渲染"><!--[--><!--]--> 同构渲染 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note/questions" class="nav-link" aria-label="前端面试"><!--[--><!--]--> 前端面试 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/daily" class="nav-link" aria-label="日常随记"><!--[--><!--]--> 日常随记 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/manual" class="nav-link" aria-label="实现常用方法"><!--[--><!--]--> 实现常用方法 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/algorithm" class="nav-link" aria-label="JavaScript数据结构与算法"><!--[--><!--]--> JavaScript数据结构与算法 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/designPatterns" class="nav-link" aria-label="JavaScript设计模式"><!--[--><!--]--> JavaScript设计模式 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/module" class="nav-link" aria-label="深入浅出模块化"><!--[--><!--]--> 深入浅出模块化 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/engineering" class="nav-link" aria-label="工程化相关"><!--[--><!--]--> 工程化相关 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/functional" class="nav-link" aria-label="函数式编程"><!--[--><!--]--> 函数式编程 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="JavaScript"><span class="title">JavaScript</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="JavaScript"><span class="title">JavaScript</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>语法基础</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/javascript/basic" class="nav-link" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/valueType" class="nav-link" aria-label="基本类型"><!--[--><!--]--> 基本类型 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/array" class="nav-link" aria-label="数组类型"><!--[--><!--]--> 数组类型 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/symbol" class="nav-link" aria-label="Symbol"><!--[--><!--]--> Symbol <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/set" class="nav-link" aria-label="Set"><!--[--><!--]--> Set <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/map" class="nav-link" aria-label="Map"><!--[--><!--]--> Map <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/function" class="nav-link" aria-label="函数进阶"><!--[--><!--]--> 函数进阶 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/closure" class="nav-link" aria-label="作用域与闭包"><!--[--><!--]--> 作用域与闭包 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/object" class="nav-link" aria-label="对象"><!--[--><!--]--> 对象 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/prototype" class="nav-link" aria-label="原型与继承"><!--[--><!--]--> 原型与继承 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/class" class="nav-link" aria-label="class"><!--[--><!--]--> class <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/module" class="nav-link" aria-label="模块设计"><!--[--><!--]--> 模块设计 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/regexp" class="nav-link" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/promise" class="nav-link" aria-label="Promise"><!--[--><!--]--> Promise <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/task" class="nav-link" aria-label="任务管理"><!--[--><!--]--> 任务管理 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/JPromise" class="nav-link" aria-label="Promise核心"><!--[--><!--]--> Promise核心 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/dom" class="nav-link" aria-label="DOM"><!--[--><!--]--> DOM <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/canvas" class="nav-link" aria-label="Canvas"><!--[--><!--]--> Canvas <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="HTML与CSS"><span class="title">HTML与CSS</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="HTML与CSS"><span class="title">HTML与CSS</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>HTML</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/html/structure" class="nav-link" aria-label="页面结构"><!--[--><!--]--> 页面结构 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/text" class="nav-link" aria-label="文本相关"><!--[--><!--]--> 文本相关 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/link-img" class="nav-link" aria-label="链接与图像"><!--[--><!--]--> 链接与图像 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/form-list" class="nav-link" aria-label="表单与列表"><!--[--><!--]--> 表单与列表 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/table-media" class="nav-link" aria-label="表格与媒体"><!--[--><!--]--> 表格与媒体 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>CSS</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/css/basic" class="nav-link" aria-label="基本知识"><!--[--><!--]--> 基本知识 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/selector" class="nav-link" aria-label="css选择器"><!--[--><!--]--> css选择器 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/priority" class="nav-link" aria-label="元素权重"><!--[--><!--]--> 元素权重 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/text" class="nav-link" aria-label="文本控制"><!--[--><!--]--> 文本控制 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/box-model" class="nav-link" aria-label="盒子模型"><!--[--><!--]--> 盒子模型 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/background" class="nav-link" aria-label="背景处理"><!--[--><!--]--> 背景处理 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/data" class="nav-link" aria-label="数据样式"><!--[--><!--]--> 数据样式 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/float" class="nav-link" aria-label="浮动布局"><!--[--><!--]--> 浮动布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/position" class="nav-link" aria-label="定位布局"><!--[--><!--]--> 定位布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/flex" class="nav-link" aria-label="弹性布局"><!--[--><!--]--> 弹性布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/grid" class="nav-link" aria-label="栅格布局"><!--[--><!--]--> 栅格布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/transform" class="nav-link" aria-label="变形动画"><!--[--><!--]--> 变形动画 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/transition" class="nav-link" aria-label="过渡延迟"><!--[--><!--]--> 过渡延迟 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/keyframes" class="nav-link" aria-label="帧动画"><!--[--><!--]--> 帧动画 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/media" class="nav-link" aria-label="媒体查询"><!--[--><!--]--> 媒体查询 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="TypeScript"><span class="title">TypeScript</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="TypeScript"><span class="title">TypeScript</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>语法基础</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/typescript/grammar/typeTool" class="nav-link" aria-label="类型工具"><!--[--><!--]--> 类型工具 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/note" class="nav-link" aria-label="日常笔记"><!--[--><!--]--> 日常笔记 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/basic" class="nav-link" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/advanced" class="nav-link" aria-label="语法进阶"><!--[--><!--]--> 语法进阶 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/final" class="nav-link" aria-label="高级语法"><!--[--><!--]--> 高级语法 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>爬虫实现</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/typescript/crawler/basic" class="nav-link" aria-label="爬虫工具"><!--[--><!--]--> 爬虫工具 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/crawler/express" class="nav-link" aria-label="Express"><!--[--><!--]--> Express <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/crawler/final" class="nav-link" aria-label="项目改良"><!--[--><!--]--> 项目改良 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Electron</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/framework/electron/basic" class="nav-link" aria-label="基础学习"><!--[--><!--]--> 基础学习 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Vue Js</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/framework/vue/compositionApi" class="nav-link" aria-label="Composition API"><!--[--><!--]--> Composition API <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/basic" class="nav-link" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/animation" class="nav-link" aria-label="动画"><!--[--><!--]--> 动画 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/advanced" class="nav-link" aria-label="高级语法"><!--[--><!--]--> 高级语法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/vue" class="nav-link" aria-label="日常笔记"><!--[--><!--]--> 日常笔记 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/book" class="nav-link" aria-label="VueJs深入浅出"><!--[--><!--]--> VueJs深入浅出 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>React Js</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/framework/react/basic" class="nav-link" aria-label="React基础"><!--[--><!--]--> React基础 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/react/redux" class="nav-link" aria-label="Redux"><!--[--><!--]--> Redux <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/react/note" class="nav-link" aria-label="笔记"><!--[--><!--]--> 笔记 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="NestJs"><span class="title">NestJs</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="NestJs"><span class="title">NestJs</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/nest/overview" class="nav-link" aria-label="NestJs"><!--[--><!--]--> NestJs <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/provider" class="nav-link" aria-label="Provider"><!--[--><!--]--> Provider <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/module" class="nav-link" aria-label="Module"><!--[--><!--]--> Module <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/prisma" class="nav-link" aria-label="prisma"><!--[--><!--]--> prisma <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/config" class="nav-link" aria-label="项目配置"><!--[--><!--]--> 项目配置 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="MYSQL"><span class="title">MYSQL</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="MYSQL"><span class="title">MYSQL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/mysql/basic" class="nav-link" aria-label="基本操作"><!--[--><!--]--> 基本操作 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/table" class="nav-link" aria-label="表操作"><!--[--><!--]--> 表操作 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/dataType" class="nav-link" aria-label="数据类型"><!--[--><!--]--> 数据类型 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/datetime" class="nav-link" aria-label="日期时间"><!--[--><!--]--> 日期时间 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/multiple" class="nav-link" aria-label="多表操作"><!--[--><!--]--> 多表操作 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/transaction" class="nav-link" aria-label="事务处理"><!--[--><!--]--> 事务处理 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/lock" class="nav-link" aria-label="锁机制"><!--[--><!--]--> 锁机制 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/foreignKey" class="nav-link" aria-label="外键关联"><!--[--><!--]--> 外键关联 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="工具 | 协议"><span class="title">工具 | 协议</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="工具 | 协议"><span class="title">工具 | 协议</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/tools/http" class="nav-link" aria-label="HTTP"><!--[--><!--]--> HTTP <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/tools/websocket" class="nav-link" aria-label="WebSocket"><!--[--><!--]--> WebSocket <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/tools/tmux" class="nav-link" aria-label="tmux"><!--[--><!--]--> tmux <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/tools/git" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Webpack4.0</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/tools/webpack/basic" class="nav-link" aria-label="基本概念"><!--[--><!--]--> 基本概念 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-2" class="nav-link" aria-label="起步介绍"><!--[--><!--]--> 起步介绍 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-3" class="nav-link" aria-label="打包配置"><!--[--><!--]--> 打包配置 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-4" class="nav-link" aria-label="进阶"><!--[--><!--]--> 进阶 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-5" class="nav-link" aria-label="配置案例"><!--[--><!--]--> 配置案例 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/caffreygo" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">在新窗口打开</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Vue.js的设计与实现"><span class="title">Vue.js的设计与实现</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Vue.js的设计与实现"><span class="title">Vue.js的设计与实现</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>框架设计概览</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section1/chapter1" class="nav-link" aria-label="权衡的艺术"><!--[--><!--]--> 权衡的艺术 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section1/chapter2" class="nav-link" aria-label="框架设计的核心要素"><!--[--><!--]--> 框架设计的核心要素 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section1/chapter3" class="nav-link" aria-label="Vue.js3的设计思路"><!--[--><!--]--> Vue.js3的设计思路 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>响应系统</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section2/chapter4" class="nav-link" aria-label="响应系统的作用与实现"><!--[--><!--]--> 响应系统的作用与实现 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section2/chapter5" class="nav-link" aria-label="非原始值的响应式方案"><!--[--><!--]--> 非原始值的响应式方案 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section2/chapter6" class="nav-link" aria-label="原始值的响应式方案"><!--[--><!--]--> 原始值的响应式方案 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>渲染器</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter7" class="nav-link" aria-label="渲染器的设计"><!--[--><!--]--> 渲染器的设计 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter8" class="nav-link" aria-label="挂载与更新"><!--[--><!--]--> 挂载与更新 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter9" class="nav-link" aria-label="简单 Diff 算法"><!--[--><!--]--> 简单 Diff 算法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter10" class="nav-link" aria-label="双端 Diff 算法"><!--[--><!--]--> 双端 Diff 算法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section3/chapter11" class="nav-link" aria-label="快速 Diff 算法"><!--[--><!--]--> 快速 Diff 算法 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>组件化</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section4/chapter12" class="nav-link" aria-label="组件的实现原理"><!--[--><!--]--> 组件的实现原理 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section4/chapter13" class="nav-link" aria-label="异步组件与函数式组件"><!--[--><!--]--> 异步组件与函数式组件 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section4/chapter14" class="nav-link" aria-label="内建组件和模块"><!--[--><!--]--> 内建组件和模块 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>编译器</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section5/chapter15" class="nav-link" aria-label="编译器核心技术概览"><!--[--><!--]--> 编译器核心技术概览 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section5/chapter16" class="nav-link router-link-active" aria-label="解析器"><!--[--><!--]--> 解析器 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/VueJs3/section5/chapter17" class="nav-link" aria-label="编译优化"><!--[--><!--]--> 编译优化 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>服务端渲染</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/VueJs3/section6/chapter18" class="nav-link" aria-label="同构渲染"><!--[--><!--]--> 同构渲染 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/note/questions" class="nav-link" aria-label="前端面试"><!--[--><!--]--> 前端面试 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/daily" class="nav-link" aria-label="日常随记"><!--[--><!--]--> 日常随记 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/manual" class="nav-link" aria-label="实现常用方法"><!--[--><!--]--> 实现常用方法 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/algorithm" class="nav-link" aria-label="JavaScript数据结构与算法"><!--[--><!--]--> JavaScript数据结构与算法 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/designPatterns" class="nav-link" aria-label="JavaScript设计模式"><!--[--><!--]--> JavaScript设计模式 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/module" class="nav-link" aria-label="深入浅出模块化"><!--[--><!--]--> 深入浅出模块化 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/engineering" class="nav-link" aria-label="工程化相关"><!--[--><!--]--> 工程化相关 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/note/functional" class="nav-link" aria-label="函数式编程"><!--[--><!--]--> 函数式编程 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="JavaScript"><span class="title">JavaScript</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="JavaScript"><span class="title">JavaScript</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>语法基础</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/javascript/basic" class="nav-link" aria-label="概述"><!--[--><!--]--> 概述 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/valueType" class="nav-link" aria-label="基本类型"><!--[--><!--]--> 基本类型 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/array" class="nav-link" aria-label="数组类型"><!--[--><!--]--> 数组类型 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/symbol" class="nav-link" aria-label="Symbol"><!--[--><!--]--> Symbol <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/set" class="nav-link" aria-label="Set"><!--[--><!--]--> Set <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/map" class="nav-link" aria-label="Map"><!--[--><!--]--> Map <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/function" class="nav-link" aria-label="函数进阶"><!--[--><!--]--> 函数进阶 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/closure" class="nav-link" aria-label="作用域与闭包"><!--[--><!--]--> 作用域与闭包 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/object" class="nav-link" aria-label="对象"><!--[--><!--]--> 对象 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/prototype" class="nav-link" aria-label="原型与继承"><!--[--><!--]--> 原型与继承 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/class" class="nav-link" aria-label="class"><!--[--><!--]--> class <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/module" class="nav-link" aria-label="模块设计"><!--[--><!--]--> 模块设计 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/regexp" class="nav-link" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/promise" class="nav-link" aria-label="Promise"><!--[--><!--]--> Promise <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/task" class="nav-link" aria-label="任务管理"><!--[--><!--]--> 任务管理 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/JPromise" class="nav-link" aria-label="Promise核心"><!--[--><!--]--> Promise核心 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/dom" class="nav-link" aria-label="DOM"><!--[--><!--]--> DOM <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/javascript/canvas" class="nav-link" aria-label="Canvas"><!--[--><!--]--> Canvas <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="HTML与CSS"><span class="title">HTML与CSS</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="HTML与CSS"><span class="title">HTML与CSS</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>HTML</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/html/structure" class="nav-link" aria-label="页面结构"><!--[--><!--]--> 页面结构 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/text" class="nav-link" aria-label="文本相关"><!--[--><!--]--> 文本相关 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/link-img" class="nav-link" aria-label="链接与图像"><!--[--><!--]--> 链接与图像 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/form-list" class="nav-link" aria-label="表单与列表"><!--[--><!--]--> 表单与列表 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/html/table-media" class="nav-link" aria-label="表格与媒体"><!--[--><!--]--> 表格与媒体 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>CSS</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/css/basic" class="nav-link" aria-label="基本知识"><!--[--><!--]--> 基本知识 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/selector" class="nav-link" aria-label="css选择器"><!--[--><!--]--> css选择器 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/priority" class="nav-link" aria-label="元素权重"><!--[--><!--]--> 元素权重 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/text" class="nav-link" aria-label="文本控制"><!--[--><!--]--> 文本控制 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/box-model" class="nav-link" aria-label="盒子模型"><!--[--><!--]--> 盒子模型 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/background" class="nav-link" aria-label="背景处理"><!--[--><!--]--> 背景处理 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/data" class="nav-link" aria-label="数据样式"><!--[--><!--]--> 数据样式 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/float" class="nav-link" aria-label="浮动布局"><!--[--><!--]--> 浮动布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/position" class="nav-link" aria-label="定位布局"><!--[--><!--]--> 定位布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/flex" class="nav-link" aria-label="弹性布局"><!--[--><!--]--> 弹性布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/grid" class="nav-link" aria-label="栅格布局"><!--[--><!--]--> 栅格布局 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/transform" class="nav-link" aria-label="变形动画"><!--[--><!--]--> 变形动画 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/transition" class="nav-link" aria-label="过渡延迟"><!--[--><!--]--> 过渡延迟 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/keyframes" class="nav-link" aria-label="帧动画"><!--[--><!--]--> 帧动画 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/css/media" class="nav-link" aria-label="媒体查询"><!--[--><!--]--> 媒体查询 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="TypeScript"><span class="title">TypeScript</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="TypeScript"><span class="title">TypeScript</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>语法基础</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/typescript/grammar/typeTool" class="nav-link" aria-label="类型工具"><!--[--><!--]--> 类型工具 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/note" class="nav-link" aria-label="日常笔记"><!--[--><!--]--> 日常笔记 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/basic" class="nav-link" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/advanced" class="nav-link" aria-label="语法进阶"><!--[--><!--]--> 语法进阶 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/grammar/final" class="nav-link" aria-label="高级语法"><!--[--><!--]--> 高级语法 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>爬虫实现</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/typescript/crawler/basic" class="nav-link" aria-label="爬虫工具"><!--[--><!--]--> 爬虫工具 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/crawler/express" class="nav-link" aria-label="Express"><!--[--><!--]--> Express <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/typescript/crawler/final" class="nav-link" aria-label="项目改良"><!--[--><!--]--> 项目改良 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Electron</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/framework/electron/basic" class="nav-link" aria-label="基础学习"><!--[--><!--]--> 基础学习 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Vue Js</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/framework/vue/compositionApi" class="nav-link" aria-label="Composition API"><!--[--><!--]--> Composition API <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/basic" class="nav-link" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/animation" class="nav-link" aria-label="动画"><!--[--><!--]--> 动画 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/advanced" class="nav-link" aria-label="高级语法"><!--[--><!--]--> 高级语法 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/vue" class="nav-link" aria-label="日常笔记"><!--[--><!--]--> 日常笔记 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/vue/book" class="nav-link" aria-label="VueJs深入浅出"><!--[--><!--]--> VueJs深入浅出 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>React Js</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/framework/react/basic" class="nav-link" aria-label="React基础"><!--[--><!--]--> React基础 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/react/redux" class="nav-link" aria-label="Redux"><!--[--><!--]--> Redux <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/framework/react/note" class="nav-link" aria-label="笔记"><!--[--><!--]--> 笔记 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="NestJs"><span class="title">NestJs</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="NestJs"><span class="title">NestJs</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/nest/overview" class="nav-link" aria-label="NestJs"><!--[--><!--]--> NestJs <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/provider" class="nav-link" aria-label="Provider"><!--[--><!--]--> Provider <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/module" class="nav-link" aria-label="Module"><!--[--><!--]--> Module <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/prisma" class="nav-link" aria-label="prisma"><!--[--><!--]--> prisma <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/nest/config" class="nav-link" aria-label="项目配置"><!--[--><!--]--> 项目配置 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="MYSQL"><span class="title">MYSQL</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="MYSQL"><span class="title">MYSQL</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/mysql/basic" class="nav-link" aria-label="基本操作"><!--[--><!--]--> 基本操作 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/table" class="nav-link" aria-label="表操作"><!--[--><!--]--> 表操作 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/dataType" class="nav-link" aria-label="数据类型"><!--[--><!--]--> 数据类型 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/datetime" class="nav-link" aria-label="日期时间"><!--[--><!--]--> 日期时间 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/multiple" class="nav-link" aria-label="多表操作"><!--[--><!--]--> 多表操作 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/transaction" class="nav-link" aria-label="事务处理"><!--[--><!--]--> 事务处理 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/lock" class="nav-link" aria-label="锁机制"><!--[--><!--]--> 锁机制 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/mysql/foreignKey" class="nav-link" aria-label="外键关联"><!--[--><!--]--> 外键关联 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="工具 | 协议"><span class="title">工具 | 协议</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="工具 | 协议"><span class="title">工具 | 协议</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/tools/http" class="nav-link" aria-label="HTTP"><!--[--><!--]--> HTTP <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/tools/websocket" class="nav-link" aria-label="WebSocket"><!--[--><!--]--> WebSocket <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/tools/tmux" class="nav-link" aria-label="tmux"><!--[--><!--]--> tmux <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/tools/git" class="nav-link" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="dropdown-item"><!--[--><h4 class="dropdown-subtitle"><span>Webpack4.0</span></h4><ul class="dropdown-subitem-wrapper"><!--[--><li class="dropdown-subitem"><a href="/tools/webpack/basic" class="nav-link" aria-label="基本概念"><!--[--><!--]--> 基本概念 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-2" class="nav-link" aria-label="起步介绍"><!--[--><!--]--> 起步介绍 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-3" class="nav-link" aria-label="打包配置"><!--[--><!--]--> 打包配置 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-4" class="nav-link" aria-label="进阶"><!--[--><!--]--> 进阶 <!--[--><!--]--></a></li><li class="dropdown-subitem"><a href="/tools/webpack/step-5" class="nav-link" aria-label="配置案例"><!--[--><!--]--> 配置案例 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/caffreygo" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">在新窗口打开</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">编译器</p><ul class=""><li><!--[--><a href="/VueJs3/section5/chapter15.html" class="nav-link sidebar-item" aria-label="编译器核心技术概览"><!--[--><!--]--> 编译器核心技术概览 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="解析器"><!--[--><!--]--> 解析器 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#文本模式及其对解析器的影响" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="文本模式及其对解析器的影响"><!--[--><!--]--> 文本模式及其对解析器的影响 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#递归下降算法构造模板-ast" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="递归下降算法构造模板 AST"><!--[--><!--]--> 递归下降算法构造模板 AST <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#子节点类型" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="子节点类型"><!--[--><!--]--> 子节点类型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#parsechildren" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="parseChildren"><!--[--><!--]--> parseChildren <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析过程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析过程"><!--[--><!--]--> 解析过程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#递归与下降" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="递归与下降"><!--[--><!--]--> 递归与下降 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#状态机的开启和停止" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="状态机的开启和停止"><!--[--><!--]--> 状态机的开启和停止 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#isend-v1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="isEnd.v1"><!--[--><!--]--> isEnd.v1 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#isend-v2" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="isEnd.v2"><!--[--><!--]--> isEnd.v2 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析标签节点" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析标签节点"><!--[--><!--]--> 解析标签节点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析属性" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析属性"><!--[--><!--]--> 解析属性 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析文本与解析-html-实体" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析文本与解析 HTML 实体"><!--[--><!--]--> 解析文本与解析 HTML 实体 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析文本" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析文本"><!--[--><!--]--> 解析文本 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解码命名字符的引用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解码命名字符的引用"><!--[--><!--]--> 解码命名字符的引用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解码数字字符" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解码数字字符"><!--[--><!--]--> 解码数字字符 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析插值与注释" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析插值与注释"><!--[--><!--]--> 解析插值与注释 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析插值" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析插值"><!--[--><!--]--> 解析插值 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/VueJs3/section5/chapter16.html#解析注释" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="解析注释"><!--[--><!--]--> 解析注释 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a href="/VueJs3/section5/chapter17.html" class="nav-link sidebar-item" aria-label="编译优化"><!--[--><!--]--> 编译优化 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="解析器" tabindex="-1"><a class="header-anchor" href="#解析器" aria-hidden="true">#</a> 解析器</h1><p>解析器（parser）负责把字符串模板转化成模板 AST，它的本质就是一个状态机。正则表达式的本质也是一个状态机。</p><h2 id="文本模式及其对解析器的影响" tabindex="-1"><a class="header-anchor" href="#文本模式及其对解析器的影响" aria-hidden="true">#</a> 文本模式及其对解析器的影响</h2><p>✅ 文本模式指的是解析器在工作时所进入的一些特殊状态，如 RCDATA 模式、CDATA 模式、RAWTEXT 模式，以及初始的 DATA 模式等。在不同模式下，解析器对文本的解析行为会有所不同。</p><div class="custom-container tip"><p class="custom-container-title">文本模式</p><p>当解析器遇到一些特殊标签时，会切换模式，从而影响其对文本的解析行为：</p><ul><li><code>&lt;title&gt;</code>标签、<code>&lt;textarea&gt;</code>标签，当解析器遇到这两个标签时，会切换到 RCDATA 模式；</li><li><code>&lt;title&gt; </code>、<code>&lt;xmp&gt;</code>、<code>&lt;iframe&gt;</code>、<code>&lt;noembed&gt;</code>、<code>&lt;noframes&gt;</code>、<code>&lt;noscript&gt;</code>等标签，当解析器遇到这些标签时，会切到 RAWTEXT 模式；</li><li>当解析器遇到<code>&lt;![CDATA[</code>字符串时，会进入 CDATA 模式。</li></ul></div><details class="custom-container details"><summary>文本解析模式</summary><p>🌐 <a href="https://whatwg-cn.github.io/html/multipage/parsing.html#tokenization" target="_blank" rel="noopener noreferrer">HTML parsing tokenization 文档 (opens new window)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">在新窗口打开</span><!--]--></span></a></p><table><thead><tr><th>模式</th><th>能否解析标签</th><th>是否支持 HTML 实体</th></tr></thead><tbody><tr><td>DATA</td><td>能</td><td>是</td></tr><tr><td>RCDATA</td><td>否</td><td>是</td></tr><tr><td>RAWTEXT</td><td>否</td><td>否</td></tr><tr><td>CDATA</td><td>否</td><td></td></tr></tbody></table><ul><li><p>在默认的 <strong>DATA 模式</strong>下，解析器在遇到<code>&lt;</code>时，会切换到标签开始状态（tag open state）。即在该模式下，解析器能够解析标签元素。当解析器遇到字符 <code>&amp;</code> 时，会切换到<strong>字符引用状态</strong>（character reference state），也称 HTML 字符实体状态。也就是说，在 DATA 模式下，解析器能够处理 HTML 字符实体。</p></li><li><p>在 <strong>RCDATA 模式</strong>时，解析器遇到<code>&lt;</code>标签不会再切换到标签开始状态，而会切换到 RCDATA less-then sign state。在该状态下，解析器遇到字符<code>\</code>会切换到 RCDATA 的结束标签状态，即 RCDATA end tag open state；否则会将当前字符<code>&lt;</code>作为普通字符处理，然后继续处理其他字符。</p><p>由此可知，在 RCDATA 状态下，解析器不能识别标签元素。这其实间接说明了在<code>&lt;textarea&gt;</code>内可以将字符<code>&lt;</code>作为普通文本，解析器不会认为字符<code>&lt;</code>是标签开始的标志。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- textarea 内部的标签将作为普通文本 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>abc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>hello
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- textarea 能解析 HTML 实体 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="©">&amp;copy;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p>在 RAWTEXT 模式下的工作方式与在 RCDATA 模式下类似。唯一不同的是，在 RAWTEXT 模式下，解析器将不再支持 HTML 实体。</p><p>对于 Vue.js 的模板 DSL 来说，模板中不允许出<code>&lt;script&gt;</code>标签，因此 Vue.js 模板解析器在遇到<code>&lt;script&gt;</code>标签时会进入 RAWTEXT 模式，这时它会把<code>&lt;script&gt;</code>标签内的内容全部作为普通文本处理。</p></li></ul><blockquote><p>不同的模式还会影响解析器对于终止解析的判断。WHATWG 中还定义了 PLAINTEXT 模式，该模式与 RAWTEXT 类似。不同的是，该模式一旦进入便不会再退出。Vue.js 的模板解析用不到该模式。</p></blockquote></details><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> TextMode <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">DATA</span><span class="token operator">:</span> <span class="token string">&#39;DATA&#39;</span><span class="token punctuation">,</span>
  <span class="token constant">RCDARA</span><span class="token operator">:</span> <span class="token string">&#39;RCDATA&#39;</span><span class="token punctuation">,</span>
  <span class="token constant">RAWDATA</span><span class="token operator">:</span> <span class="token string">&#39;RAWDATA&#39;</span><span class="token punctuation">,</span>
  <span class="token constant">CDATA</span><span class="token operator">:</span> <span class="token string">&#39;CDATA&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="递归下降算法构造模板-ast" tabindex="-1"><a class="header-anchor" href="#递归下降算法构造模板-ast" aria-hidden="true">#</a> 递归下降算法构造模板 AST</h2><h3 id="子节点类型" tabindex="-1"><a class="header-anchor" href="#子节点类型" aria-hidden="true">#</a> 子节点类型</h3><p>之前的模板 AST 的构建思路是先进行词法记号的分割，然后创建模板 AST。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 定义文本模式，作为一个状态表</span>
<span class="token keyword">const</span> TextModes <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">DATA</span><span class="token operator">:</span> <span class="token string">&#39;DATA&#39;</span><span class="token punctuation">,</span>
  <span class="token constant">RCDATA</span><span class="token operator">:</span> <span class="token string">&#39;RCDATA&#39;</span><span class="token punctuation">,</span>
  <span class="token constant">RAWTEXT</span><span class="token operator">:</span> <span class="token string">&#39;RAWTEXT&#39;</span><span class="token punctuation">,</span>
  <span class="token constant">CDATA</span><span class="token operator">:</span> <span class="token string">&#39;CDATA&#39;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解析器函数，接收模板作为参数，负责模板 AST 的创建</span>
<span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定义上下文对象</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// source 模板内容，用于解析过程消费</span>
    source<span class="token operator">:</span> str<span class="token punctuation">,</span>
    <span class="token comment">// 解析器当前的文本模式</span>
    mode<span class="token operator">:</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// parseChidren 函数解析，返回解析后得到的子节点</span>
  <span class="token comment">// context: 上下文对象</span>
  <span class="token comment">// Node[]: 父节点构成的节点栈，初始为空</span>
  <span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Root&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 使用 nodes 作为根节点的 children</span>
    children<span class="token operator">:</span> nodes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>✅ 创建 Token 与构造模板 AST 的过程可以同时进行，因为模板和模板 AST 具有同构的特性。</p><p><code>parseChidren</code>函数本质上也是一个状态机，该状态机有多少种状态取决于子节点的类型数量。</p><div class="custom-container tip"><p class="custom-container-title">在模板中，元素的子节点可以是一下几种：</p><ul><li>标签节点，例如<code>&lt;div&gt;</code></li><li>文本插值节点，例如<code></code></li><li>普通文本节点，例如：<code>text</code></li><li>注释节点，例如<code>&lt;!----&gt;</code></li><li>CDATA 节点，例如<code>&lt;![CDATA[ xxx ]]&gt;</code></li></ul><p>在标准的 HTML 中，节点的类型将会更多，例如 DOCTYPE 节点等。</p></div><h3 id="parsechildren" tabindex="-1"><a class="header-anchor" href="#parsechildren" aria-hidden="true">#</a> parseChildren</h3><p>下图为 parseChildren 函数在解析模板过程中的状态迁移过程。</p><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/parseChildren.png" alt=""></p><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">parseChildren</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">待解析的模板</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">parseElement</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// nodes 存储子节点，作为返回值</span>
  <span class="token keyword">let</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	<span class="token comment">// 从上下文对象取得当前状态，模式 mode 与模板内容 source</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> mode<span class="token punctuation">,</span> source <span class="token punctuation">}</span> <span class="token operator">=</span> context
	<span class="token comment">// 解析字符串，遇到父级节点的结束标签可停止解析</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> node
		<span class="token comment">// DATA 和 RCDATA 模式支持插值节点的解析</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 只有 DATA 模式才支持标签节点的解析</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&lt;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;!&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;!--&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注释</span>
            node <span class="token operator">=</span> <span class="token function">parseComment</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;![CDATA[&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// CDATA</span>
            node <span class="token operator">=</span> <span class="token function">parseCDATA</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 结束标签，这里要抛出错误</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 标签</span>
          node <span class="token operator">=</span> <span class="token function">parseElement</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;{{&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解析插值</span>
        node <span class="token operator">=</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
		<span class="token comment">// node 不存在，说明出于其他模式，非 DATA、RCDATA</span>
    <span class="token comment">// 这时一切内容都作为文本处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 将节点添加到数组中</span>
    nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> nodes
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><ul><li><code>parseChildren</code> 函数的返回值是子节点组成的数组，这里每次 while 循环都会解析一个或多个节点，这些节点会被添加到 node 数组中，并作为函数返回值。</li><li>只有 DATA 和 RCDATA 模式支持插值节点的解析；只有 DATA 模式才支持标签节点、注释节点和 CDATA 节点的解析。</li><li>解析器在遇到特定标签时，会切换模式。一旦解析器切换到 DATA模式和 RCDATA 模式之外的模式时，一切内容都会作为文本节点被解析。当然，即使在 DATA 模式和 RCDATA 模式下，如果无法匹配标签节点、注释节点、CDATA 节点、插值节点，那么也会作为文本节点解析。</li></ul><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
	&lt;p&gt;Text1&lt;/p&gt;
	&lt;p&gt;Text2&lt;/p&gt;
&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>解析模板时，不能忽略空白字符。这些空白字符包括：换行符（\n）、回车符（\t）、空格（&#39; &#39;）、制表符（\t）以及换页符（\f）。</p><p>如果我们用（+）代表换行符，用（-）代表空格字符，那么模板可以表示为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;+--&lt;p&gt;Text1&lt;/p&gt;+--&lt;p&gt;Text1&lt;/p&gt;+&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>解析器—开始处于 DATA 模式。开始执行解析后，解析器遇到的第一个字符为<code>＜</code>，并且第个字符能够匹配正则表达式 <code>/a-z/t</code>，所以解析器会进人标签节点状态，并调用 <code>parseElement</code>函数进行解析。</p><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 解析开始标签</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// 递归调用 parseChildren 解析子节点</span>
  element<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
  <span class="token comment">// 解析结束标签</span>
  <span class="token function">parseEndTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> element
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">parseElement 函数会做三件事：</p><ol><li>解析开始标签</li><li>解析子节点</li><li>解析结束标签</li></ol></div><!--]--></div><!--]--></div><h3 id="解析过程" tabindex="-1"><a class="header-anchor" href="#解析过程" aria-hidden="true">#</a> 解析过程</h3><details class="custom-container details"><summary>解析过程</summary><p>如果一个标签不是自闭合标签，则可以认为，一个完整的标签元素是由<strong>开始标签</strong>、<strong>子节点</strong>和<strong>结束标签</strong>这三部分构成的。因此，在 <code>parseElement</code> 函数内，我们分别调用三个解析函数来处理这三部分内容。以上述模板为例。</p><ul><li><code>parseTag</code> 解析开始标签。<code>parseTag</code> 函数用于解析开始标签，包括开始标签上的属性和指令。因此，在<code>parseTag</code> 解析函数执行完毕后，会消费字符串中的内容<code>&lt;div&gt;</code>，处理后的模板内容将变为：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+--&lt;p&gt;Text1&lt;/p&gt;+--&lt;p&gt;Text2&lt;/p&gt;+&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li><p>递归地调用 <code>parseChildren</code> 函数解析子 节点。<code>parseElement</code> 函数在解析开始标签时，会产生一个标签节点 element。在 <code>parseElement</code>函数执行完毕后，剩下的模板内容应该作为element 的子节点被解析，即 <code>element.children</code>。因此，我们要递归地调用 <code>parseChildren</code>函数。在这个过程中，<code>parsechildren</code>函数会消费字符串的内容：<code>+--&lt;p&gt;Text1&lt;/p&gt;+--&lt;p&gt;Text2&lt;/p&gt;+</code>。处理后的模板内容将变为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p><code>parseEndTag</code> 处理结束标签。可以看到，在经过 <code>parseChildren</code> 函数处理后，模板内容只剩下一个结束标签了。因此，只需要调用 <code>parseEndTag</code> 解析西数来消费它即可。</p></li></ul><p>经过上述三个步骤的处理后，这段模板就被解析完毕了，最终得到了模板 AST。但这里值得注意的是，为了解析标签的子节点，递归地调用了 <code>parseChildren</code> 函数。这意味着，一个新的状态机开始运行了，我们称其为“状态机 2”。“状态机 2”所处理的模板内容为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+--&lt;p&gt;Text1&lt;/p&gt;+--&lt;p&gt;Text2&lt;/p&gt;+</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>接下来，我们继续分析〝状态机 2” 的状态迁移流程。在“状态机 2〞开始运行时，模板的第一个字符是换行符(字符＋代表换行符)。因此，解析器会进入文本节点状态，并调用 <code>parseText</code>函数完成文本节点的解析。<code>parseText</code> 函数会将下一个<code>&lt;</code>字符之前的所有字符都视作文本节点的内容。换向话说，<code>parseText</code> 函数会消费模板内容<code>＋--</code>，并产生一个文本节点。在<code>parseText</code> 解析函数执行完毕后，剩下的模板内容为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;Text1&lt;/p&gt;+--&lt;p&gt;Text2&lt;/p&gt;+</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>接着，<code>parseChildren</code> 函数继续执行。此时模板的第一个字符为<code>&lt;</code>，并且下一个字符能够匹配正则 <code>/a-z/i</code>。于是解析器再次进人 <code>parseElement</code> 解析函数的执行阶段，这会消费模板内容<code>&lt;p&gt;Text1&lt;/p&gt;</code>。在这一步过后，剩下的模板内容为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+--&lt;p&gt;Text2&lt;/p&gt;+</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>可以看到，此时模板的第一个字符是换行符，于是调用 <code>parseText</code> 函数消费模板内容<code>+--</code>现在，模板中剩下的内容是：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;Text2&lt;/p&gt;+</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>解析器会再次调用 parseElement 丽数处理标签节点。在这之后，剩下的模板内容为：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">+</span><span class="token template-punctuation string">`</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>可以看到，现在模板内容只剩下一个换行符了。<code>parseChildren</code> 函数会继续执行并调用<code>parseText</code> 函数消费剩下的内容，并产生一个文本节点。最终，模板被解析完毕，“状态机2”停止运行。</p><p>在“状态机2”运行期间，为了处理标签节点，我们又调用了两次 <code>parseElement</code> 函数。第一次调用用于处理内容 <code>&lt;p&gt;Text1&lt;/p&gt;</code>，第二次调用用于处理内容 <code>&lt;p&gt;Text2&lt;/p&gt;</code>。我们知道<code>parseElement</code> 函数会递少地调用 <code>parsechildren</code> 函数完成子节点的解析，这就意味着解析器会再开启了两个新的状态机。</p></details><h3 id="递归与下降" tabindex="-1"><a class="header-anchor" href="#递归与下降" aria-hidden="true">#</a> 递归与下降</h3><p>✅ <code>parseChildren</code>解析函数是整个状态机的核心，状态迁移操作都在该函数内完成。在<code>parseChildren</code> 函数运行过程中，为了处理标签节点，会调用<code>parseElement</code> 解析函数，这会间接地调用 <code>parseChildren</code>函数，并产生一个新的状态机。</p><p><strong>递归</strong>：随着标签嵌套层次的增加，新的状态机会随着<code>parseChildren</code>函数递归地调用而不断创建，这就是“递归下降”中“递归”二字的含义。</p><p><strong>下降</strong>：而上级<code>parseChildren</code>函数的调用用于构造上级模板 AST，被递归调用的下级 <code>parseChildren</code> 函数则用于构造下级模板 AST 节点。最终，会构造出一棵树型结构的模板 AST，这就是“递归下降”中“下降”二字的含义。</p><h2 id="状态机的开启和停止" tabindex="-1"><a class="header-anchor" href="#状态机的开启和停止" aria-hidden="true">#</a> 状态机的开启和停止</h2><div class="custom-container tip"><p class="custom-container-title">✅ 概览</p><p>在解析模板 AST的过程中，parseChildren是核心。每次调用都意味着新状态机的开启。状态机的结束时机有两个：</p><ul><li>第一个停止时机是当模板内容被解析完毕时。</li><li>第二个停止时机是遇到结束标签时，这时解析器会取得父级节点栈栈顶的节点作为父节点，检查该节点结束标签是否与父节点的标签同名，如果相同，则状态机停止运行。</li></ul></div><p><code>parseChildren</code>函数本质上是一个状态机，它会开启一个 while 循环使得状态机自动运行。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> mode <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token comment">// 运行状态机</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略部分代码</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> nodes
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="isend-v1" tabindex="-1"><a class="header-anchor" href="#isend-v1" aria-hidden="true">#</a> isEnd.v1</h3><p>当解析器遇到开始标签时，会将该标签压入父级节点栈，同时开启新的状态机。当解析器遇到结束标签，井且父级节点栈中存在与该标签同名的开始标签节点时，会停止当前正在运行的状态机。根据上述规则，我们可以给出<code>isEnd</code>函数的逻辑，如下面的代码所示：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当解析内容解析完毕之后，停止</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> ancestors<span class="token punctuation">[</span>ancestors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token comment">// 遇到与父节点同名的结束标签时，停止</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parent<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这个判断方式是有瑕疵的，以下面这个模板为例：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol><li>目前代码“状态机1“会遇到 div 会开启一个“状态机2“</li><li>接着遇到 span 再开启一个“状态机3“</li><li>“状态机3“解析时遇到了<code>&lt;/div&gt;</code>这个结束标签，与当前 span 标签不符。则“状态机3“抛出错误：“无效的结束标签”</li></ol><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/parseTag1.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> mode <span class="token punctuation">}</span> <span class="token operator">=</span> context

  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEnd</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> node

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">||</span> mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">===</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span> <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&lt;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;!&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;!--&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 注释</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;![CDATA[&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// CDATA</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 结束标签，这里要抛出错误，因为它缺少对应的开始标签</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;无效的结束标签&#39;</span><span class="token punctuation">)</span>
          <span class="token keyword">continue</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;{{&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> nodes
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>当前解释方式是会得到错误信息：“无效的结束标签”。</p><h3 id="isend-v2" tabindex="-1"><a class="header-anchor" href="#isend-v2" aria-hidden="true">#</a> isEnd.v2</h3><p>✅ 还有一种解释方式，在“完整的内容”部分被解析完毕后，解析器就会打印错误信息：“<code>&lt;span&gt;</code>标签缺少闭合标签”。</p><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/parseTag2.png" alt=""></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">isEnd</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>

  <span class="token comment">// 与节点栈内全部的节点比较</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> ancestors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ancestors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li>”状态机1”遇到 div 会开启一个”状态机2”；</li><li>接着遇到 span 再开启一个”状态机3”；</li><li>”状态机3”这个状态机解析时遇到了<code>&lt;/div&gt;</code>这个结束标签，在节点栈中找到了存在名为 div 的标签节点。于是状态机3停止。</li></ol><p>在这个过程中，“状态机2”在调用<code>parseElement</code>函数时检测到<code>&lt;span&gt;</code>缺少闭合标签，打印“<code>&lt;span&gt;</code>缺少闭合标签”。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>isSelfClosing<span class="token punctuation">)</span> <span class="token keyword">return</span> element

  ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  element<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
  ancestors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&#39;end&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 标签缺少闭合标签</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> element
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="解析标签节点" tabindex="-1"><a class="header-anchor" href="#解析标签节点" aria-hidden="true">#</a> 解析标签节点</h2><p>在上面给出的<code>parseElement</code>函数的实现中，无论是解析开始标签还是闭合标签，都调用了<code>parseTag</code>函数。同时，使用<code>parseChildren</code>函数来解析开始标签与闭合标签中间的部分。</p><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/parseTag.png" alt=""></p><p><code>parseTag</code>函数通过第二个参数区分当前解析的是开始标签还是闭合标签。另外，无论是处理的是哪个标签，该函数都会消费对应的内容。</p><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">advanceBy &amp; advanceSpaces</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">parseTag</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">parseElement</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 上下文对象</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模板内容</span>
    source<span class="token operator">:</span> str<span class="token punctuation">,</span>
    mode<span class="token operator">:</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">,</span>
    <span class="token comment">// 消费指定数量的字符</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span>source <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 消费空白字符</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\t\r\n\f ]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> nodes <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Root&#39;</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> nodes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>正则测试：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\t\r\n\f ]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">   &lt;div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;   &#39;, index: 0, input: &#39;   &lt;div&gt;&#39;, groups: undefined]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&#39;start&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> advanceBy<span class="token punctuation">,</span> advanceSpaces <span class="token punctuation">}</span> <span class="token operator">=</span> context

  <span class="token keyword">const</span> match <span class="token operator">=</span> type <span class="token operator">===</span> <span class="token string">&#39;start&#39;</span>
  	<span class="token comment">// 匹配开始标签</span>
    <span class="token operator">?</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;([a-z][^\t\r\n\f /&gt;]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  	<span class="token comment">// 匹配结束标签</span>
    <span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;\/([a-z][^\t\r\n\f /&gt;]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  
  <span class="token comment">// 获取匹配的标签名称</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token comment">// 消费正则匹配的全部内容 &#39;&lt;div&#39;  &#39;&lt;/div&#39;</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token comment">// 消费标签中无用的空白字符</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
	<span class="token comment">// 消费完匹配内容，判断当标签是不是自闭合标签</span>
  <span class="token keyword">const</span> isSelfClosing <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&gt;&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 消费标签全部内容</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Element&#39;</span><span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>  <span class="token comment">// 标签名</span>
    props<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isSelfClosing  <span class="token comment">// 是不是自闭合标签</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>正则测试：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;([a-z][^\t\r\n\f /&gt;]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;hello&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;&lt;div&#39;, &#39;div&#39;, index: 0, input: &#39;&lt;div&gt;hello&lt;/div&gt;&#39;, groups: undefined]</span>

<span class="token operator">/</span><span class="token operator">^</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token operator">-</span>z<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">^</span>\t\r\n\f <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">/</span>i<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div  &gt;hello&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;&lt;div&#39;, &#39;div&#39;, index: 0, input: &#39;&lt;div  &gt;hello&lt;/div&gt;&#39;, groups: undefined]</span>

<span class="token operator">/</span><span class="token operator">^</span><span class="token operator">&lt;</span>\<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([a-z][^\t\r\n\f /&gt;]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;&lt;/p&#39;, &#39;p&#39;, index: 0, input: &#39;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&#39;, groups: undefined]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p><code>[^\t\r\n\f /&gt;]</code> 匹配非空白符，非字符 / 和字符 &gt;</p></blockquote><ul><li><code>parseTag</code>函数既用于解析开始标签，也用于解析结束标签</li><li>通过正则匹配当前标签是开始标签还是结束标签</li></ul><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> ancestors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>isSelfClosing<span class="token punctuation">)</span> <span class="token keyword">return</span> element

  ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  <span class="token comment">// 切换到正确的文本模式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;textarea&#39;</span> <span class="token operator">||</span> element<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>mode <span class="token operator">=</span> TextModes<span class="token punctuation">.</span><span class="token constant">RCDATA</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">style|xmp|iframe|noembed|noframes|noscript</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>mode <span class="token operator">=</span> TextModes<span class="token punctuation">.</span><span class="token constant">RAWTEXT</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>mode <span class="token operator">=</span> TextModes<span class="token punctuation">.</span><span class="token constant">DATA</span>
  <span class="token punctuation">}</span>
  element<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">parseChildren</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ancestors<span class="token punctuation">)</span>
  ancestors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
s
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&#39;end&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 标签缺少闭合标签</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> element
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>经过<code>parseTag</code>的处理之后，会返回一个标签节点。<code>parseElement</code>函数在得到由<code>parseTag</code>函数产生的标签节点后，需要根据节点的类型完成<strong>文本模式的切换</strong>。</p><!--]--></div><!--]--></div><h2 id="解析属性" tabindex="-1"><a class="header-anchor" href="#解析属性" aria-hidden="true">#</a> 解析属性</h2><p><code>parseTag</code>解析函数会消费整个开始标签，这意味着同时它还要能够处理开始标签存在的<strong>属性</strong>与<strong>指令</strong>。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-show</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>display<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">属性值的三种情况</p><ul><li>属性值被双引号包裹：<code>id=&quot;doo&quot;</code></li><li>属性值被单引号包裹：<code>id=&#39;doo&#39;</code></li><li>属性值没有引号包裹：<code>id=doo</code></li></ul></div><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">parseTag</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">parseAttributes</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">测试结果</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseTag</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&#39;start&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> advanceBy<span class="token punctuation">,</span> advanceSpaces <span class="token punctuation">}</span> <span class="token operator">=</span> context

  <span class="token keyword">const</span> match <span class="token operator">=</span> type <span class="token operator">===</span> <span class="token string">&#39;start&#39;</span>
    <span class="token operator">?</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;([a-z][^\t\r\n\f /&gt;]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;\/([a-z][^\t\r\n\f /&gt;]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
  
  <span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token comment">// 消费正则匹配的全部内容 &#39;&lt;div&#39;  &#39;&lt;/div&#39;</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token comment">// 消费标签中无用的空白字符</span>
  <span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 解析属性和指令</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
	<span class="token comment">// 消费完匹配内容，判断当标签是不是自闭合标签</span>
  <span class="token keyword">const</span> isSelfClosing <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&gt;&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 消费标签全部内容</span>
  <span class="token function">advanceBy</span><span class="token punctuation">(</span>isSelfClosing <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Element&#39;</span><span class="token punctuation">,</span>
    tag<span class="token punctuation">,</span>  <span class="token comment">// 标签名</span>
    props<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    isSelfClosing  <span class="token comment">// 是不是自闭合标签</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>我们需要在消费标签的“开始部分”和无用空白字符之后，再调用<code>parseAttributes</code>函数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> tag <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token function">advanceBy</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>  <span class="token comment">// id=&quot;foo&quot; v-show=&quot;display&quot; /&gt;</span>

<span class="token function">parseAttributes</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseAttributes</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> advanceBy<span class="token punctuation">,</span> advanceSpaces <span class="token punctuation">}</span> <span class="token operator">=</span> context
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// 循环不断消费模板内容，直至遇到标签的“结束部分”为止</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;&gt;&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&gt;&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 匹配属性名称</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token function">advanceBy</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>length<span class="token punctuation">)</span>  <span class="token comment">// 属性名</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 属性名与等于号之间的空白字符</span>
    <span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 等于号</span>
    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 等于号与属性值之间的空白符</span>

    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>  <span class="token comment">// 属性值</span>

    <span class="token keyword">const</span> quote <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> isQuoted <span class="token operator">=</span> quote <span class="token operator">===</span> <span class="token string">&#39;&quot;&#39;</span> <span class="token operator">||</span> quote <span class="token operator">===</span> <span class="token string">&quot;&#39;&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isQuoted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 属性值被引号包裹，消费引号</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> endQuoteIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>endQuoteIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取属性值并消费</span>
        value <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> endQuoteIndex<span class="token punctuation">)</span>
        <span class="token function">advanceBy</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 消费引号</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;缺少引号&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 属性值未被引号包裹</span>
      <span class="token comment">// 下一个空白字符之前的内容全部作为属性值</span>
      <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^\t\r\n\f &gt;]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
      value <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token function">advanceBy</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">advanceSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 消费属性值后面的空白字符</span>

    props<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;Attribute&#39;</span><span class="token punctuation">,</span>
      name<span class="token punctuation">,</span>
      value
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> props
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><code>parseAttributes</code>函数消费模板内容的过程，就是不断地解析属性名称、等于号、属性值的过程。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 属性名称匹配</span>
<span class="token operator">/</span><span class="token operator">^</span><span class="token punctuation">[</span><span class="token operator">^</span>\t\r\n\f <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">^</span>\t\r\n\f <span class="token operator">/</span><span class="token operator">&gt;=</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">id=&quot;123&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;id&#39;, index: 0, input: &#39;id=&quot;123&quot;&#39;, groups: undefined]</span>

<span class="token comment">// 没有引号包裹的属性值匹配1</span>
<span class="token operator">/</span><span class="token operator">^</span><span class="token punctuation">[</span><span class="token operator">^</span>\t\r\n\f <span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">val name=&#39;jhon&#39;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;val&#39;, index: 0, input: &quot;val name=&#39;jhon&#39;&quot;, groups: undefined]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//  &lt;div</span>
<span class="token comment">//    id=&quot;foo&quot;</span>
<span class="token comment">//    v-show=&quot;display&quot;</span>
<span class="token comment">//    @click=&quot;&quot;handler&quot;</span>
<span class="token comment">//    v-on:mousedown=&quot;onMouseDown&quot;&gt;</span>
<span class="token comment">//  &lt;/div&gt;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&#39;Root&#39;</span><span class="token punctuation">,</span>
  chidlren<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;Element&#39;</span><span class="token punctuation">,</span>
      tag<span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
      props<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Attribute&#39;</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;foo&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Attribute&#39;</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;v-show&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;display&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Attribute&#39;</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;@click&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;handler&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Attribute&#39;</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">&#39;v-on:mousedown&#39;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&#39;onMouseDown&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>我们可以灵活地解析出属性的类型，比如指令可以指定<code>type = Directive</code></p></blockquote><!--]--></div><!--]--></div><h2 id="解析文本与解析-html-实体" tabindex="-1"><a class="header-anchor" href="#解析文本与解析-html-实体" aria-hidden="true">#</a> 解析文本与解析 HTML 实体</h2><div class="custom-container tip"><p class="custom-container-title">✅ 概览</p><p>解析文本节点并不复杂，它的复杂点在于，我们需要对解析后的文本内容进行 HTML 实体的解码工作。WHATWG 规范中也定义了解码 HTML 实体过程中的状态迁移过程。HTML 实体类型有两种，分别是命名字符引用和数字字符引用。命名字符引用的解码方式可以总结为两种。</p><ul><li>当存在分号时：执行完整匹配。</li><li>当省略分号时：执行最短匹配。</li></ul><p>对于数字字符引用，则按照 WHATWG 规范中定义的规则逐步实现。</p></div><h3 id="解析文本" tabindex="-1"><a class="header-anchor" href="#解析文本" aria-hidden="true">#</a> 解析文本</h3><p>当解析下面这个模板时：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token string">&#39;&lt;div&gt;Text&lt;/div&gt;&#39;</span>
<span class="token comment">// parseTag &#39;&lt;div&gt;&#39;</span>
<span class="token keyword">const</span> templaye <span class="token operator">=</span> <span class="token string">&#39;Text&lt;/div&gt;&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>紧接着，解析器会调用<code>parseChildren</code>开启一个新的状态机来处理这段模板。状态机的迁移过程如下：</p><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/parseText.png" alt=""></p><p>解析器会在模板中寻找下一个<code>&lt;</code>字符或插值定界符的位置索引，记为索引 I 。然后，解析器会从模板头部到索引 I 的位置截取内容，这段截取出来的字符串将作为文本节点的内容。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token string">&#39;Text&lt;/div&gt;&#39;</span>  <span class="token comment">// Text  &lt;</span>
<span class="token keyword">const</span> template1 <span class="token operator">=</span> <span class="token string">&#39;Text-{{ val }}&lt;/div&gt;&#39;</span>  <span class="token comment">// Text-  {{</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">parseText</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">测试结果</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// endIndex 为文本内容的结尾索引，默认为整个模板剩余内容</span>
  <span class="token keyword">let</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length
  <span class="token keyword">const</span> ltIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> delimiterIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;{{&#39;</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 取 ItIndex 和当前 endIndex 中较小的一个作为新的结尾索引</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ltIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> ltIndex <span class="token operator">&lt;</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endIndex <span class="token operator">=</span> ltIndex
  <span class="token punctuation">}</span>
  <span class="token comment">// 取 delimiterIndex 和当前 endIndex 中较小的一个作为新的结尾索引</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>delimiterIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> delimiterIndex <span class="token operator">&lt;</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endIndex <span class="token operator">=</span> delimiterIndex
  <span class="token punctuation">}</span>
  <span class="token comment">// 截取文本内容</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span>
	<span class="token comment">// 消费文本</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Text&#39;</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token function">decodeHtml</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// const ast = parse(`&lt;div&gt;Text&lt;/div&gt;`)</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&#39;Root&#39;</span><span class="token punctuation">,</span>
  chidlren<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;Element&#39;</span><span class="token punctuation">,</span>
      tag<span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
      props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 文本节点</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Text&#39;</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">&#39;Text&#39;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><!--]--></div><!--]--></div><p>文本节点的解析并不复杂，复杂点在于，我们需要对解析后的文本进行 HTML 实体的解码工作。</p><h3 id="解码命名字符的引用" tabindex="-1"><a class="header-anchor" href="#解码命名字符的引用" aria-hidden="true">#</a> 解码命名字符的引用</h3><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/decodeHtml.png" alt=""></p><details class="custom-container details"><summary>HTML 实体</summary><p>HTML 实体是一段以字符&amp;开始的文本内容。实体用来描述 HTML 中的保留字符和一些难以通过普通键盘输人的字符，以及一些不可见的宇符。例如，在 HTML 中，字符＜具有特殊含义，如果希望以普通文本的方式来显示宇符＜，需要通过实体来表达：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>B<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>其中字符串 <code>&amp;1t；</code>就是一个 HTML 实体，用来表示字符＜。如果我们不用 HTML 实体，而是直接使用字符＜，那么将会产生非法的 HTML 内容：</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>A&lt;B<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>⚡️ 这会导致浏览器的解析结果不符合预期。</p><blockquote><p>HTML 实体总是以字符 &amp; 开头，以字符 ; 结尾。在web诞生的初期，HTML 实体的数量较少，因此允许省略其中的尾分号。但随着 HTML 宇符集越来越大，HTML 实体出现了包含的情况，例如 <code>&amp;lt</code> 和 <code>&amp;ltcc</code> 都是合法的实体，如果不加分号，测览器将无法区分它们。因此，WHATWG规范中明确规定，如果不为实体加分号，将会产生解析错误。但考虑到历史原因(互联网上存在大量省略分号的情況），现代浏览器都能够解析早期规范中定义的那些可以省略分号的 HTML 实体。</p></blockquote><div class="custom-container tip"><p class="custom-container-title">HTML 实体</p><ul><li><p>命名字符引用（named character reference），也叫命名实体（named entity）。顾名思义，这类实体具有特定的名称，例如<code>$lt;</code>。</p><p>🌐 <a href="https://html.spec.whatwg.org/multipage/named-characters.html#named-character-references" target="_blank" rel="noopener noreferrer">named character reference (opens new window)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">在新窗口打开</span><!--]--></span></a></p></li><li><p>数字字符引用（numeric character reference）。它们没有特定的名称，只能用数字表示。</p><p>与命名字符引用用不同，数字字符引用以宇符 <code>&amp;#</code> 开头，比命名字符引用的开头部分多出了字符 #，例如<code>&amp;#60;</code>。实际上，<code>&amp;#60;</code>对应的字符也是 &lt;，换句话说，<code>＆#60;</code>与<code>&amp;lt;</code>是等价的。数字字符引用既可以用十进制来表示，也可以使用十六进制来表示。例如，十进制数字 60 对应的十六进制值为 3C，因此实体 <code>&amp;#60;</code>也可以表示为 <code>&amp;#x3c;</code>。可以看到，当使用十六进制数表示实体时，需要以字符串<code>&amp;#x</code> 开头。</p></li></ul></div></details><div class="custom-container warning"><p class="custom-container-title">为什么 Vue.js 模板的解析器要对文本节点中的 HTML 实体进行解码？</p><p>在 Vue.js 模板中，文本节点所包含的 HTML 实体不会被浏览器解析。这是因为模板中的文本节点最终将通过如 <code>el.textcontent</code>等操作方法设置到页面，而通过<code>el.textContent</code>设置的文本内容是不会经过 HTML 实体解码的。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">&#39;&amp;lt;&#39;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>✅ 最终 el 的文本内容将会<strong>原封不动</strong>地呈现为字符串<code>&#39;&amp;lt;&#39;</code>，这意味着用户在 Vue.js 模板中写了 HTML 实体，而模板解析器渲染的内容不符合用户预期。所以我们需要在解析阶段对文本节点中存在的 HTML 实体进行解码。</p></div><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">namedCharacterReferences</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">decodeHtml</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">parseText</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> namedCharacterReferences <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;gt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;gt;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;lt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;lt;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;ltcc;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;⪦&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以上是一个部分命名字符引用表，相同的字符对应的实体会有多个，既有带分号的，也有不带分号的。而有一些则只有带分号的版本，因为这些实体不允许省略分号。</p><ul><li>当存在分号时：执行完整匹配</li><li>当省略分号时：执行最短匹配</li></ul><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">decodeHtml</span><span class="token punctuation">(</span><span class="token parameter">rawText<span class="token punctuation">,</span> asAttr <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> end <span class="token operator">=</span> rawText<span class="token punctuation">.</span>length
  <span class="token keyword">let</span> decodedText <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>  <span class="token comment">// 解码后的返回值</span>
  <span class="token keyword">let</span> maxCRNameLength <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    offset <span class="token operator">+=</span> length
    rawText <span class="token operator">=</span> rawText<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 消费字符串，直到处理完为止</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> head <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:#x?)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>rawText<span class="token punctuation">)</span>
    <span class="token comment">// 没有匹配到内容，说明没有需要解码的内容，直接消费</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> remaining <span class="token operator">=</span> end <span class="token operator">-</span> offset
      decodedText <span class="token operator">+=</span> rawText<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> remaining<span class="token punctuation">)</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 消费 &amp; 字符之前的普通文本</span>
    decodedText <span class="token operator">+=</span> rawText<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> head<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&amp;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 命名字符引用，否则为数字字符引用</span>
      <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
      <span class="token keyword">let</span> value
      <span class="token comment">// 字符 &amp; 的下一个字符必须是 ASCII 字母或数字，这才是合法的命名字符引用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[0-9a-z]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rawText<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据引用表计算实体名称的最大长度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>maxCRNameLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          maxCRNameLength <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>namedCharacterReferences<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token parameter">max<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>max<span class="token punctuation">,</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">0</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 从最大长度进行尝试截取匹配</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> length <span class="token operator">=</span> maxCRNameLength<span class="token punctuation">;</span> <span class="token operator">!</span>value <span class="token operator">&amp;&amp;</span> length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          name <span class="token operator">=</span> rawText<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
          value <span class="token operator">=</span> <span class="token punctuation">(</span>namedCharacterReferences<span class="token punctuation">)</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 找到对应项的值，匹配成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token comment">// 检查实体名称的最后一个字符是不是分号</span>
          <span class="token keyword">const</span> semi <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果解码的文本作为属性值，最后一个匹配字符不是分号</span>
          <span class="token comment">// 并且最后一个匹配字符的下一个字符是等于号（=）、ASCII 字母或数字</span>
          <span class="token comment">// 由于历史原因，将字符 &amp; 和实体名称 name 作为普通文本  href=&quot;foo.com?a=1&amp;lt=2&quot;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            asAttr <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span>semi <span class="token operator">&amp;&amp;</span>
            <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[=a-z0-9]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rawText<span class="token punctuation">[</span>name<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            decodedText <span class="token operator">+=</span> <span class="token string">&#39;&amp;&#39;</span> <span class="token operator">+</span> name
            <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 其他情况下，使用解码后的内容拼接到 decodedText 上</span>
            decodedText <span class="token operator">+=</span> value
            <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          decodedText <span class="token operator">+=</span> <span class="token string">&#39;&amp;&#39;</span> <span class="token operator">+</span> name
          <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> name<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果没找到对应字符，说明解码失败</span>
        decodedText <span class="token operator">+=</span> <span class="token string">&#39;&amp;&#39;</span>
        <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> decodedText
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>正则测试：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:#x?)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello &amp;lt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// [&#39;&amp;&#39;, index: 6, input: &#39;hello &amp;lt;&#39;, groups: undefined]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// endIndex 为文本内容的结尾索引，默认为整个模板剩余内容</span>
  <span class="token keyword">let</span> endIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span>length
  <span class="token keyword">const</span> ltIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> delimiterIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;{{&#39;</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 取 ItIndex 和当前 endIndex 中较小的一个作为新的结尾索引</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ltIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> ltIndex <span class="token operator">&lt;</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endIndex <span class="token operator">=</span> ltIndex
  <span class="token punctuation">}</span>
  <span class="token comment">// 取 delimiterIndex 和当前 endIndex 中较小的一个作为新的结尾索引</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>delimiterIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> delimiterIndex <span class="token operator">&lt;</span> endIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endIndex <span class="token operator">=</span> delimiterIndex
  <span class="token punctuation">}</span>
  <span class="token comment">// 截取文本内容</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span>
	<span class="token comment">// 消费文本</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Text&#39;</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token function">decodeHtml</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><!--]--></div><!--]--></div><h3 id="解码数字字符" tabindex="-1"><a class="header-anchor" href="#解码数字字符" aria-hidden="true">#</a> 解码数字字符</h3><p>上面代码使用一个正则表达式来匹配一个文本中字符引用的开始部分：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> head <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:#x?)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>rawText<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>我们可以根据正则匹配结果来判断字符引用的类型：</p><ul><li>如果<code>head[0] === &#39;&amp;&#39;</code>，则说明匹配的是命名字符引用。</li><li>如果<code>head[0] === &#39;&amp;#&#39;</code>，则说明匹配的是以十进制表示的数字字符引用。</li><li>如果<code>head[0] === &#39;&amp;#x&#39;</code>，则说明匹配的是以十六进制表示的数字字符引用。</li></ul><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">码点的提取</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">解码</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">decodeHtml</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 判断是十进制表示还是十六进制表示</span>
<span class="token keyword">const</span> hex <span class="token operator">=</span> head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&amp;#x&#39;</span>
<span class="token comment">// 根据不同进制表示法，选用不同的正则</span>
<span class="token keyword">const</span> pattern <span class="token operator">=</span> hex <span class="token operator">?</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&amp;#x([0-9a-f]+);?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span> <span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&amp;#([0-9]+);?</span><span class="token regex-delimiter">/</span></span>
<span class="token comment">// 最终，body[1] 的值就是 Unicode 码点</span>
<span class="token keyword">const</span> body <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>rawText<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>✅ 数字字符引用的格式是：前缀 + Unicode码点。解码数字字符引用的关键在于，如何提取字符引用中的 Unicode 码点。考虑到数字字符引用的前缀可以是以十进制表示（&amp;#），也可以是以十六进制表示（&amp;#x），所以我们使用下面的代码来完成码点的提取。</p><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将码点字符串转为十进制数字</span>
  <span class="token keyword">const</span> cp <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>body<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hex <span class="token operator">?</span> <span class="token number">16</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token comment">// 解码</span>
  <span class="token keyword">const</span> char <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>有了 Unicode 码点之后，只需要调用<code>String.fromCodePoint</code>函数即可将其解码为对应的字符。</p><p>🌐 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/fromCodePoint" target="_blank" rel="noopener noreferrer">String.fromCodePoint (opens new window)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">在新窗口打开</span><!--]--></span></a></p><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">decodeHtml</span><span class="token punctuation">(</span><span class="token parameter">rawText<span class="token punctuation">,</span> asAttr <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> end <span class="token operator">=</span> rawText<span class="token punctuation">.</span>length
  <span class="token keyword">let</span> decodedText <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
  <span class="token keyword">let</span> maxCRNameLength <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    offset <span class="token operator">+=</span> length
    rawText <span class="token operator">=</span> rawText<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> head <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:#x?)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>rawText<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> remaining <span class="token operator">=</span> end <span class="token operator">-</span> offset
      decodedText <span class="token operator">+=</span> rawText<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> remaining<span class="token punctuation">)</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>remaining<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Advance to the &quot;&amp;&quot;.</span>
    decodedText <span class="token operator">+=</span> rawText<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> head<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&amp;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Named character reference...</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hex <span class="token operator">=</span> head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;&amp;#x&#39;</span>
      <span class="token keyword">const</span> pattern <span class="token operator">=</span> hex <span class="token operator">?</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&amp;#x([0-9a-f]+);?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span> <span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&amp;#([0-9]+);?</span><span class="token regex-delimiter">/</span></span>
      <span class="token keyword">const</span> body <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>rawText<span class="token punctuation">)</span>
      
      <span class="token comment">// 如果匹配成功，则调用 String.fromCodePoint 函数进行解码</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将码点字符串转为十进制数字</span>
        <span class="token keyword">const</span> cp <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>body<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hex <span class="token operator">?</span> <span class="token number">16</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token comment">// 码点的合法性检查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cp <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果码点值为 0x00，替换为 0xfffd</span>
          cp <span class="token operator">=</span> <span class="token number">0xfffd</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cp <span class="token operator">&gt;</span> <span class="token number">0x10ffff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果码点值超过了 Unicode 的最大值，替换为 0xfffd</span>
          cp <span class="token operator">=</span> <span class="token number">0xfffd</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cp <span class="token operator">&gt;=</span> <span class="token number">0xd800</span> <span class="token operator">&amp;&amp;</span> cp <span class="token operator">&lt;=</span> <span class="token number">0xdfff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果码点值处于 surrogate pair 范围，替换为 0xfffd</span>
          cp <span class="token operator">=</span> <span class="token number">0xfffd</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cp <span class="token operator">&gt;=</span> <span class="token number">0xfdd0</span> <span class="token operator">&amp;&amp;</span> cp <span class="token operator">&lt;=</span> <span class="token number">0xfdef</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cp <span class="token operator">&amp;</span> <span class="token number">0xfffe</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0xfffe</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果码点值处于 `noncharacter` 范围，则什么都不做，交给平台处理</span>
          <span class="token comment">// noop</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token comment">// 控制字符集的范围是：[0x01, 0x1f] 加上 [0x7f, 0x9f]</span>
          <span class="token comment">// 却掉 ASICC 空白符：0x09(TAB)、0x0A(LF)、0x0C(FF)</span>
          <span class="token comment">// 0x0D(CR) 虽然也是 ASICC 空白符，但需要包含</span>
          <span class="token punctuation">(</span>cp <span class="token operator">&gt;=</span> <span class="token number">0x01</span> <span class="token operator">&amp;&amp;</span> cp <span class="token operator">&lt;=</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          cp <span class="token operator">===</span> <span class="token number">0x0b</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>cp <span class="token operator">&gt;=</span> <span class="token number">0x0d</span> <span class="token operator">&amp;&amp;</span> cp <span class="token operator">&lt;=</span> <span class="token number">0x1f</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span>cp <span class="token operator">&gt;=</span> <span class="token number">0x7f</span> <span class="token operator">&amp;&amp;</span> cp <span class="token operator">&lt;=</span> <span class="token number">0x9f</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 在 CCR_REPLACEMENTS 表中查找替换码点，如果找不到则使用原码点</span>
          cp <span class="token operator">=</span> <span class="token constant">CCR_REPLACEMENTS</span><span class="token punctuation">[</span>cp<span class="token punctuation">]</span> <span class="token operator">||</span> cp
        <span class="token punctuation">}</span>
        <span class="token comment">// 解码后追加到 decodedText 上</span>
        decodedText <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCodePoint</span><span class="token punctuation">(</span>cp<span class="token punctuation">)</span>
        <span class="token comment">// 消费掉整个数字字符引用的内容</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果没有匹配，则不进行解码操作，只是把 head[0] 追加到 decodedText 并消费掉</span>
        decodedText <span class="token operator">+=</span> head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>head<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> decodedText
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br></div><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>在真正进行解码前，需要对码点的值进行合法性检查。WHATWG 规范中对此也有明确的定义。</p><!--]--></div><!--]--></div><h2 id="解析插值与注释" tabindex="-1"><a class="header-anchor" href="#解析插值与注释" aria-hidden="true">#</a> 解析插值与注释</h2><h3 id="解析插值" tabindex="-1"><a class="header-anchor" href="#解析插值" aria-hidden="true">#</a> 解析插值</h3><p>文本插值是 Vue.js 模板中用来渲染动态数据的常用方法。</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ count }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ obj.foo }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ obj.fn() }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们通常将其两边的特殊字符串称为定界符，定界符中间的内容可以是任意合法的 JavaScript 表达式。</p><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/parseInterpolation.png" alt=""></p><p>解析器在解析插值时，只需要把定界符中间的内容提取出来作为 JavaScript 表达式即可：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseInterpolation</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 消费开始定界符</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token string">&#39;{{&#39;</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token comment">// 找到结束定界符的位置索引</span>
  closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;}}&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 截取中间内容作为插值表达式</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> closeIndex<span class="token punctuation">)</span>
  <span class="token comment">// 消费表达式和结束定界符</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token string">&#39;}}&#39;</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Interpolation&#39;</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;Expression&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// 表达式类型</span>
      content<span class="token operator">:</span> <span class="token function">decodeHtml</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>配合上面的 <code>parseInterpolation</code> 函数，解析如下模板内容：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;foo {{ bar }} baz&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>最终将得到如下 AST：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&#39;Root&#39;</span><span class="token punctuation">,</span>
  chidlren<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;Element&#39;</span><span class="token punctuation">,</span>
      tag<span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
      isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Text&#39;</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">&#39;foo &#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 插值节点</span>
        <span class="token punctuation">{</span> 
          type<span class="token operator">:</span> <span class="token string">&#39;Interpolation&#39;</span><span class="token punctuation">,</span>
          content<span class="token operator">:</span> <span class="token punctuation">[</span>
            type<span class="token operator">:</span> <span class="token string">&#39;Expression&#39;</span><span class="token punctuation">,</span>
            content<span class="token operator">:</span> <span class="token string">&#39; bar&#39;</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Text&#39;</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">&#39; baz&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="解析注释" tabindex="-1"><a class="header-anchor" href="#解析注释" aria-hidden="true">#</a> 解析注释</h3><p>解析注释的思路与解析插值非常相似：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseComment</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token string">&#39;&lt;!--&#39;</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  closeIndex <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;--&gt;&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> closeIndex<span class="token punctuation">)</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  context<span class="token punctuation">.</span><span class="token function">advanceBy</span><span class="token punctuation">(</span><span class="token string">&#39;--&gt;&#39;</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&#39;Comment&#39;</span><span class="token punctuation">,</span>
    content
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>配合上面的 <code>parseComment</code> 函数，解析如下模板内容：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;&lt;!-- comments --&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>最终得到如下 AST：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&#39;Root&#39;</span><span class="token punctuation">,</span>
  chidlren<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;Element&#39;</span><span class="token punctuation">,</span>
      tag<span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
      isSelfClosing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&#39;Comment&#39;</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">&#39; comments &#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><span class="meta-item-info">2022/6/22 22:51:56</span></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: caffreygo@163.com">Jerry Chen</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/VueJs3/section5/chapter15.html" class="nav-link" aria-label="编译器核心技术概览"><!--[--><!--]--> 编译器核心技术概览 <!--[--><!--]--></a></span><span class="next"><a href="/VueJs3/section5/chapter17.html" class="nav-link" aria-label="编译优化"><!--[--><!--]--> 编译优化 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.9d2802fa.js" defer></script><script src="/assets/js/1812.a46b8ab4.js" defer></script><script src="/assets/js/app.f0e1db92.js" defer></script>
  </body>
</html>
